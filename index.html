<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>11聊天器</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --bg: #f5f3f0;
  --card: #ffffff;
  --text: #2c2c2c;
  --text-sub: #999999;
  --text-hint: #bbbbbb;
  --border: #eee9e4;
  --accent: #7eb8b4;
  --accent-light: #e8f4f2;
  --accent-dark: #5a9e99;
  --bubble-me: #7eb8b4;
  --bubble-me-text: #ffffff;
  --bubble-other: #ffffff;
  --bubble-other-text: #2c2c2c;
  --input-bg: #ffffff;
  --shadow-sm: 0 1px 4px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 20px rgba(0,0,0,0.06);
  --radius-sm: 10px;
  --radius-md: 16px;
  --radius-lg: 22px;
}

body {
  font-family: 'Apple SD Gothic Neo', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
  background: var(--bg);
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  color: var(--text);
  font-size: 14px;
  line-height: 1.5;
}

/* ========== 状态栏 ========== */
.status-bar {
  width: 100%;
  height: 48px;
  padding: 0 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--card);
  position: relative;
  z-index: 100;
  padding-top: var(--safe-top);
}

.status-left {
  font-size: 14px;
  font-weight: 600;
  min-width: 50px;
  color: var(--text);
}

.status-center {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  top: 0;
  height: 48px;
  display: flex;
  align-items: center;
  padding-top: var(--safe-top);
}

.dynamic-island {
  width: 100px;
  height: 28px;
  background: #1a1a1a;
  border-radius: 16px;
  position: relative;
}

.dynamic-island::before {
  content: '';
  width: 10px;
  height: 10px;
  background: #0a0a0a;
  border-radius: 50%;
  position: absolute;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
}

.status-right {
  display: flex;
  align-items: center;
  gap: 5px;
  min-width: 70px;
  justify-content: flex-end;
}

.signal-bars {
  display: flex;
  align-items: flex-end;
  gap: 1.5px;
  height: 10px;
}

.signal-bars span {
  display: block;
  width: 2.5px;
  background: var(--text);
  border-radius: 1px;
}

.signal-bars span:nth-child(1) { height: 3px; }
.signal-bars span:nth-child(2) { height: 5px; }
.signal-bars span:nth-child(3) { height: 7px; }
.signal-bars span:nth-child(4) { height: 10px; }

.status-wifi {
  display: flex;
  align-items: center;
}

.status-battery-group {
  display: flex;
  align-items: center;
  gap: 3px;
}

.battery-percent {
  font-size: 11px;
  font-weight: 500;
  color: var(--text);
}

/* ========== 主页面 ========== */
.page-main {
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: var(--bg);
}

/* 导航栏 - 韩系简约 */
.nav-bar {
  width: 100%;
  padding: 10px 20px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--card);
  border-bottom: 1px solid var(--border);
}

.nav-title {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.3px;
  color: var(--text);
}

.nav-actions {
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-icon {
  width: 32px;
  height: 32px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-icon:active {
  background: var(--bg);
  transform: scale(0.95);
}

/* 聊天列表 */
.chat-list-area {
  width: 100%;
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 8px 14px;
}

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-hint);
  gap: 10px;
}

.empty-state svg { opacity: 0.25; }

.empty-state p {
  font-size: 13px;
  font-weight: 400;
}

/* 联系人卡片 - 韩系小巧 */
.contact-item {
  display: flex;
  align-items: center;
  padding: 12px 14px;
  gap: 12px;
  cursor: pointer;
  transition: all 0.15s;
  background: var(--card);
  border-radius: var(--radius-md);
  margin-bottom: 6px;
  box-shadow: var(--shadow-sm);
}

.contact-item:active {
  transform: scale(0.98);
  background: #faf8f6;
}

.contact-avatar-wrap {
  position: relative;
  flex-shrink: 0;
}

.contact-avatar {
  width: 46px;
  height: 46px;
  border-radius: 14px;
  object-fit: cover;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  font-size: 18px;
  font-weight: 600;
  color: var(--text-hint);
}

.contact-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.contact-online-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--accent);
  border: 2px solid var(--card);
  position: absolute;
  bottom: -1px;
  right: -1px;
}

.contact-info {
  flex: 1;
  min-width: 0;
}

.contact-name {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 2px;
  color: var(--text);
}

.contact-preview {
  font-size: 12px;
  color: var(--text-sub);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.contact-meta {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 4px;
  flex-shrink: 0;
}

.contact-time {
  font-size: 11px;
  color: var(--text-hint);
}

.contact-unread {
  min-width: 18px;
  height: 18px;
  border-radius: 9px;
  background: var(--accent);
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 5px;
}

/* ========== 弹窗 ========== */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.3);
  z-index: 200;
  display: none;
  align-items: flex-end;
  justify-content: center;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

.modal-overlay.active { display: flex; }

.modal-card {
  width: 100%;
  max-width: 480px;
  max-height: 90vh;
  background: var(--card);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.modal-header h2 {
  font-size: 16px;
  font-weight: 700;
}

.modal-close {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.modal-close:active { background: var(--border); }

.modal-body {
  padding: 18px 20px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 18px;
}

/* 头像上传 */
.avatar-upload {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.avatar-preview {
  width: 72px;
  height: 72px;
  border-radius: 20px;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  cursor: pointer;
  border: 1.5px dashed var(--text-hint);
  transition: border-color 0.2s;
}

.avatar-preview:active { border-color: var(--accent); }

.avatar-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.avatar-hint {
  font-size: 11px;
  color: var(--text-hint);
}

/* 表单 */
.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-sub);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.form-input {
  width: 100%;
  height: 42px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0 14px;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;background: var(--bg);
  color: var(--text);font-family: inherit;
}

.form-input:focus {
  border-color: var(--accent);
  background: var(--card);
}

.form-textarea {
  width: 100%;
  min-height: 80px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 14px;
  font-size: 13px;
  outline: none;
  transition: border-color 0.2s;
  background: var(--bg);
  color: var(--text);
  font-family: inherit;resize: vertical;
  line-height: 1.5;
}

.form-textarea:focus {
  border-color: var(--accent);
  background: var(--card);
}

/* 性别 */
.gender-selector {
  display: flex;
  gap: 8px;
}

.gender-option {
  flex: 1;
  height: 40px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-sub);
  background: var(--bg);
  transition: all 0.2s;
}

.gender-option.selected {
  border-color: var(--accent);
  background: var(--accent-light);
  color: var(--accent-dark);
}

.gender-option:active { transform: scale(0.97); }

/* API 配置按钮 */
.api-config-btn {
  width: 100%;
  height: 42px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 14px;
  cursor: pointer;
  background: var(--bg);
  transition: all 0.2s;font-family: inherit;
}

.api-config-btn:active { background: var(--border); }

.api-config-btn .label {
  font-size: 14px;
  color: var(--text);
}

.api-config-btn .value {
  font-size: 12px;
  color: var(--text-hint);
  display: flex;
  align-items: center;
  gap: 3px;
}

/* 保存按钮 */
.btn-save {
  width: 100%;
  height: 44px;
  border: none;
  border-radius: var(--radius-sm);
  background: var(--accent);
  color: #ffffff;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-family: inherit;
  flex-shrink: 0;
}

.btn-save:active {
  background: var(--accent-dark);
  transform: scale(0.98);
}

.btn-save:disabled {
  background: var(--text-hint);
  cursor: not-allowed;
}

/* ========== API 页面 ========== */
.api-page, .api-edit-page {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--card);
  z-index: 300;
  display: none;
  flex-direction: column;
}

.api-page.active, .api-edit-page.active { display: flex; }
.api-edit-page { z-index: 400; }

.api-page-header {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  gap: 10px;
  flex-shrink: 0;background: var(--card);
}

.btn-back {
  width: 32px;
  height: 32px;
  border: none;
  background: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border-radius: 50%;
}

.btn-back:active { background: var(--bg); }

.api-page-header h2 {
  font-size: 16px;
  font-weight: 700;
  flex: 1;
}

.api-page-body {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* 接口格式 */
.format-selector {
  display: flex;
  gap: 8px;
}

.format-option {
  flex: 1;
  height: 40px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-sub);
  background: var(--bg);
  transition: all 0.2s;
}

.format-option.selected {
  border-color: var(--accent);
  background: var(--accent-light);
  color: var(--accent-dark);
}

.format-option:active { transform: scale(0.97); }

/* 测试按钮 */
.btn-test {
  width: 100%;
  height: 42px;
  border: 1.5px solid var(--accent);
  border-radius: var(--radius-sm);
  background: var(--card);
  color: var(--accent);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-family: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.btn-test:active { background: var(--accent-light); }
.btn-test.testing { color: var(--text-sub); border-color: var(--border); }
.btn-test.success { color: #5cb85c; border-color: #5cb85c; }
.btn-test.fail { color: #e06060; border-color: #e06060; }

/* API 列表项 */
.api-saved-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.api-saved-item {
  display: flex;
  align-items: center;
  padding: 12px 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg);
  cursor: pointer;
  transition: all 0.2s;
  gap: 10px;
}

.api-saved-item.selected {
  border-color: var(--accent);
  background: var(--accent-light);
}

.api-saved-item:active { transform: scale(0.98); }

.api-item-radio {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid var(--text-hint);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.2s;
}

.api-saved-item.selected .api-item-radio {
  border-color: var(--accent);
  background: var(--accent);
}

.api-saved-item.selected .api-item-radio::after {
  content: '';
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: #fff;
}

.api-item-info { flex: 1; min-width: 0; }

.api-item-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 1px;
}

.api-item-detail {
  font-size: 11px;
  color: var(--text-sub);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.api-item-actions {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
}

.btn-api-action {
  width: 28px;
  height: 28px;
  border: none;
  border-radius: 8px;
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.btn-api-action:active { background: var(--border); }

.btn-new-api {
  width: 100%;
  height: 42px;
  border: 1.5px dashed var(--text-hint);
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-sub);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  font-family: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}

.btn-new-api:active {
  border-color: var(--accent);
  color: var(--accent);
  background: var(--accent-light);
}

.api-edit-body {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.api-edit-footer {
  padding: 14px 16px;
  padding-bottom: calc(14px + var(--safe-bottom));
  flex-shrink: 0;
}

.spinner {
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }
/* ========== 聊天室页面 ========== */
.page-chat {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 150;
  display: none;
  flex-direction: column;
}

.page-chat.active { display: flex; }

/* 聊天室顶部 - 角色状态栏 */
.chat-header {
  width: 100%;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
}

.chat-header-top {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  gap: 10px;
}

.chat-back-btn {
  width: 32px;
  height: 32px;
  border: none;
  background: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border-radius: 50%;
  flex-shrink: 0;
}

.chat-back-btn:active { background: var(--bg); }

.chat-header-avatar {
  width: 38px;
  height: 38px;
  border-radius: 12px;
  overflow: hidden;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;font-size: 16px;
  font-weight: 600;
  color: var(--text-hint);
}

.chat-header-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.chat-header-info {
  flex: 1;
  min-width: 0;
}

.chat-header-name {
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
  line-height: 1.2;
}

.chat-header-status {
  font-size: 11px;
  color: var(--accent);
  font-weight: 500;
}

.chat-header-actions {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
}

/* 自定义文案栏 */
.chat-custom-banner {
  padding: 0 14px 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.chat-custom-banner input {
  flex: 1;
  height: 28px;
  border: none;
  background: var(--bg);
  border-radius: 14px;
  padding: 0 12px;
  font-size: 11px;
  color: var(--text-sub);
  outline: none;
  font-family: inherit;
  text-align: center;
}

.chat-custom-banner input::placeholder {
  color: var(--text-hint);
}

/* 聊天消息区域 */
.chat-messages {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 16px 14px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* 日期分隔 */
.chat-date-divider {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px 0;
}

.chat-date-divider span {
  font-size: 11px;
  color: var(--text-hint);
  background: var(--bg);
  padding: 3px 12px;
  border-radius: 10px;
  font-weight: 500;
}
/* 加载更多历史消息 */
.load-more-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px 0;
  margin-bottom: 8px;
}

.load-more-btn button {
  height: 32px;
  padding: 0 20px;
  border: 1px solid var(--border);
  border-radius: 16px;
  background: var(--card);
  color: var(--text-sub);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s;display: flex;
  align-items: center;
  gap: 5px;
}

.load-more-btn button:active {
  background: var(--bg);
  transform: scale(0.96);
}

/* 消息行 */
.msg-row {
  display: flex;
  gap: 8px;
  max-width: 85%;
  align-items: flex-end;
}

.msg-row.me {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.msg-row.other {
  align-self: flex-start;
}

.msg-avatar {
  width: 34px;
  height: 34px;
  border-radius: 10px;
  overflow: hidden;
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-hint);
  align-self: flex-start;margin-top: 2px;
}

.msg-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.msg-content {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.msg-row.me .msg-content {
  align-items: flex-end;
}

.msg-row.other .msg-content {
  align-items: flex-start;
}

.msg-sender {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-sub);
  padding: 0 4px;
}

.msg-bubble {
  padding: 10px 14px;
  font-size: 14px;
  line-height: 1.55;
  word-break: break-word;
  white-space: pre-wrap;
  position: relative;
}

.msg-row.other .msg-bubble {
  background: var(--bubble-other);
  color: var(--bubble-other-text);
  border-radius: 4px 18px 18px 18px;
  box-shadow: var(--shadow-sm);
}

.msg-row.me .msg-bubble {
  background: var(--bubble-me);
  color: var(--bubble-me-text);
  border-radius: 18px 4px 18px 18px;
}

.msg-time {
  font-size: 10px;
  color: var(--text-hint);
  padding: 0 4px;
}

/* 打字指示器 */
.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 10px 14px;
  background: var(--bubble-other);
  border-radius: 4px 18px 18px 18px;
  box-shadow: var(--shadow-sm);
  align-items: center;
}

.typing-indicator span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-hint);
  animation: typingDot 1.4s ease-in-out infinite;
}

.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingDot {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-4px); opacity: 1; }
}

/* 聊天输入栏 */
.chat-input-bar {
  width: 100%;
  background: var(--card);
  border-top: 1px solid var(--border);
  padding: 10px 14px;
  padding-bottom: calc(10px + var(--safe-bottom));
  display: flex;
  align-items: flex-end;
  gap: 8px;
  flex-shrink: 0;
}

.chat-input-wrap {
  flex: 1;
  background: var(--bg);
  border-radius: 20px;
  border: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  align-items: flex-end;
  transition: border-color 0.2s;max-height: 120px;
}

.chat-input-wrap:focus-within {
  border-color: var(--accent);
}

.chat-input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 14px;
  color: var(--text);
  outline: none;
  font-family: inherit;
  resize: none;
  line-height: 1.5;max-height: 100px;
  overflow-y: auto;
  min-height: 21px;
}

.chat-input::placeholder {
  color: var(--text-hint);
}

.chat-send-btn {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: none;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
}

.chat-send-btn:active {
  background: var(--accent-dark);
  transform: scale(0.92);
}

.chat-send-btn:disabled {
  background: var(--border);
  cursor: not-allowed;
}
/* 重新回复按钮 */
.regenerate-btn {
  display: none;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 6px 14px;
  border: 1px solid var(--accent);
  border-radius: 16px;
  background: var(--accent-light);
  color: var(--accent-dark);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  margin: 8px auto;
  transition: all 0.2s;
}

.regenerate-btn:active {
  transform: scale(0.95);
  background: var(--accent);
  color: #fff;
}

.regenerate-btn.show {
  display: flex;
}
/* 接收消息按钮 */
.receive-msg-btn {
  display: none;
  align-items: center;
  justify-content: center;
  gap: 5px;
  padding: 8px 18px;
  border: none;
  border-radius: 18px;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  margin: 10px auto;
  box-shadow: 0 2px 8px rgba(126,184,180,0.4);
  transition: all 0.2s;
}

.receive-msg-btn:active {
  transform: scale(0.95);
  box-shadow: 0 1px 4px rgba(126,184,180,0.3);
}

.receive-msg-btn.show {
  display: flex;
}

.receive-msg-btn.loading {
  opacity: 0.7;
  cursor: not-allowed;
}

.chat-send-btn svg {
  margin-left: 1px;
}

/* ========== 底部导航栏 ========== */
.tab-bar {
  width: 100%;
  min-height: 56px;
  background: var(--card);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-around;
  flex-shrink: 0;
  padding-bottom: calc(var(--safe-bottom) + 20px);
  padding-top: 8px;
}


.tab-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  cursor: pointer;
  padding: 6px 20px;
  border-radius: 12px;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}

.tab-item:active {
  transform: scale(0.93);
}

.tab-item .tab-icon {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.tab-item .tab-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--text-hint);
  transition: color 0.2s;
}

.tab-item.active .tab-label {
  color: var(--accent);
}

/* ========== "我的"页面 ========== */
.page-me {
  width: 100%;
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 20px 14px;
  display: none;
  flex-direction: column;
  gap: 16px;
}

.page-me.active {
  display: flex;
}
/* ========== 发现页面 ========== */
.page-discover {
  width: 100%;
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 14px;
  display: none;
  flex-direction: column;
  gap: 10px;
  background: var(--bg);
}

.page-discover.active {
  display: flex;
}

.discover-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.discover-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px;
  background: var(--card);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-sm);
  cursor: pointer;
  transition: all 0.2s;
}

.discover-item:active {
  transform: scale(0.98);
  opacity: 0.8;
}

.discover-item-icon {
  width: 48px;
  height: 48px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.discover-item-info {
  flex: 1;
  min-width: 0;
}

.discover-item-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 2px;
}

.discover-item-desc {
  font-size: 12px;
  color: var(--text-sub);
}

.discover-item-arrow {
  flex-shrink: 0;
}
/* ========== 论坛页面 ========== */
.forum-page {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 500;
  display: none;
  flex-direction: column;
}

.forum-page.active {
  display: flex;
}

.forum-header {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  gap: 12px;
  flex-shrink: 0;
}

.forum-header h2 {
  flex: 1;
  font-size: 17px;
  font-weight: 700;
}

.forum-body {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* 论坛卡片 */
.forum-card {
  background: var(--card);
  border-radius: var(--radius-md);
  padding: 16px;
  box-shadow: var(--shadow-sm);
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.forum-card:active {
  transform: scale(0.98);
}

.forum-card-banner {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: linear-gradient(135deg, var(--accent-light) 0%, #e8f0f8 100%);
  opacity: 0.6;
}

.forum-card-content {
  position: relative;
  z-index: 1;
}

.forum-card-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.forum-card-title .forum-icon {
  font-size: 18px;
}

.forum-card-desc {
  font-size: 12px;
  color: var(--text-sub);
  line-height: 1.5;
  margin-bottom: 10px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.forum-card-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 11px;
  color: var(--text-hint);
}

.forum-card-meta span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.forum-card-members {
  display: flex;
  align-items: center;
  margin-top: 10px;
}

.forum-card-members .member-avatar {
  width: 26px;
  height: 26px;
  border-radius: 8px;
  background: var(--bg);
  border: 2px solid var(--card);
  margin-left: -8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 600;
  color: var(--text-hint);
  overflow: hidden;
}

.forum-card-members .member-avatar:first-child {
  margin-left: 0;
}

.forum-card-members .member-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.forum-card-members .member-more {
  margin-left: 6px;
  font-size: 11px;
  color: var(--text-sub);
}

/* 创建论坛按钮 */
.btn-create-forum {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px;
  border: 2px dashed var(--accent);
  border-radius: var(--radius-md);
  background: var(--accent-light);
  color: var(--accent-dark);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-create-forum:active {
  transform: scale(0.98);
  background: var(--accent);
  color: #fff;
}

/* 空状态 */
.forum-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  color: var(--text-hint);
  gap: 12px;
}

.forum-empty svg {
  opacity: 0.3;
}

.forum-empty p {
  font-size: 13px;
  text-align: center;
}

/* ========== 创建/编辑论坛弹窗 ========== */
.forum-edit-page {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 550;
  display: none;
  flex-direction: column;
}

.forum-edit-page.active {
  display: flex;
}

.forum-edit-body {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.forum-edit-footer {
  padding: 14px 16px;
  padding-bottom: calc(14px + var(--safe-bottom));
  background: var(--card);
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
}

.forum-edit-footer .btn-save {
  flex: 1;
}

.forum-edit-footer .btn-delete-forum {
  width: 50px;
  height: 44px;
  border: 1px solid #e06060;
  border-radius: var(--radius-sm);
  background: #fef0f0;
  color: #e06060;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.forum-edit-footer .btn-delete-forum:active {
  background: #e06060;
  color: #fff;
}

/* 成员选择 */
.member-selector {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.member-selector-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-sub);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.member-selector-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.member-chip {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border: 1.5px solid var(--border);
  border-radius: 20px;
  background: var(--bg);
  cursor: pointer;
  transition: all 0.2s;
}

.member-chip.selected {
  border-color: var(--accent);
  background: var(--accent-light);
}

.member-chip:active {
  transform: scale(0.95);
}

.member-chip-avatar {
  width: 28px;
  height: 28px;
  border-radius: 9px;
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-hint);
}

.member-chip-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.member-chip-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--text);
}

.member-chip.selected .member-chip-name {
  color: var(--accent-dark);
}

/* ========== 论坛详情页 ========== */
.forum-detail-page {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 520;
  display: none;
  flex-direction: column;
}

.forum-detail-page.active {
  display: flex;
}

.forum-detail-header {
  background: var(--card);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.forum-detail-header-top {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  gap: 12px;
}

.forum-detail-header-top h2 {
  flex: 1;
  font-size: 17px;
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.forum-detail-banner {
  padding: 0 16px 14px;
}

.forum-detail-banner .forum-worldview {
  font-size: 12px;
  color: var(--text-sub);
  line-height: 1.6;
  padding: 10px 14px;
  background: var(--bg);
  border-radius: var(--radius-sm);
  border-left: 3px solid var(--accent);
}

.forum-detail-body {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

/* 帖子卡片 */
.post-card {
  background: var(--card);
  border-radius: var(--radius-md);
  padding: 14px 16px;
  box-shadow: var(--shadow-sm);
}

.post-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.post-avatar {
  width: 38px;
  height: 38px;
  border-radius: 12px;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-hint);
  flex-shrink: 0;
}

.post-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.post-author-info {
  flex: 1;
  min-width: 0;
}

.post-author-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 6px;
}

.post-author-name .author-tag {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  background: var(--accent-light);
  color: var(--accent-dark);
  font-weight: 600;
}

.post-author-name .author-tag.netizen {
  background: #f0f0f0;
  color: #888;
}

.post-time {
  font-size: 11px;
  color: var(--text-hint);
}

.post-content {
  font-size: 14px;
  color: var(--text);
  line-height: 1.65;
  margin-bottom: 12px;
  word-break: break-word;
  white-space: pre-wrap;
}

.post-content .post-title {
  font-weight: 700;
  font-size: 15px;
  margin-bottom: 8px;
  color: var(--text);
}

.post-actions {
  display: flex;
  align-items: center;
  gap: 16px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
}

.post-action-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  color: var(--text-sub);
  cursor: pointer;
  padding: 4px 0;
  transition: color 0.15s;
}

.post-action-btn:active {
  color: var(--accent);
}

.post-action-btn.liked {
  color: #e06080;
}

/* 帖子评论区 */
.post-comments {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.post-comment {
  display: flex;
  gap: 8px;
  padding: 8px 10px;
  background: var(--bg);
  border-radius: 8px;
}

.post-comment-avatar {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  font-size: 10px;
  font-weight: 600;
  color: var(--text-hint);
  flex-shrink: 0;
}

.post-comment-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.post-comment-body {
  flex: 1;
  min-width: 0;
}

.post-comment-author {
  font-size: 12px;
  font-weight: 600;
  color: var(--accent-dark);
  margin-bottom: 2px;
}

.post-comment-author .reply-to {
  font-weight: 400;
  color: var(--text-sub);
}

.post-comment-text {
  font-size: 13px;
  color: var(--text);
  line-height: 1.5;
  word-break: break-word;
}

.post-comment-time {
  font-size: 10px;
  color: var(--text-hint);
  margin-top: 3px;
}

/* 评论输入 */
.post-comment-input {
  display: none;
  gap: 8px;
  margin-top: 8px;
  padding: 8px 10px;
  background: var(--bg);
  border-radius: 8px;
}

.post-comment-input.show {
  display: flex;
}

.post-comment-input input {
  flex: 1;
  height: 34px;
  border: 1px solid var(--border);
  border-radius: 17px;
  padding: 0 14px;
  font-size: 13px;
  background: var(--card);
  color: var(--text);
  outline: none;
  font-family: inherit;
}

.post-comment-input input:focus {
  border-color: var(--accent);
}

.post-comment-input button {
  height: 34px;
  padding: 0 14px;
  border: none;
  border-radius: 17px;
  background: var(--accent);
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
}

.post-comment-input button:active {
  background: var(--accent-dark);
}

/* 刷新按钮 */
.forum-refresh-bar {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px;
}

.btn-refresh-forum {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 20px;
  border: 1.5px solid var(--accent);
  border-radius: 20px;
  background: var(--accent-light);
  color: var(--accent-dark);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s;
}

.btn-refresh-forum:active {
  background: var(--accent);
  color: #fff;
  transform: scale(0.95);
}

.btn-refresh-forum.loading {
  opacity: 0.6;
  pointer-events: none;
}

/* 加载状态 */
.forum-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px;
  gap: 12px;
  color: var(--text-sub);
  font-size: 13px;
}
/* ========== 消息弹窗通知 ========== */
.notification-container {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px 14px;
  padding-top: calc(10px + var(--safe-top));
  pointer-events: none;
  gap: 8px;
}

.notification-toast {
  width: 100%;
  max-width: 380px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 16px;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0, 0, 0, 0.05);
  padding: 12px 14px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
  pointer-events: auto;
  cursor: pointer;
  transform: translateY(-120%);
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.notification-toast.show {
  transform: translateY(0);
  opacity: 1;
}

.notification-toast.hiding {
  transform: translateY(-120%);
  opacity: 0;
  transition: all 0.3s ease-in;
}

.notification-toast:active {
  transform: scale(0.98);
}

.notification-avatar {
  width: 42px;
  height: 42px;
  border-radius: 12px;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-hint);
  flex-shrink: 0;
  position: relative;
}

.notification-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.notification-avatar .notif-icon {
  position: absolute;
  bottom: -2px;
  right: -2px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  border: 2px solid #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
}

.notification-avatar .notif-icon.moments {
  background: linear-gradient(135deg, #ff6b6b, #ffa502);
}

.notification-avatar .notif-icon.forum {
  background: linear-gradient(135deg, #7eb8b4, #5a9e99);
}

.notification-body {
  flex: 1;
  min-width: 0;
  padding-top: 2px;
}

.notification-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 3px;
}

.notification-app {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-sub);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.notification-time {
  font-size: 11px;
  color: var(--text-hint);
}

.notification-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.notification-text {
  font-size: 13px;
  color: var(--text-sub);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.notification-close {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: none;
  background: rgba(0, 0, 0, 0.05);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  opacity: 0;
  transition: opacity 0.2s;
}

.notification-toast:hover .notification-close {
  opacity: 1;
}

.notification-close:hover {
  background: rgba(0, 0, 0, 0.1);
}

/* 不同类型的通知样式 */
.notification-toast.type-message {
  border-left: 3px solid var(--accent);
}

.notification-toast.type-moments {
  border-left: 3px solid #ff6b6b;
}

.notification-toast.type-forum {
  border-left: 3px solid #7eb8b4;
}

/* 通知进度条动画 */
.notification-progress {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 3px;
  background: var(--accent);
  border-radius: 0 0 0 16px;
  animation: notifProgress 4s linear forwards;
}

.notification-toast.type-moments .notification-progress {
  background: linear-gradient(90deg, #ff6b6b, #ffa502);
}

.notification-toast.type-forum .notification-progress {
  background: linear-gradient(90deg, #7eb8b4, #5a9e99);
}

@keyframes notifProgress {
  from { width: 100%; }
  to { width: 0%; }
}

/* 通知出现时的光效 */
.notification-toast::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
  opacity: 0;
  animation: notifShine 0.6s ease-out 0.2s forwards;
}

@keyframes notifShine {
  0% { opacity: 0; transform: translateX(-100%); }
  50% { opacity: 1; }
  100% { opacity: 0; transform: translateX(100%); }
}

/* 头像弹跳动画 */
.notification-toast.show .notification-avatar {
  animation: avatarBounce 0.5s ease-out 0.1s;
}

@keyframes avatarBounce {
  0% { transform: scale(0.5); }
  50% { transform: scale(1.1); }
  70% { transform: scale(0.95); }
  100% { transform: scale(1); }
}

/* 振动效果（可选） */
@keyframes notifVibrate {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
  20%, 40%, 60%, 80% { transform: translateX(2px); }
}

.notification-toast.vibrate {
  animation: notifVibrate 0.3s ease-in-out;
}

.me-profile-card {
  background: var(--card);
  border-radius: var(--radius-md);
  padding: 24px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  box-shadow: var(--shadow-sm);
}

.me-avatar-wrap {
  position: relative;
  cursor: pointer;
}

.me-avatar {
  width: 80px;
  height: 80px;
  border-radius: 22px;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  font-size: 28px;
  font-weight: 700;
  color: var(--text-hint);
}

.me-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.me-avatar-badge {
  position: absolute;
  bottom: -2px;
  right: -2px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--accent);
  border: 2px solid var(--card);
  display: flex;
  align-items: center;
  justify-content: center;
}

.me-name {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}

.me-desc {
  font-size: 12px;
  color: var(--text-sub);
  text-align: center;
  line-height: 1.5;
}

.me-edit-section {
  background: var(--card);
  border-radius: var(--radius-md);
  padding: 18px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  box-shadow: var(--shadow-sm);
}

.me-edit-section .section-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-sub);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.me-edit-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}

.me-edit-row:last-child {
  border-bottom: none;
}

.me-edit-row .row-label {
  font-size: 14px;
  color: var(--text);
  font-weight: 500;
}

.me-edit-row .row-value {
  font-size: 13px;
  color: var(--text-sub);
  display: flex;
  align-items: center;
  gap: 4px;
  max-width: 60%;
  text-align: right;
}

.me-edit-row .row-value span {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* 编辑我的信息弹窗 */
.me-edit-modal .modal-card {
  max-height: 85vh;
}

/* ========== 聊天室内编辑角色弹窗 ========== */
.chat-edit-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.3);
  z-index: 700;
  display: none;align-items: flex-end;
  justify-content: center;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

.chat-edit-overlay.active {
  display: flex;
}

/* 隐藏聊天列表区域的高度调整 */
.chat-list-area {
  padding-bottom: 8px;
}

/* ========== 聊天设置页面 ========== */
.chat-settings-page {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 600;
  display: none;
  flex-direction: column;
}

.chat-settings-page.active {
  display: flex;
}

.chat-settings-header {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  gap: 10px;
  flex-shrink: 0;background: var(--card);
}

.chat-settings-header h2 {
  font-size: 16px;
  font-weight: 700;
  flex: 1;
}

.chat-settings-body {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* 设置卡片 */
.settings-card {
  background: var(--card);
  border-radius: var(--radius-md);
  padding: 16px;
  box-shadow: var(--shadow-sm);
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.settings-card-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-sub);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.settings-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 40px;
}

.settings-row .s-label {
  font-size: 14px;
  color: var(--text);
  font-weight: 500;
  flex-shrink: 0;
}

.settings-row .s-value {
  font-size: 13px;
  color: var(--text-sub);
  display: flex;
  align-items: center;
  gap: 6px;
}

/* 开关 */
.toggle-switch {
  width: 44px;
  height: 26px;
  border-radius: 13px;
  background: var(--border);
  position: relative;
  cursor: pointer;
  transition: background 0.25s;
  flex-shrink: 0;
}

.toggle-switch.on {
  background: var(--accent);
}

.toggle-switch::after {
  content: '';
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: #fff;
  position: absolute;
  top: 2px;
  left: 2px;
  transition: transform 0.25s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

.toggle-switch.on::after {
  transform: translateX(18px);
}

/* 数字输入 */
.num-stepper {
  display: flex;
  align-items: center;
  gap: 8px;
}

.num-stepper button {
  width: 30px;
  height: 30px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg);
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
}

.num-stepper button:active {
  background: var(--border);
  transform: scale(0.92);
}

.num-stepper .num-val {
  font-size: 15px;
  font-weight: 600;
  color: var(--accent-dark);
  min-width: 36px;
  text-align: center;
}

/* 设置按钮行 */
.settings-btn-row {
  display: flex;
  align-items: center;
  padding: 12px 0;
  cursor: pointer;
  gap: 10px;
  transition: opacity 0.15s;
}

.settings-btn-row:active {
  opacity: 0.6;
}

.settings-btn-row .s-btn-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.settings-btn-row .s-btn-label {
  font-size: 14px;
  font-weight: 500;
  flex: 1;
}

.settings-btn-row .s-btn-arrow {
  color: var(--text-hint);
}

/* 搜索栏 */
.search-bar-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--card);
  border-radius: var(--radius-md);
  padding: 10px 14px;
  box-shadow: var(--shadow-sm);
}

.search-bar-wrap input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 14px;
  color: var(--text);
  outline: none;
  font-family: inherit;
}

.search-bar-wrap input::placeholder {
  color: var(--text-hint);
}

/* 备注输入 */
.remark-input-wrap {
  display: flex;
  gap: 8px;
}

.remark-input-wrap input {
  flex: 1;
  height: 40px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0 12px;
  font-size: 14px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  font-family: inherit;
}

.remark-input-wrap input:focus {
  border-color: var(--accent);
}

.remark-input-wrap button {
  height: 40px;
  padding: 0 14px;
  border: none;
  border-radius: var(--radius-sm);
  background: var(--accent);
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  white-space: nowrap;
}

.remark-input-wrap button:active {
  background: var(--accent-dark);
}

/* ========== 批量删除页面 ========== */
.batch-delete-page {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 700;
  display: none;
  flex-direction: column;
}

.batch-delete-page.active {
  display: flex;
}

.batch-delete-header {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  gap: 10px;
  flex-shrink: 0;
  background: var(--card);
}

.batch-delete-header h2 {
  font-size: 16px;
  font-weight: 700;
  flex: 1;
}

.btn-delete-confirm {
  height: 32px;
  padding: 0 14px;
  border: none;
  border-radius: 8px;
  background: #e06060;
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
}

.btn-delete-confirm:active {
  background: #c44;
}

.btn-delete-confirm:disabled {
  background: var(--text-hint);
  cursor: not-allowed;
}

.batch-delete-body {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 10px 14px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.batch-msg-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: background 0.15s;
}

.batch-msg-item:active {
  background: var(--border);
}

.batch-msg-item.selected {
  background: #fde8e8;
}

.batch-checkbox {
  width: 22px;
  height: 22px;
  border-radius: 6px;
  border: 2px solid var(--text-hint);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;margin-top: 2px;
  transition: all 0.2s;
}

.batch-msg-item.selected .batch-checkbox {
  border-color: #e06060;
  background: #e06060;
}

.batch-msg-body {
  flex: 1;
  min-width: 0;
}

.batch-msg-role {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-sub);
  margin-bottom: 2px;
}

.batch-msg-text {
  font-size: 13px;
  color: var(--text);
  line-height: 1.4;
  word-break: break-word;
}

.batch-msg-time {
  font-size: 10px;
  color: var(--text-hint);
  margin-top: 3px;
}

.batch-select-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 14px;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.batch-select-bar span {
  font-size: 13px;
  color: var(--text-sub);
}

.batch-select-bar button {
  height: 30px;
  padding: 0 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--card);
  font-size: 12px;
  font-weight: 500;
  color: var(--text);
  cursor: pointer;
  font-family: inherit;
}

.batch-select-bar button:active {
  background: var(--bg);
}

/* ========== 搜索结果页面 ========== */
.search-page {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 700;
  display: none;
  flex-direction: column;
}

.search-page.active {
  display: flex;
}

.search-page-header {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  gap: 10px;
  flex-shrink: 0;
  background: var(--card);border-bottom: 1px solid var(--border);
}

.search-page-header input {
  flex: 1;
  height: 38px;
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 0 16px;
  font-size: 14px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  font-family: inherit;
}

.search-page-header input:focus {
  border-color: var(--accent);
}

.search-cancel-btn {
  border: none;
  background: none;
  font-size: 14px;
  color: var(--accent);
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  white-space: nowrap;
}

.search-results {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 10px 14px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.search-result-item {
  padding: 12px 14px;
  background: var(--card);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-sm);
}

.search-result-role {
  font-size: 11px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 4px;
}

.search-result-text {
  font-size: 13px;
  color: var(--text);
  line-height: 1.4;
  word-break: break-word;
}

.search-result-text mark {
  background: #fff3a8;
  color: var(--text);
  border-radius: 2px;
  padding: 0 1px;
}

.search-result-time {
  font-size: 10px;
  color: var(--text-hint);
  margin-top: 4px;
}

.search-empty {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--text-hint);
  font-size: 13px;
}

/* ========== 聊天背景预览 ========== */
.bg-preview-wrap {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.bg-preview-current {
  width: 100%;
  height: 80px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg);
  margin-bottom: 8px;
}

.bg-preview-current img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.bg-preview-current .no-bg {
  font-size: 12px;
  color: var(--text-hint);
}

.bg-btn-group {
  display: flex;
  gap: 8px;
  width: 100%;
}

.bg-btn-group button {
  flex: 1;
  height: 38px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  transition: all 0.2s;
}

.bg-btn-group button:active {
  transform: scale(0.96);
}

.bg-btn-upload {
  border: 1px solid var(--accent);
  background: var(--accent-light);
  color: var(--accent-dark);
}

.bg-btn-clear {
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text-sub);
}

.bg-btn-clear:active {
  background: var(--bg) !important;
}

/* ========== 聊天内 API 选择页 ========== */
.chat-api-page {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 700;
  display: none;
  flex-direction: column;
}

.chat-api-page.active {
  display: flex;
}

.chat-api-body {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chat-api-current {
  background: var(--card);
  border-radius: var(--radius-md);
  padding: 14px 16px;
  box-shadow: var(--shadow-sm);
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.chat-api-current .current-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-sub);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.chat-api-current .current-value {
  font-size: 15px;
  font-weight: 600;
  color: var(--accent-dark);
}

.chat-api-current .current-detail {
  font-size: 12px;
  color: var(--text-sub);
}
/* ========== 聊天布局大小 ========== */
.size-selector {
  display: flex;
  gap: 6px;
  width: 100%;
}

.size-option {
  flex: 1;
  height: 56px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  cursor: pointer;
  background: var(--bg);
  transition: all 0.2s;
}

.size-option.selected {
  border-color: var(--accent);
  background: var(--accent-light);
}

.size-option:active {
  transform: scale(0.95);
}

.size-option .size-preview {
  font-weight: 700;
  color: var(--text-sub);
  transition: color 0.2s;
}

.size-option.selected .size-preview {
  color: var(--accent-dark);
}

.size-option .size-label {
  font-size: 10px;
  color: var(--text-hint);
  font-weight: 600;
}

.size-option.selected .size-label {
  color: var(--accent-dark);
}

/* 布局大小变量 */
.chat-size-small .msg-avatar {
  width: 26px;
  height: 26px;
  border-radius: 8px;
  font-size: 10px;
}

.chat-size-small .msg-bubble {
  padding: 7px 10px;
  font-size: 12px;
  line-height: 1.45;
}

.chat-size-small .msg-sender {
  font-size: 9px;
}

.chat-size-small .msg-time {
  font-size: 8px;
}

.chat-size-small .msg-row {
  gap: 6px;
  max-width: 80%;
}

.chat-size-small .msg-content {
  gap: 2px;
}

.chat-size-small .chat-date-divider span {
  font-size: 9px;
  padding: 2px 10px;
}

.chat-size-small .typing-indicator {
  padding: 7px 10px;
}

.chat-size-small .typing-indicator span {
  width: 4px;
  height: 4px;
}

.chat-size-medium .msg-avatar {
  width: 30px;
  height: 30px;
  border-radius: 9px;
  font-size: 11px;
}

.chat-size-medium .msg-bubble {
  padding: 8px 12px;
  font-size: 13px;
  line-height: 1.5;
}

.chat-size-medium .msg-sender {
  font-size: 10px;
}

.chat-size-medium .msg-time {
  font-size: 9px;
}

.chat-size-medium .msg-row {
  gap: 7px;
  max-width: 82%;
}

.chat-size-medium .msg-content {
  gap: 2px;
}

.chat-size-medium .chat-date-divider span {
  font-size: 10px;
}

.chat-size-medium .typing-indicator {
  padding: 8px 12px;
}

.chat-size-medium .typing-indicator span {
  width: 5px;
  height: 5px;
}
/* ========== 输入栏改造 ========== */
.chat-input-bar {
  padding: 8px 10px;
  padding-bottom: calc(8px + var(--safe-bottom));
  gap: 6px;
}

.chat-input-wrap {
  border-radius: 18px;
  padding: 6px 14px;
}

.chat-func-btn {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: none;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.2s;
}

.chat-func-btn:active {
  background: var(--border);
  transform: scale(0.9);
}

.chat-send-btn {
  width: 34px;
  height: 34px;
}

/* ========== 聊天功能面板 ========== */
.chat-func-panel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card);
  border-top: 1px solid var(--border);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
  z-index: 155;
  display: none;
  flex-direction: column;
  max-height: 60vh;
  animation: slideUp 0.25s ease;
}

.chat-func-panel.active {
  display: flex;
}

.chat-func-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px 10px;
  flex-shrink: 0;
}

.chat-func-header h3 {
  font-size: 15px;
  font-weight: 700;
}

.chat-func-close {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: none;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.chat-func-close:active {
  background: var(--border);
}

.chat-func-body {
  padding: 0 18px 18px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.func-btn-row {
  display: flex;
  align-items: center;
  padding: 12px 14px;
  gap: 12px;
  background: var(--bg);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s;
}

.func-btn-row:active {
  transform: scale(0.97);
  opacity: 0.7;
}

.func-btn-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.func-btn-info {
  flex: 1;
}

.func-btn-info .func-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}

.func-btn-info .func-desc {
  font-size: 11px;
  color: var(--text-sub);
  margin-top: 1px;
}

/* ========== 状态栏卡片 ========== */
.status-card-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.35);
  z-index: 200;
  display: none;align-items: center;
  justify-content: center;
  padding: 20px;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

.status-card-overlay.active {
  display: flex;
}

.status-card {
  width: 100%;
  max-width: 340px;
  background: var(--card);
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 8px 40px rgba(0,0,0,0.12);
  animation: statusPop 0.3s ease;
}

@keyframes statusPop {
  from { transform: scale(0.85); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.status-card-top {
  padding: 24px 20px 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  background: linear-gradient(135deg, var(--accent-light) 0%, #f0f5f4 100%);
}

.status-card-avatar {
  width: 56px;
  height: 56px;
  border-radius: 16px;
  overflow: hidden;
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  font-weight: 700;
  color: var(--text-hint);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.status-card-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.status-card-name {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
}

.status-card-time {
  font-size: 10px;
  color: var(--text-sub);
}

.status-card-body {
  padding: 16px 20px 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.status-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
}

.status-item-icon {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;font-size: 14px;
}

.status-item-content {
  flex: 1;
}

.status-item-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--text-sub);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 2px;
}

.status-item-text {
  font-size: 13px;
  color: var(--text);
  line-height: 1.5;
}

.status-card-loading {
  padding: 40px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  color: var(--text-sub);font-size: 13px;
}

.status-card-footer {
  padding: 0 20px 16px;
  display: flex;
  gap: 8px;
}

.status-card-footer button {
  flex: 1;
  height: 36px;
  border-radius: 18px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s;
}

.status-card-footer button:active {
  transform: scale(0.96);
}

.btn-status-refresh {
  border: 1px solid var(--accent);
  background: var(--accent-light);
  color: var(--accent-dark);
}

.btn-status-close {
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text-sub);
}

/* ========== 状态历史页面 ========== */
.status-history-page {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 700;
  display: none;
  flex-direction: column;
}

.status-history-page.active {
  display: flex;
}

.status-history-body {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.history-status-card {
  background: var(--card);
  border-radius: var(--radius-md);
  padding: 14px 16px;
  box-shadow: var(--shadow-sm);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.history-status-time {
  font-size: 10px;
  color: var(--text-hint);
}

.history-status-items {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.history-status-row {
  display: flex;
  align-items: center;
  gap: 8px;font-size: 13px;
}

.history-status-row .h-icon {
  font-size: 14px;flex-shrink: 0;
}

.history-status-row .h-label {
  font-size: 11px;
  color: var(--text-sub);
  font-weight: 600;min-width: 36px;
}

.history-status-row .h-text {
  color: var(--text);
  flex: 1;
}

/* ========== 气泡颜色选择 ========== */
.color-picker-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
}

.color-picker-row .cp-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
}

.color-picker-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
}

.color-preview-dot {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid var(--border);
  cursor: pointer;
  transition: transform 0.15s;
}

.color-preview-dot:active {
  transform: scale(0.9);
}

.color-picker-wrap input[type="color"] {
  width: 0;
  height: 0;
  padding: 0;
  border: none;
  opacity: 0;
  position: absolute;
}

.color-reset-btn {
  height: 26px;
  padding: 0 10px;
  border: 1px solid var(--border);
  border-radius: 13px;
  background: var(--card);
  font-size: 11px;
  color: var(--text-sub);
  cursor: pointer;
  font-family: inherit;
}

.color-reset-btn:active {
  background: var(--bg);
}
/* ========== 朋友圈页面 ========== */
.page-moments {
  width: 100%;
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 0;
  display: none;
  flex-direction: column;
}

.page-moments.active {
  display: flex;
}

.moments-header-banner {
  width: 100%;
  height: 140px;
  background: linear-gradient(135deg, #d4ede9 0%, #b8d8e8 50%, #e8dff0 100%);
  position: relative;
  flex-shrink: 0;
}

.moments-my-info {
  position: absolute;
  bottom: -28px;
  right: 16px;
  display: flex;
  align-items: flex-end;
  gap: 10px;
  z-index: 10;
}

.moments-my-name {
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  text-shadow: 0 1px 4px rgba(0,0,0,0.3);
  margin-bottom: 8px;
}

.moments-my-avatar {
  width: 56px;
  height: 56px;
  border-radius: 16px;
  overflow: hidden;
  background: var(--card);
  border: 3px solid var(--card);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 700;
  color: var(--text-hint);
}

.moments-my-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.moments-list {
  padding: 40px 14px 14px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* 朋友圈卡片 */
.moment-card {
  background: var(--card);
  border-radius: var(--radius-md);
  padding: 16px;
  box-shadow: var(--shadow-sm);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.moment-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

.moment-avatar {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  overflow: hidden;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-hint);
  flex-shrink: 0;
}

.moment-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.moment-author-info {
  flex: 1;
}

.moment-author-name {
  font-size: 14px;
  font-weight: 700;
  color: var(--accent-dark);
}

.moment-time {
  font-size: 11px;
  color: var(--text-hint);
}

.moment-content {
  font-size: 14px;
  color: var(--text);
  line-height: 1.6;
  word-break: break-word;
  white-space: pre-wrap;
}

.moment-actions {
  display: flex;
  align-items: center;
  gap: 16px;
  padding-top: 4px;
}

.moment-action-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: var(--text-sub);
  cursor: pointer;
  padding: 4px 0;
  transition: color 0.15s;
}

.moment-action-btn:active {
  color: var(--accent);
}

.moment-action-btn.liked {
  color: #e06080;
}
/* 删除动态按钮 */
.moment-action-btn.delete {
  color: var(--text-hint);
}

.moment-action-btn.delete:active {
  color: #e06060;
}

/* 点赞区域 */
.moment-likes {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: var(--bg);
  border-radius: 8px;
  flex-wrap: wrap;
}

.moment-likes .like-icon {
  color: #e06080;
  font-size: 12px;
}

.moment-likes .like-names {
  font-size: 12px;
  color: var(--accent-dark);
  font-weight: 600;
}

/* 评论区域 */
.moment-comments {
  background: var(--bg);
  border-radius: 8px;
  padding: 8px 10px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.moment-comment {
  font-size: 12px;
  line-height: 1.5;
  color: var(--text);
}

.moment-comment .comment-author {
  font-weight: 700;
  color: var(--accent-dark);
  cursor: pointer;
}

.moment-comment .comment-reply-to {
  color: var(--text-sub);
}

.moment-comment .comment-text {
  color: var(--text);
}

/* 评论输入 */
.moment-comment-input {
  display: flex;
  gap: 6px;
  padding-top: 4px;
}

.moment-comment-input input {
  flex: 1;
  height: 32px;
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 0 12px;
  font-size: 12px;
  background: var(--card);
  color: var(--text);
  outline: none;
  font-family: inherit;
}

.moment-comment-input input:focus {
  border-color: var(--accent);
}

.moment-comment-input button {
  height: 32px;
  padding: 0 12px;
  border: none;
  border-radius: 16px;
  background: var(--accent);
  color: #fff;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  white-space: nowrap;
}

.moment-comment-input button:active {
  background: var(--accent-dark);
}

/* 发朋友圈浮动按钮 */
.moment-fab {
  position: fixed;
  bottom: calc(70px + var(--safe-bottom));
  right: 16px;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  box-shadow: 0 4px 14px rgba(126,184,180,0.4);
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 50;
  transition: all 0.2s;
}

.moment-fab.show {
  display: flex;
}

.moment-fab:active {
  transform: scale(0.9);
}

/* 发朋友圈弹窗 */
.post-moment-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.3);
  z-index: 250;
  display: none;
  align-items: flex-end;
  justify-content: center;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

.post-moment-overlay.active {
  display: flex;
}

.post-moment-card {
  width: 100%;
  max-width: 480px;
  max-height: 85vh;
  background: var(--card);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  animation: slideUp 0.3s ease;
}

.post-moment-body {
  padding: 18px 20px;
  overflow-y: auto;
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.post-moment-textarea {
  width: 100%;
  min-height: 100px;
  border: none;
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 14px;
  font-size: 14px;
  color: var(--text);
  font-family: inherit;
  resize: none;
  outline: none;
  line-height: 1.6;
}

.post-moment-textarea:focus {
  background: #f0eeeb;
}

.post-moment-textarea::placeholder {
  color: var(--text-hint);
}

/* 选择可见角色 */
.visible-selector {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.visible-selector-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-sub);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.visible-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.visible-chip {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 20px;
  background: var(--bg);
  cursor: pointer;
  font-size: 13px;
  color: var(--text-sub);
  transition: all 0.2s;
}

.visible-chip.selected {
  border-color: var(--accent);
  background: var(--accent-light);
  color: var(--accent-dark);
}

.visible-chip:active {
  transform: scale(0.95);
}

.visible-chip-avatar {
  width: 22px;
  height: 22px;
  border-radius: 7px;
  overflow: hidden;
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 600;
  color: var(--text-hint);
}

.visible-chip-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.moment-loading-bar {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px;
  color: var(--text-sub);
  font-size: 13px;
}

.no-moments {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  color: var(--text-hint);
  gap: 8px;
}

.no-moments svg {
  opacity: 0.3;
}

.no-moments p {
  font-size: 13px;
}
.moments-header-banner {
  position: relative;
  overflow: visible;
}


.moments-header-banner > img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  position: absolute;
  top: 0; left: 0;
}


.moments-bg-btn {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}

.moments-bg-btn:active {
  background: rgba(0,0,0,0.5);
}
.moment-comment.clickable-comment {
  cursor: pointer;
  padding: 2px 0;
  border-radius: 4px;
  transition: background 0.15s;
}

.moment-comment.clickable-comment:active {
  background: rgba(0,0,0,0.05);
}

.moment-comment-input .reply-hint {
  font-size: 11px;
  color: var(--accent);
  padding: 2px 0;
  display: flex;
  align-items: center;
  gap: 4px;
}

.moment-comment-input .reply-hint button {
  background: none;
  border: none;
  color: var(--text-hint);
  font-size: 11px;
  cursor: pointer;
  padding: 0 4px;
}

</style>
</head>
<body>


<!-- ===== 主页面 ===== -->
<div class="page-main" id="pageMain"><!-- 状态栏 -->
  <div class="status-bar">
    <div class="status-left" id="statusTime">9:41</div>
    <div class="status-center">
      <div class="dynamic-island"></div>
    </div>
    <div class="status-right">
      <div class="signal-bars"><span></span><span></span><span></span><span></span></div>
      <svg class="status-wifi" width="15" height="11" viewBox="0 0 16 12" fill="none">
        <path d="M8 11.5a1.25 1.25 0 100-2.5 1.25 1.25 0 000 2.5z" fill="#2c2c2c"/>
        <path d="M5.17 8.33a4 4 0 015.66 0" stroke="#2c2c2c" stroke-width="1.4" stroke-linecap="round"/>
        <path d="M2.93 5.75a7.07 7.07 0 0110.14 0" stroke="#2c2c2c" stroke-width="1.4" stroke-linecap="round"/>
        <path d="M.7 3.17a10.14 10.14 0 0114.6 0" stroke="#2c2c2c" stroke-width="1.4" stroke-linecap="round"/>
      </svg>
      <div class="status-battery-group">
        <span class="battery-percent" id="batteryPercent">100%</span>
        <svg width="25" height="12" viewBox="0 0 27 13" fill="none">
          <rect x="0.5" y="0.5" width="23" height="12" rx="3" stroke="#2c2c2c" stroke-opacity="0.3"/>
          <rect x="2" y="2" width="20" height="9" rx="1.5" fill="#2c2c2c" id="batteryFill"/>
          <path d="M25 4.5v4a2 2 0 000-4z" fill="#2c2c2c" fill-opacity="0.3"/>
        </svg>
      </div>
    </div>
  </div>

  <!-- 导航栏 -->
  <div class="nav-bar">
    <div class="nav-title">消息</div>
    <div class="nav-actions">
      <button class="btn-icon" id="btnAddContact" title="添加联系人">
        <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
          <path d="M10 4v12M4 10h12" stroke="var(--accent)" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- 聊天列表页 -->
  <div class="chat-list-area" id="chatListArea">
    <div class="empty-state" id="emptyState">
      <svg width="56" height="56" viewBox="0 0 64 64" fill="none">
        <rect x="10" y="14" width="44" height="32" rx="8" stroke="#ccc" stroke-width="1.5"/>
        <path d="M10 22h44" stroke="#ccc" stroke-width="1.5"/>
        <circle cx="22" cy="34" r="3.5" stroke="#ccc" stroke-width="1.5"/>
        <path d="M30 30h16M30 37h10" stroke="#ccc" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <p>还没有联系人</p>
    </div>
    <div id="contactList"></div>
  </div>
  <!-- 朋友圈页面 -->
  <div class="page-moments" id="pageMoments">
    <div class="moments-header-banner" id="momentsBanner">
      <button class="moments-bg-btn" id="btnChangeMomentsBg">
        <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
          <rect x="2" y="4" width="16" height="12" rx="2" stroke="#fff" stroke-width="1.5"/>
          <circle cx="7" cy="9" r="2" stroke="#fff" stroke-width="1.5"/>
          <path d="M18 14l-4-4-6 6" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
      <input type="file" id="momentsBgInput" accept="image/*" style="display:none">
      <div class="moments-my-info">
        <span class="moments-my-name" id="momentsMyName"></span>
        <div class="moments-my-avatar" id="momentsMyAvatar"></div>
      </div>
    </div>
    <div class="moments-list" id="momentsList">
      <div class="no-moments" id="noMoments">
        <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
          <circle cx="24" cy="24" r="18" stroke="#ccc" stroke-width="1.5"/>
          <path d="M16 24h16M24 16v16" stroke="#ccc" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <p>还没有动态，发一条吧</p>
      </div>
    </div>
  </div>
<!-- 发现页面 -->
<div class="page-discover" id="pageDiscover">
  <div class="discover-list">
    <!-- 论坛入口 -->
    <div class="discover-item" id="btnEnterForum">
      <div class="discover-item-icon" style="background:linear-gradient(135deg,#e8f4f2,#d4ede9);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <rect x="3" y="4" width="18" height="16" rx="3" stroke="var(--accent)" stroke-width="1.8"/>
          <path d="M7 9h10M7 13h6" stroke="var(--accent)" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="discover-item-info">
        <div class="discover-item-title">论坛</div>
        <div class="discover-item-desc">创建专属世界观论坛，与角色互动</div>
      </div>
      <svg class="discover-item-arrow" width="8" height="14" viewBox="0 0 8 14" fill="none">
        <path d="M1 1l6 6-6 6" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    
    <!-- 更多功能占位 -->
    <div class="discover-item" style="opacity:0.5;pointer-events:none;">
      <div class="discover-item-icon" style="background:#f0f0f0;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="8" stroke="#ccc" stroke-width="1.8"/>
          <path d="M12 8v4l2 2" stroke="#ccc" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="discover-item-info">
        <div class="discover-item-title">更多功能</div>
        <div class="discover-item-desc">敬请期待...</div>
      </div>
      <svg class="discover-item-arrow" width="8" height="14" viewBox="0 0 8 14" fill="none">
        <path d="M1 1l6 6-6 6" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>
</div>

  <!-- "我的"页面 -->
  <div class="page-me" id="pageMe">
    <div class="me-profile-card">
    <!-- 面具管理按钮 -->
<div style="display:flex;justify-content:flex-end;margin-bottom:8px;">
  <button id="btnManageMasks" style="
    display:flex;
    align-items:center;
    gap:6px;
    padding:8px 14px;
    border:1px solid var(--accent);
    border-radius:20px;
    background:var(--accent-light);
    color:var(--accent-dark);
    font-size:13px;
    font-weight:600;
    cursor:pointer;
    font-family:inherit;
  ">
    <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
      <circle cx="10" cy="7" r="4" stroke="currentColor" stroke-width="1.5"/>
      <path d="M4 18c0-3 2.5-5 6-5s6 2 6 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      <path d="M15 3l2 2-2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    切换面具
  </button>
</div>
      <div class="me-avatar-wrap" id="meAvatarWrap">
        <div class="me-avatar" id="meAvatar">我</div>
        <div class="me-avatar-badge">
          <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
            <path d="M12 5l-5.5 5.5L4 8" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      <div class="me-name" id="meNameDisplay">未设置昵称</div>
      <div class="me-desc" id="meDescDisplay">点击下方编辑你的个人信息</div>
    </div>

    <div class="me-edit-section">
      <div class="section-title">个人信息</div>
      <div class="me-edit-row" id="meEditBtn" style="cursor:pointer;">
        <span class="row-label">编辑资料</span>
        <span class="row-value">
          <span>点击编辑</span>
          <svg width="7" height="12" viewBox="0 0 8 14" fill="none">
            <path d="M1 1l6 6-6 6" stroke="#bbb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </div>
      <div class="me-edit-row">
        <span class="row-label">昵称</span>
        <span class="row-value"><span id="meNickRow">未设置</span></span>
      </div>
      <div class="me-edit-row">
        <span class="row-label">性别</span>
        <span class="row-value"><span id="meGenderRow">未设置</span></span>
      </div>
      <div class="me-edit-row">
        <span class="row-label">人设</span>
        <span class="row-value"><span id="mePersonaRow">未设置</span></span>
      </div></div>
<div class="me-edit-section">
  <div class="section-title">显示设置</div>
  <div class="me-edit-row">
    <span class="row-label">🖥️ 全屏模式</span>
    <div class="toggle-switch" id="toggleFullscreen"></div>
  </div>
  <div style="font-size:11px;color:var(--text-hint);padding:0 0 4px;">开启后隐藏浏览器工具栏，获得沉浸式体验</div>
</div>

          <div class="me-edit-section">
      <div class="section-title">数据管理</div>
      <div class="me-edit-row" id="btnExportData" style="cursor:pointer;">
        <span class="row-label">导出全部数据</span>
        <span class="row-value">
          <span>备份存档</span>
          <svg width="7" height="12" viewBox="0 0 8 14" fill="none">
            <path d="M1 1l6 6-6 6" stroke="#bbb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </div>
      <div class="me-edit-row" id="btnImportData" style="cursor:pointer;">
        <span class="row-label">导入数据</span>
        <span class="row-value">
          <span>恢复存档</span>
          <svg width="7" height="12" viewBox="0 0 8 14" fill="none">
            <path d="M1 1l6 6-6 6" stroke="#bbb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </div>
      <input type="file" id="importFileInput" accept=".json" style="display:none">
    </div>

    <input type="file" id="meAvatarInput" accept="image/*" style="display:none">
  </div>

  <!-- 底部导航栏 -->
<div class="tab-bar" id="tabBar">
  <div class="tab-item active" data-tab="chat">
    <div class="tab-icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M20 12c0 4.418-3.582 8-8 8a8.06 8.06 0 01-3.2-.66L4 21l1.66-4.8A8.06 8.06 0 014 12c0-4.418 3.582-8 8-8s8 3.582 8 8z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M9 11h.01M12 11h.01M15 11h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>
    <span class="tab-label">聊天</span>
  </div>
  <div class="tab-item" data-tab="moments">
    <div class="tab-icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.8"/>
        <path d="M8 12.5l2.5 2.5L16 9" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <span class="tab-label">朋友圈</span>
  </div>
  <div class="tab-item" data-tab="discover">
    <div class="tab-icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.8"/>
        <path d="M12 7v5l3 3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <span class="tab-label">发现</span>
  </div>
  <div class="tab-item" data-tab="me">
    <div class="tab-icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="1.8"/>
        <path d="M5 20c0-3.314 3.134-6 7-6s7 2.686 7 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
      </svg>
    </div>
    <span class="tab-label">我的</span>
  </div>
</div>
<!-- 消息通知容器 -->
<div class="notification-container" id="notificationContainer"></div>
<!-- 悬浮全屏按钮 -->
<button id="floatingFullscreenBtn" style="
  position: fixed;
  top: 120px;
  right: 10px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  background: var(--accent);
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 9999;
  transition: all 0.2s;
" title="全屏模式">
  <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
    <path d="M3 7V4a1 1 0 011-1h3M13 3h3a1 1 0 011 1v3M17 13v3a1 1 0 01-1 1h-3M7 17H4a1 1 0 01-1-1v-3" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

<!-- 发朋友圈浮动按钮 -->
<button class="moment-fab" id="momentFab">
  <svg width="22" height="22" viewBox="0 0 20 20" fill="none">
    <path d="M10 4v12M4 10h12" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
  </svg>
</button>

<!-- 发朋友圈弹窗 -->
<div class="post-moment-overlay" id="postMomentOverlay">
  <div class="post-moment-card">
    <div class="modal-header">
      <h2>发动态</h2>
      <button class="modal-close" id="btnClosePostMoment">
        <svg width="12" height="12" viewBox="0 0 14 14" fill="none">
          <path d="M1 1l12 12M13 1L1 13" stroke="#999" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="post-moment-body">
      <textarea class="post-moment-textarea" id="momentTextarea" placeholder="分享你的想法..."></textarea>
      <div class="visible-selector">
        <div class="visible-selector-title">谁可以看到（必选，被选中的角色会互动）</div>
        <div class="visible-list" id="visibleList"></div>
      </div>
      <button class="btn-save" id="btnPublishMoment" type="button">发布</button>
    </div>
  </div>
</div>
<!-- ===== 论坛列表页 ===== -->
<div class="forum-page" id="forumPage">
  <div class="forum-header">
    <button class="btn-back" id="btnBackFromForum">
      <svg width="10" height="18" viewBox="0 0 12 20" fill="none">
        <path d="M10 2L2 10l8 8" stroke="var(--text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <h2>论坛</h2>
  </div>
  <div class="forum-body" id="forumBody">
    <div class="btn-create-forum" id="btnCreateForum">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
        <path d="M10 4v12M4 10h12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      </svg>
      创建新论坛
    </div>
    <div id="forumList"></div>
    <div class="forum-empty" id="forumEmpty" style="display:none;">
      <svg width="56" height="56" viewBox="0 0 64 64" fill="none">
        <rect x="10" y="12" width="44" height="40" rx="6" stroke="#ccc" stroke-width="1.5"/>
        <path d="M20 24h24M20 34h16M20 44h20" stroke="#ccc" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <p>还没有论坛<br>创建一个专属世界观论坛吧</p>
    </div>
  </div>
</div>

<!-- ===== 创建/编辑论坛页 ===== -->
<div class="forum-edit-page" id="forumEditPage">
  <div class="forum-header">
    <button class="btn-back" id="btnBackFromForumEdit">
      <svg width="10" height="18" viewBox="0 0 12 20" fill="none">
        <path d="M10 2L2 10l8 8" stroke="var(--text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <h2 id="forumEditTitle">创建论坛</h2>
  </div>
  <div class="forum-edit-body">
    <div class="form-group">
      <label class="form-label">论坛名称</label>
      <input class="form-input" type="text" id="forumEditName" placeholder="例如：魔法学院、末日生存..." maxlength="20">
    </div>
    
    <div class="form-group">
      <label class="form-label">论坛图标</label>
      <input class="form-input" type="text" id="forumEditIcon" placeholder="输入一个emoji，如 🏰 🌟 🎮" maxlength="2">
    </div>
    
    <div class="form-group">
      <label class="form-label">世界观设定</label>
      <textarea class="form-textarea" id="forumEditWorldview" placeholder="描述这个论坛的世界观、背景设定、时代背景等...&#10;&#10;例如：这是一个魔法与科技并存的世界，人们可以使用魔法进行日常生活..." style="min-height:120px;"></textarea>
    </div>
    
    <div class="member-selector">
      <div class="member-selector-title">选择论坛成员（这些角色会在论坛中发帖互动）</div>
      <div class="member-selector-list" id="forumMemberList"></div>
    </div>
    
    <div class="form-group">
      <label class="form-label">API 配置（用于生成帖子内容）</label>
      <button class="api-config-btn" id="btnForumApiSelect" type="button">
        <span class="label" id="forumSelectedApiLabel">未配置</span>
        <span class="value">选择
          <svg width="7" height="12" viewBox="0 0 8 14" fill="none">
            <path d="M1 1l6 6-6 6" stroke="#bbb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </button>
    </div>
  </div>
  <div class="forum-edit-footer">
    <button class="btn-delete-forum" id="btnDeleteForum" style="display:none;">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
        <path d="M4 6h12M8 6V5a2 2 0 012-2h0a2 2 0 012 2v1M15 6v9a3 3 0 01-3 3H8a3 3 0 01-3-3V6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
    </button>
    <button class="btn-save" id="btnSaveForum">保存论坛</button>
  </div>
</div>

<!-- ===== 论坛详情页 ===== -->
<div class="forum-detail-page" id="forumDetailPage">
  <div class="forum-detail-header">
    <div class="forum-detail-header-top">
      <button class="btn-back" id="btnBackFromForumDetail">
        <svg width="10" height="18" viewBox="0 0 12 20" fill="none">
          <path d="M10 2L2 10l8 8" stroke="var(--text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <h2 id="forumDetailTitle">论坛</h2>
      <button class="btn-icon" id="btnEditCurrentForum" title="编辑论坛">
        <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
          <path d="M14.5 3.5l2 2M3 14l9-9 2 2-9 9H3v-2z" stroke="var(--text-sub)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    <div class="forum-detail-banner">
      <div class="forum-worldview" id="forumDetailWorldview"></div>
    </div>
  </div>
  <div class="forum-detail-body" id="forumDetailBody">
    <div class="forum-refresh-bar">
      <button class="btn-refresh-forum" id="btnRefreshForum">
        <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
          <path d="M4 10a6 6 0 0110.5-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M16 10a6 6 0 01-10.5 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M14 3v3h3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M6 17v-3H3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        刷新帖子
      </button>
    </div>
    <div id="forumPostList"></div>
  </div>
</div>

<!-- ===== 论坛API选择页 ===== -->
<div class="chat-api-page" id="forumApiPage" style="z-index:560;">
  <div class="chat-settings-header">
    <button class="btn-back" id="btnBackFromForumApi">
      <svg width="10" height="18" viewBox="0 0 12 20" fill="none">
        <path d="M10 2L2 10l8 8" stroke="var(--text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <h2>选择 API</h2>
  </div>
  <div class="chat-api-body">
    <div class="api-saved-list" id="forumApiList"></div>
  </div>
</div>
<!-- ===== 聊天室页面 ===== -->

<div class="page-chat" id="pageChat">
  <!-- 聊天顶部 -->
  <div class="chat-header">
    <div class="chat-header-top">
      <button class="chat-back-btn" id="btnChatBack">
        <svg width="10" height="18" viewBox="0 0 12 20" fill="none">
          <path d="M10 2L2 10l8 8" stroke="var(--text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="chat-header-avatar" id="chatHeaderAvatar"></div>
      <div class="chat-header-info">
        <div class="chat-header-name" id="chatHeaderName">名字</div>
        <div class="chat-header-status" id="chatHeaderStatus">在线</div>
      </div>
      <div class="chat-header-actions">
        <button class="btn-icon" id="btnChatSettings" title="聊天设置">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="3" stroke="var(--text-sub)" stroke-width="1.8"/>
            <path d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12" stroke="var(--text-sub)" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

    </div>
    <!-- 自定义文案 -->
    <div class="chat-custom-banner">
      <input type="text" id="chatBanner" placeholder="写点什么作为你们的专属标语...">
    </div>
  </div>

  <!-- 消息区域 -->
  <div class="chat-messages" id="chatMessages"></div>
  <!-- 接收消息按钮 -->
<button id="receiveMsgBtn" class="receive-msg-btn">
  <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
    <path d="M10 3v10M6 9l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M3 17h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
  接收消息
</button>
<!-- 重新回复按钮 -->
<div id="regenerateBtn" class="regenerate-btn">
  <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
    <path d="M4 10a6 6 0 0110.5-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    <path d="M16 10a6 6 0 01-10.5 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    <path d="M14 3v3h3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M6 17v-3H3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  重新回复
</div>

  <!-- 输入栏 -->
  <div class="chat-input-bar">
    <button class="chat-func-btn" id="btnChatFunc" title="功能">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
        <circle cx="4" cy="10" r="2" fill="var(--accent)"/>
        <circle cx="10" cy="10" r="2" fill="var(--accent)"/>
        <circle cx="16" cy="10" r="2" fill="var(--accent)"/>
      </svg>
    </button>
    <div class="chat-input-wrap">
      <textarea class="chat-input" id="chatInput" placeholder="输入消息..." rows="1"></textarea>
    </div>
    <button class="chat-send-btn" id="btnSend" disabled>
      <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
        <path d="M4 10l12-6-6 12-2-4-4-2z" fill="#ffffff" stroke="#ffffff" stroke-width="1.5" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

</div>

<!-- ===== 添加联系人弹窗 ===== -->
<div class="modal-overlay" id="addContactModal">
  <div class="modal-card">
    <div class="modal-header">
      <h2>添加联系人</h2>
      <button class="modal-close" id="btnCloseModal">
        <svg width="12" height="12" viewBox="0 0 14 14" fill="none">
          <path d="M1 1l12 12M13 1L1 13" stroke="#999" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="avatar-upload">
        <div class="avatar-preview" id="avatarPreview">
          <span class="placeholder-icon">
            <svg width="28" height="28" viewBox="0 0 32 32" fill="none">
              <path d="M16 8v16M8 16h16" stroke="#bbb" stroke-width="2.5" stroke-linecap="round"/>
            </svg>
          </span>
        </div>
        <span class="avatar-hint">点击上传头像</span>
        <input type="file" id="avatarInput" accept="image/*" style="display:none">
      </div>

      <div class="form-group">
        <label class="form-label">昵称</label>
        <input class="form-input" type="text" id="inputName" placeholder="输入昵称" maxlength="20">
      </div>

      <div class="form-group">
        <label class="form-label">性别</label>
        <div class="gender-selector" id="genderSelector">
          <div class="gender-option" data-gender="male">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
              <circle cx="6.5" cy="9.5" r="4" stroke="currentColor" stroke-width="1.5"/>
              <path d="M10 6l4-4M14 2h-3.5M14 2v3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>男
          </div>
          <div class="gender-option" data-gender="female">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
              <circle cx="8" cy="6" r="4" stroke="currentColor" stroke-width="1.5"/>
              <path d="M8 10v5M6 13h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>女
          </div><div class="gender-option" data-gender="other">其他</div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">人物设定</label>
        <textarea class="form-textarea" id="inputPersona" placeholder="描述这个人的性格、背景、说话方式等..."></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">API 配置</label>
        <button class="api-config-btn" id="btnOpenApiPage" type="button">
          <span class="label" id="selectedApiLabel">未配置</span>
          <span class="value">选择
            <svg width="7" height="12" viewBox="0 0 8 14" fill="none">
              <path d="M1 1l6 6-6 6" stroke="#bbb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </button>
      </div>

      <button class="btn-save" id="btnSaveContact" type="button">保存联系人</button>
    </div>
  </div>
</div>

<!-- ===== API 配置列表页 ===== -->
<div class="api-page" id="apiPage">
  <div class="api-page-header">
    <button class="btn-back" id="btnBackFromApi">
      <svg width="10" height="18" viewBox="0 0 12 20" fill="none">
        <path d="M10 2L2 10l8 8" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <h2>API 配置</h2>
  </div>
  <div class="api-page-body">
    <div class="api-saved-list" id="apiSavedList"></div>
    <button class="btn-new-api" id="btnNewApi" type="button">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
        <path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      新建 API 配置
    </button>
  </div>
</div>

<!-- ===== API 编辑页 ===== -->
<div class="api-edit-page" id="apiEditPage">
  <div class="api-page-header">
    <button class="btn-back" id="btnBackFromApiEdit">
      <svg width="10" height="18" viewBox="0 0 12 20" fill="none">
        <path d="M10 2L2 10l8 8" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <h2 id="apiEditTitle">新建 API 配置</h2>
  </div>
  <div class="api-edit-body">
    <div class="form-group">
      <label class="form-label">配置名称</label>
      <input class="form-input" type="text" id="inputApiName" placeholder="例如：我的GPT-4o" maxlength="30">
    </div>
    <div class="form-group">
      <label class="form-label">接口格式</label>
      <div class="format-selector" id="formatSelector">
        <div class="format-option selected" data-format="openai">OpenAI</div>
        <div class="format-option" data-format="gemini">Gemini</div></div>
    </div>
    <div class="form-group">
      <label class="form-label">API Base URL</label>
      <input class="form-input" type="text" id="inputApiBase" placeholder="https://api.openai.com">
    </div>
    <div class="form-group">
      <label class="form-label">API 密钥</label>
      <input class="form-input" type="text" id="inputApiKey" placeholder="sk-...">
    </div>
    <div class="form-group">
      <label class="form-label">模型名称</label>
      <input class="form-input" type="text" id="inputModelName" placeholder="gpt-4o">
    </div>
    <button class="btn-test" id="btnTestApi" type="button">测试连接</button>
  </div>
  <div class="api-edit-footer">
    <button class="btn-save" id="btnSaveApi" type="button">保存配置</button>
  </div>
</div>

<!-- ===== 编辑我的信息弹窗 ===== -->
<div class="modal-overlay me-edit-modal" id="meEditModal">
  <div class="modal-card">
    <div class="modal-header">
      <h2>编辑我的资料</h2>
      <button class="modal-close" id="btnCloseMeEdit">
        <svg width="12" height="12" viewBox="0 0 14 14" fill="none">
          <path d="M1 1l12 12M13 1L1 13" stroke="#999" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="avatar-upload">
        <div class="avatar-preview" id="meEditAvatarPreview" style="border-radius:20px;">
          <span class="placeholder-icon">
            <svg width="28" height="28" viewBox="0 0 32 32" fill="none">
              <path d="M16 8v16M8 16h16" stroke="#bbb" stroke-width="2.5" stroke-linecap="round"/>
            </svg>
          </span>
        </div>
        <span class="avatar-hint">点击更换头像</span>
        <input type="file" id="meEditAvatarInput" accept="image/*" style="display:none">
      </div>
      <div class="form-group">
        <label class="form-label">昵称</label>
        <input class="form-input" type="text" id="meEditName" placeholder="你的昵称" maxlength="20">
      </div>
      <div class="form-group">
        <label class="form-label">性别</label>
        <div class="gender-selector" id="meGenderSelector">
          <div class="gender-option" data-gender="male">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
              <circle cx="6.5" cy="9.5" r="4" stroke="currentColor" stroke-width="1.5"/>
              <path d="M10 6l4-4M14 2h-3.5M14 2v3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>男
          </div>
          <div class="gender-option" data-gender="female">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
              <circle cx="8" cy="6" r="4" stroke="currentColor" stroke-width="1.5"/>
              <path d="M8 10v5M6 13h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>女
          </div><div class="gender-option" data-gender="other">其他</div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">我的人设</label>
        <textarea class="form-textarea" id="meEditPersona" placeholder="描述你自己的性格、身份等，角色会根据这些来和你互动..."></textarea>
      </div><button class="btn-save" id="btnSaveMeEdit" type="button">保存</button>
    </div>
  </div>
</div>
<!-- ===== 聊天内 API 选择页 ===== -->
<div class="chat-api-page" id="chatApiPage">
  <div class="chat-settings-header">
    <button class="btn-back" id="btnBackFromChatApi">
      <svg width="10" height="18" viewBox="0 0 12 20" fill="none">
        <path d="M10 2L2 10l8 8" stroke="var(--text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <h2>API 配置</h2></div>
  <div class="chat-api-body">
    <div class="chat-api-current">
      <span class="current-label">当前使用</span>
      <span class="current-value" id="chatApiCurrentName">未配置</span>
      <span class="current-detail" id="chatApiCurrentDetail"></span>
    </div>
    <div class="settings-card-title" style="padding:8px 4px 0;">选择配置</div>
    <div class="api-saved-list" id="chatApiList"></div>
    <button class="btn-new-api" id="btnNewApiFromChat" type="button">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
        <path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      新建 API 配置
    </button>
  </div>
</div>
<!-- ===== 聊天室内编辑角色弹窗 ===== -->
<div class="chat-edit-overlay" id="chatEditOverlay">
  <div class="modal-card">
    <div class="modal-header">
      <h2>编辑角色</h2>
      <button class="modal-close" id="btnCloseChatEdit">
        <svg width="12" height="12" viewBox="0 0 14 14" fill="none">
          <path d="M1 1l12 12M13 1L1 13" stroke="#999" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="avatar-upload">
        <div class="avatar-preview" id="chatEditAvatarPreview" style="border-radius:20px;">
          <span class="placeholder-icon">
            <svg width="28" height="28" viewBox="0 0 32 32" fill="none">
              <path d="M16 8v16M8 16h16" stroke="#bbb" stroke-width="2.5" stroke-linecap="round"/>
            </svg>
          </span>
        </div>
        <span class="avatar-hint">点击更换头像</span>
        <input type="file" id="chatEditAvatarInput" accept="image/*" style="display:none">
      </div>
      <div class="form-group">
        <label class="form-label">昵称</label>
        <input class="form-input" type="text" id="chatEditName" placeholder="角色昵称" maxlength="20">
      </div>
      <div class="form-group">
        <label class="form-label">性别</label>
        <div class="gender-selector" id="chatEditGenderSelector">
          <div class="gender-option" data-gender="male">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
              <circle cx="6.5" cy="9.5" r="4" stroke="currentColor" stroke-width="1.5"/>
              <path d="M10 6l4-4M14 2h-3.5M14 2v3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>男
          </div>
          <div class="gender-option" data-gender="female">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
              <circle cx="8" cy="6" r="4" stroke="currentColor" stroke-width="1.5"/>
              <path d="M8 10v5M6 13h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>女
          </div>
          <div class="gender-option" data-gender="other">其他</div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">人物设定</label>
        <textarea class="form-textarea" id="chatEditPersona" placeholder="角色的性格、背景、说话方式..."></textarea>
      </div>
      <button class="btn-save" id="btnSaveChatEdit" type="button">保存修改</button>
    </div>
  </div>
</div>
<!-- ===== 聊天功能面板 ===== -->
<div class="chat-func-panel" id="chatFuncPanel">
  <div class="chat-func-header">
    <h3>聊天功能</h3>
    <button class="chat-func-close" id="btnCloseFuncPanel">
      <svg width="10" height="10" viewBox="0 0 14 14" fill="none">
        <path d="M1 1l12 12M13 1L1 13" stroke="#999" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>
  <div class="chat-func-body">
    <div class="func-btn-row" id="btnViewStatus">
      <div class="func-btn-icon" style="background:linear-gradient(135deg,#e8f4f2,#d4ede9);">
        <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
          <circle cx="10" cy="10" r="7" stroke="var(--accent)" stroke-width="1.5"/>
          <path d="M10 6v4l3 2" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="func-btn-info">
        <div class="func-title">查看状态</div>
        <div class="func-desc">看看对方现在在做什么、心情如何</div>
      </div>
    </div>
    <div class="func-btn-row" id="btnStatusHistory">
      <div class="func-btn-icon" style="background:linear-gradient(135deg,#f0f0ff,#e4e4f8);">
        <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
          <rect x="3" y="3" width="14" height="14" rx="3" stroke="#7878c8" stroke-width="1.5"/>
          <path d="M7 8h6M7 12h4" stroke="#7878c8" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="func-btn-info">
        <div class="func-title">状态历史</div>
        <div class="func-desc">查看之前保存的状态记录</div>
      </div>
    </div>
  </div>
</div>
<!-- ===== 聊天设置页面 ===== -->
<div class="chat-settings-page" id="chatSettingsPage">
  <div class="chat-settings-header">
    <button class="btn-back" id="btnBackFromSettings">
      <svg width="10" height="18" viewBox="0 0 12 20" fill="none">
        <path d="M10 2L2 10l8 8" stroke="var(--text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <h2>聊天设置</h2>
  </div>
  <div class="chat-settings-body">
    <!-- 聊天布局大小 -->
    <div class="settings-card">
      <div class="settings-card-title">聊天布局</div>
      <div style="font-size:12px;color:var(--text-hint);margin-bottom:6px;">调整气泡和头像的显示大小</div>
      <div class="size-selector" id="sizeSelector">
        <div class="size-option" data-size="small">
          <span class="size-preview" style="font-size:12px;">Aa</span>
          <span class="size-label">小</span>
        </div>
        <div class="size-option" data-size="medium">
          <span class="size-preview" style="font-size:15px;">Aa</span>
          <span class="size-label">中</span>
        </div>
        <div class="size-option selected" data-size="default">
          <span class="size-preview" style="font-size:18px;">Aa</span>
          <span class="size-label">默认</span>
        </div>
      </div>

    <!-- 角色信息卡片 -->
    <div class="settings-card">
      <div class="settings-card-title">角色信息</div>
      <div style="display:flex;align-items:center;gap:12px;padding:4px 0;">
        <div id="settingsAvatar" style="width:48px;height:48px;border-radius:14px;background:var(--bg);display:flex;align-items:center;justify-content:center;overflow:hidden;font-size:18px;font-weight:600;color:var(--text-hint);flex-shrink:0;"></div>
        <div style="flex:1;min-width:0;">
          <div id="settingsName" style="font-size:15px;font-weight:700;color:var(--text);"></div>
          <div id="settingsGender" style="font-size:12px;color:var(--text-sub);margin-top:2px;"></div>
        </div>
      </div><div class="settings-btn-row" id="btnEditCharacter">
        <div class="s-btn-icon" style="background:var(--accent-light);">
          <svg width="16" height="16" viewBox="0 0 14 14" fill="none"><path d="M8.5 2.5l3 3M1 10l7-7 3 3-7 7H1v-3z" stroke="var(--accent)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <span class="s-btn-label">编辑角色</span><svg class="s-btn-arrow" width="7" height="12" viewBox="0 0 8 14" fill="none"><path d="M1 1l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
            <div class="settings-btn-row" id="btnEditApi">
        <div class="s-btn-icon" style="background:#e8f4f2;">
          <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
            <rect x="2" y="6" width="16" height="11" rx="2" stroke="var(--accent)" stroke-width="1.5"/>
            <path d="M6 6V4a4 4 0 018 0v2" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round"/>
            <circle cx="10" cy="11.5" r="1.5" fill="var(--accent)"/>
          </svg>
        </div>
        <span class="s-btn-label">API 配置</span>
        <svg class="s-btn-arrow" width="7" height="12" viewBox="0 0 8 14" fill="none"><path d="M1 1l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
    <!-- 危险操作 -->
    <div class="settings-card" style="border:1px solid #fde8e8;">
      <div class="settings-card-title" style="color:#e06060;">危险操作</div>
      <div class="settings-btn-row" id="btnDeleteContact">
        <div class="s-btn-icon" style="background:#fde8e8;">
          <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
            <path d="M4 6h12M8 6V5a2 2 0 012-2h0a2 2 0 012 2v1M15 6v9a3 3 0 01-3 3H8a3 3 0 01-3-3V6" stroke="#e06060" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M9 10v4M11 10v4" stroke="#e06060" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <span class="s-btn-label" style="color:#e06060;">删除该联系人</span>
        <svg class="s-btn-arrow" width="7" height="12" viewBox="0 0 8 14" fill="none"><path d="M1 1l6 6-6 6" stroke="#e06060" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
    </div>

    </div>
        <!-- 气泡颜色 -->
    <div class="settings-card">
      <div class="settings-card-title">气泡颜色</div>
      <div style="font-size:12px;color:var(--text-hint);margin-bottom:6px;">自定义你和对方的聊天气泡颜色</div>
      <div class="color-picker-row">
        <span class="cp-label">我的气泡</span>
        <div class="color-picker-wrap">
          <div class="color-preview-dot" id="myBubbleDot" style="background:var(--bubble-me);" onclick="document.getElementById('myBubbleColor').click()"></div>
          <input type="color" id="myBubbleColor" value="#7eb8b4"><button class="color-reset-btn" id="btnResetMyBubble">重置</button>
        </div>
      </div>
      <div class="color-picker-row">
        <span class="cp-label">对方气泡</span>
        <div class="color-picker-wrap">
          <div class="color-preview-dot" id="otherBubbleDot" style="background:var(--bubble-other);" onclick="document.getElementById('otherBubbleColor').click()"></div>
          <input type="color" id="otherBubbleColor" value="#ffffff">
          <button class="color-reset-btn" id="btnResetOtherBubble">重置</button>
        </div>
      </div>
    </div>

        <!-- 聊天背景 -->
    <div class="settings-card">
      <div class="settings-card-title">聊天背景</div>
      <div class="bg-preview-current" id="bgPreviewCurrent">
        <span class="no-bg">默认背景</span>
      </div>
      <div class="bg-btn-group">
        <button class="bg-btn-upload" id="btnChangeBg" type="button">
          <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
            <rect x="2" y="4" width="16" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/>
            <circle cx="7" cy="9" r="2" stroke="currentColor" stroke-width="1.5"/>
            <path d="M18 14l-4-4-6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          更换背景
        </button>
        <button class="bg-btn-clear" id="btnClearBg" type="button">
          <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
            <path d="M6 6l8 8M14 6l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          清除
        </button>
      </div>
      <input type="file" id="bgInput" accept="image/*" style="display:none"></div>


    <!-- 备注 -->
    <div class="settings-card">
      <div class="settings-card-title">备注</div>
      <div style="font-size:12px;color:var(--text-hint);margin-bottom:4px;">设置备注名后，聊天列表和对话中都会显示备注名</div>
            <div id="remarkDisplay" style="font-size:13px;color:var(--text);padding:8px 12px;background:var(--bg);border-radius:8px;min-height:20px;word-break:break-word;"></div>

      <div class="remark-input-wrap">
        <input type="text" id="remarkInput" placeholder="给这个角色添加备注..." maxlength="100">
        <button id="btnSaveRemark">保存</button>
      </div>
    </div>
<!-- 面具绑定 -->
<div class="settings-card">
  <div class="settings-card-title">身份面具</div>
  <div style="font-size:12px;color:var(--text-hint);margin-bottom:8px;">选择在这个角色面前使用哪个面具身份</div>
  <div id="maskBindingSelector" style="display:flex;flex-direction:column;gap:6px;"></div>
</div>

    <!-- 记忆轮数 -->
    <div class="settings-card">
      <div class="settings-card-title">对话设置</div>
      <div class="settings-row">
        <span class="s-label">记忆轮数</span>
        <div class="num-stepper">
          <button id="btnMemMinus">−</button>
          <span class="num-val" id="memoryVal">20</span>
          <button id="btnMemPlus">+</button>
        </div>
      </div>
      <div style="font-size:11px;color:var(--text-hint);margin-top:-4px;">发送给API的最近消息条数，0 = 全部发送</div>

      <div class="settings-row" style="margin-top:8px;">
        <span class="s-label">时间感知</span>
        <div class="toggle-switch" id="toggleTimeAware"></div>
      </div>
      <div style="font-size:11px;color:var(--text-hint);margin-top:-4px;">开启后角色会知道当前的真实时间</div>
            <div class="settings-row" style="margin-top:8px;">
        <span class="s-label">朋友圈记忆</span>
        <div class="toggle-switch" id="toggleMomentsMemory"></div>
      </div><div style="font-size:11px;color:var(--text-hint);margin-top:-4px;">开启后角色会记住你们最近的朋友圈互动</div>

    </div>

    <!-- 功能 -->
    <div class="settings-card">
      <div class="settings-card-title">工具</div>

      <div class="settings-btn-row" id="btnOpenSearch">
        <div class="s-btn-icon" style="background:#f0f0ff;">
          <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
            <circle cx="9" cy="9" r="6" stroke="#7878c8" stroke-width="1.8"/>
            <path d="M14 14l4 4" stroke="#7878c8" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
        </div>
        <span class="s-btn-label">搜索聊天记录</span>
        <svg class="s-btn-arrow" width="7" height="12" viewBox="0 0 8 14" fill="none"><path d="M1 1l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>

      <div class="settings-btn-row" id="btnOpenBatchDelete">
        <div class="s-btn-icon" style="background:#fde8e8;">
          <svg width="16" height="16" viewBox="0 0 14 14" fill="none"><path d="M2 4h10M5 4V3a1 1 0 011-1h2a1 1 0 011 1v1M11 4v7a2 2 0 01-2 2H5a2 2 0 01-2-2V4" stroke="#e06060" stroke-width="1.3" stroke-linecap="round"/></svg>
        </div>
        <span class="s-btn-label">批量删除消息</span>
        <svg class="s-btn-arrow" width="7" height="12" viewBox="0 0 8 14" fill="none"><path d="M1 1l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
    </div>

  </div>
</div>

<!-- ===== 批量删除页面 ===== -->
<div class="batch-delete-page" id="batchDeletePage">
  <div class="batch-delete-header">
    <button class="btn-back" id="btnBackFromBatch">
      <svg width="10" height="18" viewBox="0 0 12 20" fill="none">
        <path d="M10 2L2 10l8 8" stroke="var(--text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <h2>删除消息</h2><button class="btn-delete-confirm" id="btnConfirmDelete" disabled>删除 (0)</button>
  </div>
  <div class="batch-select-bar">
    <span id="batchCountLabel">共 0 条消息</span>
    <button id="btnSelectAll">全选</button></div>
  <div class="batch-delete-body" id="batchDeleteBody"></div>
</div>

<!-- ===== 搜索页面 ===== -->
<div class="search-page" id="searchPage">
  <div class="search-page-header">
    <button class="btn-back" id="btnBackFromSearch">
      <svg width="10" height="18" viewBox="0 0 12 20" fill="none">
        <path d="M10 2L2 10l8 8" stroke="var(--text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <input type="text" id="searchInput" placeholder="搜索聊天记录...">
    <button class="search-cancel-btn" id="btnSearchCancel">取消</button>
  </div>
  <div class="search-results" id="searchResults"><div class="search-empty">输入关键词搜索</div>
  </div>
</div>


<!-- ===== 状态卡片弹窗 ===== -->
<div class="status-card-overlay" id="statusCardOverlay">
  <div class="status-card" id="statusCard">
    <div class="status-card-top">
      <div class="status-card-avatar" id="statusCardAvatar"></div>
      <div class="status-card-name" id="statusCardName"></div>
      <div class="status-card-time" id="statusCardTime"></div>
    </div>
    <div id="statusCardContent">
      <div class="status-card-loading">
        <div class="spinner"></div>
        正在感知状态...
      </div>
    </div>
    <div class="status-card-footer" id="statusCardFooter" style="display:none;">
      <button class="btn-status-refresh" id="btnStatusRefresh">🔄 刷新状态</button>
      <button class="btn-status-close" id="btnStatusClose">关闭</button>
    </div>
  </div>
</div>


<!-- ===== 面具管理弹窗 ===== -->
<div class="modal-overlay" id="maskManagerModal">
  <div class="modal-card" style="max-height:85vh;">
    <div class="modal-header">
      <h2>我的面具</h2>
      <button class="modal-close" id="btnCloseMaskManager">
        <svg width="12" height="12" viewBox="0 0 14 14" fill="none">
          <path d="M1 1l12 12M13 1L1 13" stroke="#999" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body" style="padding-bottom:10px;">
      <div style="font-size:12px;color:var(--text-sub);margin-bottom:12px;">
        创建多个面具，在不同角色面前展示不同的自己
      </div>
      
      <!-- 面具列表 -->
      <div id="maskList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:14px;"></div>
      
      <!-- 新建面具按钮 -->
      <button id="btnNewMask" style="
        width:100%;
        height:44px;
        border:1.5px dashed var(--text-hint);
        border-radius:var(--radius-sm);
        background:transparent;
        color:var(--text-sub);
        font-size:13px;
        font-weight:500;
        cursor:pointer;
        font-family:inherit;
        display:flex;
        align-items:center;
        justify-content:center;
        gap:6px;
      ">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
          <path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        新建面具
      </button>
    </div>
  </div>
</div>

<!-- ===== 编辑面具弹窗 ===== -->
<div class="modal-overlay" id="maskEditModal">
  <div class="modal-card">
    <div class="modal-header">
      <h2 id="maskEditTitle">新建面具</h2>
      <button class="modal-close" id="btnCloseMaskEdit">
        <svg width="12" height="12" viewBox="0 0 14 14" fill="none">
          <path d="M1 1l12 12M13 1L1 13" stroke="#999" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="avatar-upload">
        <div class="avatar-preview" id="maskEditAvatarPreview" style="border-radius:20px;">
          <span class="placeholder-icon">
            <svg width="28" height="28" viewBox="0 0 32 32" fill="none">
              <path d="M16 8v16M8 16h16" stroke="#bbb" stroke-width="2.5" stroke-linecap="round"/>
            </svg>
          </span>
        </div>
        <span class="avatar-hint">点击上传头像</span>
        <input type="file" id="maskEditAvatarInput" accept="image/*" style="display:none">
      </div>
      
      <div class="form-group">
        <label class="form-label">面具名称</label>
        <input class="form-input" type="text" id="maskEditName" placeholder="例如：工作中的我、可爱模式" maxlength="20">
      </div>
      
      <div class="form-group">
        <label class="form-label">显示昵称</label>
        <input class="form-input" type="text" id="maskEditNickname" placeholder="对方看到的你的名字" maxlength="20">
      </div>
      
      <div class="form-group">
        <label class="form-label">性别</label>
        <div class="gender-selector" id="maskEditGenderSelector">
          <div class="gender-option" data-gender="male">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
              <circle cx="6.5" cy="9.5" r="4" stroke="currentColor" stroke-width="1.5"/>
              <path d="M10 6l4-4M14 2h-3.5M14 2v3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>男
          </div>
          <div class="gender-option" data-gender="female">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
              <circle cx="8" cy="6" r="4" stroke="currentColor" stroke-width="1.5"/>
              <path d="M8 10v5M6 13h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>女
          </div>
          <div class="gender-option" data-gender="other">其他</div>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">人设描述</label>
        <textarea class="form-textarea" id="maskEditPersona" placeholder="描述这个面具下的你是什么样的人..."></textarea>
      </div>
      
      <button class="btn-save" id="btnSaveMask" type="button">保存面具</button>
    </div>
  </div>
</div>

<!-- ===== 状态历史页面 ===== -->
<div class="status-history-page" id="statusHistoryPage">
  <div class="chat-settings-header">
    <button class="btn-back" id="btnBackFromStatusHistory">
      <svg width="10" height="18" viewBox="0 0 12 20" fill="none">
        <path d="M10 2L2 10l8 8" stroke="var(--text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <h2>状态历史</h2>
  </div>
  <div class="status-history-body" id="statusHistoryBody"></div>
</div>



<script>
// ========== 存储 - 使用 IndexedDB 替代 localStorage ==========
var DB_NAME = 'chatAppDB';
var DB_VERSION = 1;
var db = null;

function openDB(cb) {
  var req = indexedDB.open(DB_NAME, DB_VERSION);
  req.onupgradeneeded = function(e) {
    var d = e.target.result;
    if (!d.objectStoreNames.contains('kv')) {
      d.createObjectStore('kv');
    }
  };
  req.onsuccess = function(e) { db = e.target.result; cb(); };
  req.onerror = function() {
    console.warn('IndexedDB 不可用，回退到 localStorage');
    db = null; cb();
  };
}

function dbSet(key, val, cb) {
  if (!db) { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) { console.warn('存储失败', e); } if (cb) cb(); return; }
  var tx = db.transaction('kv', 'readwrite');
  tx.objectStore('kv').put(val, key);
  tx.oncomplete = function() { if (cb) cb(); };
  tx.onerror = function() { if (cb) cb(); };
}

function dbGet(key, cb) {
  if (!db) { var v = localStorage.getItem(key); cb(v ? JSON.parse(v) : null); return; }
  var tx = db.transaction('kv', 'readonly');
  var req = tx.objectStore('kv').get(key);
  req.onsuccess = function() { cb(req.result || null); };
  req.onerror = function() { cb(null); };
}

// ========== 全局数据 ==========
var contacts = [];
var apiConfigs = [];
var myProfile = { name: '', gender: '', persona: '', avatar: null };
var selectedApiId = null;
var editingApiId = null;
var currentAvatarData = null;
var selectedGender = null;
var currentChatId = null;
var chatEditAvatarData = null;
var chatEditGender = null;
var meEditAvatarData = null;
var meEditGender = null;
// 面具相关变量
var masks = [];
var currentMaskId = null; // 当前使用的面具ID
var editingMaskId = null;
var maskEditAvatarData = null;
var maskEditGender = null;

function saveMasks(cb) { dbSet('masks', masks, cb); }
function saveCurrentMaskId(cb) { dbSet('currentMaskId', currentMaskId, cb); }
// 论坛相关变量
var forums = [];
var currentForumId = null;
var editingForumId = null;
var forumSelectedMembers = new Set();
var forumSelectedApiId = null;

function saveForums(cb) { dbSet('forums', forums, cb); }

function gid() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 6); }
function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function saveContacts(cb) { dbSet('contacts', contacts, cb); }
function saveApiConfigs(cb) { dbSet('apiConfigs', apiConfigs, cb); }
function saveMyProfile(cb) { dbSet('myProfile', myProfile, cb); }

// ========== 初始化 ==========
openDB(function() {
  dbGet('contacts', function(v) {
    contacts = v || [];
    dbGet('apiConfigs', function(v2) {
      apiConfigs = v2 || [];
      dbGet('myProfile', function(v3) {
        myProfile = v3 || { name: '', gender: '', persona: '', avatar: null };
        initApp();
      });
    });
  });
});

function initApp() {
  // 加载面具数据
  dbGet('masks', function(v) {
    masks = v || [];
    dbGet('currentMaskId', function(v2) {
      currentMaskId = v2 || null;
      dbGet('forums', function(v3) {
        forums = v3 || [];
        dbGet('moments', function(v4) {  // 添加这一层
          moments = v4 || [];             // 添加这一行
          renderContactList();
          renderMePage();
          updateTime();
          setInterval(updateTime, 10000);

          if (navigator.getBattery) {
            navigator.getBattery().then(function(b) {
              function u() {
                document.getElementById('batteryPercent').textContent = Math.round(b.level * 100) + '%';
                document.getElementById('batteryFill').setAttribute('width', Math.max(2, b.level * 20));
              }
              u(); b.addEventListener('levelchange', u);
            });
          }
        });  // 添加这个闭合括号
      });
    });
  });
}



// ========== 时间 ==========
function updateTime() {
  var n = new Date();
  document.getElementById('statusTime').textContent = n.getHours() + ':' + n.getMinutes().toString().padStart(2, '0');
}

function fmtTime(ts) {
  var d = new Date(ts);
  var h = d.getHours();
  var m = d.getMinutes().toString().padStart(2, '0');
  var ampm = h < 12 ? '오전' : '오후';
  return ampm + ' ' + (h % 12 || 12) + ':' + m;
}

function fmtDate(ts) {
  var d = new Date(ts);
  return d.getFullYear() + '년 ' + (d.getMonth() + 1) + '월 ' + d.getDate() + '일';
}

// ========== Tab 切换 ==========
document.getElementById('tabBar').addEventListener('click', function(e) {
  var item = e.target.closest('.tab-item');
  if (!item) return;
  var tab = item.getAttribute('data-tab');
  document.querySelectorAll('.tab-item').forEach(function(el) { el.classList.remove('active'); });
  item.classList.add('active');

  document.getElementById('chatListArea').style.display = tab === 'chat' ? 'block' : 'none';
  document.getElementById('pageMoments').style.display = tab === 'moments' ? 'flex' : 'none';
  document.getElementById('pageMoments').classList.toggle('active', tab === 'moments');
  document.getElementById('pageDiscover').style.display = tab === 'discover' ? 'flex' : 'none';
  document.getElementById('pageDiscover').classList.toggle('active', tab === 'discover');
  document.getElementById('pageMe').style.display = tab === 'me' ? 'flex' : 'none';
  
  var titles = { chat: '消息', moments: '朋友圈', discover: '发现', me: '我的' };
  document.querySelector('.nav-bar .nav-title').textContent = titles[tab] || '消息';

  document.getElementById('btnAddContact').style.display = tab === 'chat' ? 'flex' : 'none';
  document.getElementById('momentFab').classList.toggle('show', tab === 'moments');

  if (tab === 'moments') {
    renderMomentsHeader();
    renderMoments();
  }
});



// ========== 渲染联系人列表 ==========
function renderContactList() {
  var list = document.getElementById('contactList');
  var empty = document.getElementById('emptyState');
  if (contacts.length === 0) { empty.style.display = 'flex'; list.innerHTML = ''; return; }
  empty.style.display = 'none';

  list.innerHTML = contacts.map(function(c) {
    var av = c.avatar ? '<img src="' + c.avatar + '">' : esc(c.name.charAt(0));
    var lastMsg = '', lastTime = '';
    if (c.messages && c.messages.length > 0) {
      var lm = c.messages[c.messages.length - 1];
      lastMsg = lm.text.length > 28 ? lm.text.substring(0, 28) + '...' : lm.text;
      lastTime = fmtTime(lm.ts);
    }
    return '<div class="contact-item" data-id="' + c.id + '">' +
      '<div class="contact-avatar-wrap"><div class="contact-avatar">' + av + '</div>' +
      '<div class="contact-online-dot"></div></div>' +
      '<div class="contact-name">' + esc(c.remark || c.name) + '</div>' +

      '<div class="contact-preview">' + (lastMsg ? esc(lastMsg) : '点击开始聊天') + '</div></div>' +
      '<div class="contact-meta"><span class="contact-time">' + lastTime + '</span></div></div>';
  }).join('');

  list.querySelectorAll('.contact-item').forEach(function(el) {
    el.addEventListener('click', function() { openChat(el.getAttribute('data-id')); });
  });
}

// ========== "我的"页面 ==========
function renderMePage() {
  // 获取当前面具或默认信息
  var currentMask = getCurrentMask();
  var displayInfo = currentMask || {
    nickname: myProfile.name,
    gender: myProfile.gender,
    persona: myProfile.persona,
    avatar: myProfile.avatar,
    name: '默认身份'
  };
  
  var avEl = document.getElementById('meAvatar');
  if (displayInfo.avatar) {
    avEl.innerHTML = '<img src="' + displayInfo.avatar + '">';
  } else {
    avEl.textContent = displayInfo.nickname ? displayInfo.nickname.charAt(0) : '我';
  }
  
  // 显示面具名称（如果有）
  var nameDisplay = displayInfo.nickname || '未设置昵称';
  if (currentMask) {
    nameDisplay = displayInfo.nickname || '未设置昵称';
  }
  document.getElementById('meNameDisplay').textContent = nameDisplay;
  
  // 显示当前面具标识
  var descText = displayInfo.persona || '点击下方编辑你的个人信息';
  if (currentMask) {
    descText = '🎭 ' + currentMask.name + (displayInfo.persona ? ' · ' + (displayInfo.persona.length > 20 ? displayInfo.persona.substring(0, 20) + '...' : displayInfo.persona) : '');
  }
  document.getElementById('meDescDisplay').textContent = descText;
  
  document.getElementById('meNickRow').textContent = displayInfo.nickname || '未设置';
  var gMap = { male: '男', female: '女', other: '其他' };
  document.getElementById('meGenderRow').textContent = gMap[displayInfo.gender] || '未设置';
  document.getElementById('mePersonaRow').textContent = displayInfo.persona ? (displayInfo.persona.length > 15 ? displayInfo.persona.substring(0, 15) + '...' : displayInfo.persona) : '未设置';
}

// 点击头像换头像
document.getElementById('meAvatarWrap').addEventListener('click', function() {
  document.getElementById('meAvatarInput').click();
});
document.getElementById('meAvatarInput').addEventListener('change', function(e) {
  var f = e.target.files[0]; if (!f) return;
  var r = new FileReader();
  r.onload = function(ev) {
    myProfile.avatar = ev.target.result;
    saveMyProfile();
    renderMePage();
  };
  r.readAsDataURL(f); e.target.value = '';
});

// 编辑我的信息弹窗
document.getElementById('meEditBtn').addEventListener('click', function() {
  meEditAvatarData = myProfile.avatar;
  meEditGender = myProfile.gender;
  document.getElementById('meEditName').value = myProfile.name || '';
  document.getElementById('meEditPersona').value = myProfile.persona || '';

  var prev = document.getElementById('meEditAvatarPreview');
  if (myProfile.avatar) {
    prev.innerHTML = '<img src="' + myProfile.avatar + '">';
  } else {
    prev.innerHTML = '<span class="placeholder-icon"><svg width="28" height="28" viewBox="0 0 32 32" fill="none"><path d="M16 8v16M8 16h16" stroke="#bbb" stroke-width="2.5" stroke-linecap="round"/></svg></span>';
  }

  document.querySelectorAll('#meGenderSelector .gender-option').forEach(function(el) {
    el.classList.toggle('selected', el.getAttribute('data-gender') === myProfile.gender);
  });

  document.getElementById('meEditModal').classList.add('active');
});

document.getElementById('btnCloseMeEdit').addEventListener('click', function() {
  document.getElementById('meEditModal').classList.remove('active');
});
document.getElementById('meEditModal').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('active');
});

document.getElementById('meEditAvatarPreview').addEventListener('click', function() {
  document.getElementById('meEditAvatarInput').click();
});
document.getElementById('meEditAvatarInput').addEventListener('change', function(e) {
  var f = e.target.files[0]; if (!f) return;
  var r = new FileReader();
  r.onload = function(ev) {
    meEditAvatarData = ev.target.result;
    document.getElementById('meEditAvatarPreview').innerHTML = '<img src="' + meEditAvatarData + '">';};
  r.readAsDataURL(f); e.target.value = '';
});

document.getElementById('meGenderSelector').addEventListener('click', function(e) {
  var o = e.target.closest('.gender-option'); if (!o) return;
  document.querySelectorAll('#meGenderSelector .gender-option').forEach(function(el) { el.classList.remove('selected'); });
  o.classList.add('selected');
  meEditGender = o.getAttribute('data-gender');
});

document.getElementById('btnSaveMeEdit').addEventListener('click', function() {
  myProfile.name = document.getElementById('meEditName').value.trim();
  myProfile.gender = meEditGender;
  myProfile.persona = document.getElementById('meEditPersona').value.trim();
  if (meEditAvatarData !== undefined) myProfile.avatar = meEditAvatarData;
  saveMyProfile();
  renderMePage();
  document.getElementById('meEditModal').classList.remove('active');
});
// ========== 面具管理功能 ==========

// 获取当前使用的面具
function getCurrentMask() {
  if (!currentMaskId) return null;
  return masks.find(function(m) { return m.id === currentMaskId; });
}

// 获取指定面具
function getMask(id) {
  return masks.find(function(m) { return m.id === id; });
}

// 获取角色绑定的面具，如果没绑定则返回当前面具或默认信息
function getMaskForContact(contact) {
  if (contact.maskId) {
    var mask = getMask(contact.maskId);
    if (mask) return mask;
  }
  // 没有绑定面具，使用当前面具
  var current = getCurrentMask();
  if (current) return current;
  // 都没有，返回默认的myProfile
  return {
    id: null,
    name: '默认',
    nickname: myProfile.name,
    gender: myProfile.gender,
    persona: myProfile.persona,
    avatar: myProfile.avatar
  };
}

// 打开面具管理弹窗
document.getElementById('btnManageMasks').addEventListener('click', function() {
  renderMaskList();
  document.getElementById('maskManagerModal').classList.add('active');
});

// 关闭面具管理弹窗
document.getElementById('btnCloseMaskManager').addEventListener('click', function() {
  document.getElementById('maskManagerModal').classList.remove('active');
});
document.getElementById('maskManagerModal').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('active');
});

// 渲染面具列表
function renderMaskList() {
  var list = document.getElementById('maskList');
  
  // 先显示默认面具（来自myProfile）
  var defaultSelected = !currentMaskId;
  var defaultHtml = '<div class="mask-item' + (defaultSelected ? ' selected' : '') + '" data-id="default" style="' +
    'display:flex;align-items:center;gap:12px;padding:12px 14px;border:1.5px solid ' + (defaultSelected ? 'var(--accent)' : 'var(--border)') + ';' +
    'border-radius:var(--radius-sm);background:' + (defaultSelected ? 'var(--accent-light)' : 'var(--bg)') + ';cursor:pointer;transition:all 0.2s;">' +
    '<div style="width:42px;height:42px;border-radius:12px;background:var(--card);display:flex;align-items:center;justify-content:center;overflow:hidden;font-size:16px;font-weight:600;color:var(--text-hint);">' +
    (myProfile.avatar ? '<img src="' + myProfile.avatar + '" style="width:100%;height:100%;object-fit:cover;">' : esc(myProfile.name ? myProfile.name.charAt(0) : '默')) +
    '</div>' +
    '<div style="flex:1;min-width:0;">' +
    '<div style="font-size:14px;font-weight:600;color:var(--text);">默认身份</div>' +
    '<div style="font-size:12px;color:var(--text-sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + esc(myProfile.name || '未设置昵称') + '</div>' +
    '</div>' +
    (defaultSelected ? '<div style="color:var(--accent);font-size:12px;font-weight:600;">使用中</div>' : '') +
    '</div>';
  
  // 其他面具
  var masksHtml = masks.map(function(mask) {
    var isSelected = mask.id === currentMaskId;
    var av = mask.avatar ? '<img src="' + mask.avatar + '" style="width:100%;height:100%;object-fit:cover;">' : esc(mask.nickname ? mask.nickname.charAt(0) : mask.name.charAt(0));
    return '<div class="mask-item' + (isSelected ? ' selected' : '') + '" data-id="' + mask.id + '" style="' +
      'display:flex;align-items:center;gap:12px;padding:12px 14px;border:1.5px solid ' + (isSelected ? 'var(--accent)' : 'var(--border)') + ';' +
      'border-radius:var(--radius-sm);background:' + (isSelected ? 'var(--accent-light)' : 'var(--bg)') + ';cursor:pointer;transition:all 0.2s;">' +
      '<div style="width:42px;height:42px;border-radius:12px;background:var(--card);display:flex;align-items:center;justify-content:center;overflow:hidden;font-size:16px;font-weight:600;color:var(--text-hint);">' + av + '</div>' +
      '<div style="flex:1;min-width:0;">' +
      '<div style="font-size:14px;font-weight:600;color:var(--text);">' + esc(mask.name) + '</div>' +
      '<div style="font-size:12px;color:var(--text-sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + esc(mask.nickname || '未设置昵称') + '</div>' +
      '</div>' +
      (isSelected ? '<div style="color:var(--accent);font-size:12px;font-weight:600;">使用中</div>' : '') +
      '<div style="display:flex;gap:4px;">' +
      '<button class="btn-edit-mask" data-id="' + mask.id + '" style="width:28px;height:28px;border:none;border-radius:8px;background:var(--card);display:flex;align-items:center;justify-content:center;cursor:pointer;">' +
      '<svg width="12" height="12" viewBox="0 0 14 14" fill="none"><path d="M8.5 2.5l3 3M1 10l7-7 3 3-7 7H1v-3z" stroke="#999" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg></button>' +
      '<button class="btn-delete-mask" data-id="' + mask.id + '" style="width:28px;height:28px;border:none;border-radius:8px;background:var(--card);display:flex;align-items:center;justify-content:center;cursor:pointer;">' +
      '<svg width="12" height="12" viewBox="0 0 14 14" fill="none"><path d="M2 4h10M5 4V3a1 1 0 011-1h2a1 1 0 011 1v1M11 4v7a2 2 0 01-2 2H5a2 2 0 01-2-2V4" stroke="#e06060" stroke-width="1.3" stroke-linecap="round"/></svg></button>' +
      '</div></div>';
  }).join('');
  
  list.innerHTML = defaultHtml + masksHtml;
  
  // 绑定点击选择事件
  list.querySelectorAll('.mask-item').forEach(function(item) {
    item.addEventListener('click', function(e) {
      if (e.target.closest('.btn-edit-mask') || e.target.closest('.btn-delete-mask')) return;
      var id = item.getAttribute('data-id');
      if (id === 'default') {
        currentMaskId = null;
      } else {
        currentMaskId = id;
      }
      saveCurrentMaskId();
      renderMaskList();
      renderMePage();
    });
  });
  
  // 绑定编辑按钮
  list.querySelectorAll('.btn-edit-mask').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      openMaskEditor(btn.getAttribute('data-id'));
    });
  });
  
  // 绑定删除按钮
  list.querySelectorAll('.btn-delete-mask').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      var id = btn.getAttribute('data-id');
      if (confirm('确定删除这个面具吗？')) {
        masks = masks.filter(function(m) { return m.id !== id; });
        if (currentMaskId === id) {
          currentMaskId = null;
          saveCurrentMaskId();
        }
        saveMasks();
        renderMaskList();
        renderMePage();
      }
    });
  });
}

// 新建面具
document.getElementById('btnNewMask').addEventListener('click', function() {
  openMaskEditor(null);
});

// 打开面具编辑器
function openMaskEditor(id) {
  editingMaskId = id;
  maskEditAvatarData = null;
  maskEditGender = null;
  
  if (id) {
    var mask = getMask(id);
    if (mask) {
      document.getElementById('maskEditTitle').textContent = '编辑面具';
      document.getElementById('maskEditName').value = mask.name || '';
      document.getElementById('maskEditNickname').value = mask.nickname || '';
      document.getElementById('maskEditPersona').value = mask.persona || '';
      maskEditAvatarData = mask.avatar;
      maskEditGender = mask.gender;
      
      var prev = document.getElementById('maskEditAvatarPreview');
      if (mask.avatar) {
        prev.innerHTML = '<img src="' + mask.avatar + '">';
      } else {
        prev.innerHTML = '<span class="placeholder-icon"><svg width="28" height="28" viewBox="0 0 32 32" fill="none"><path d="M16 8v16M8 16h16" stroke="#bbb" stroke-width="2.5" stroke-linecap="round"/></svg></span>';
      }
      
      document.querySelectorAll('#maskEditGenderSelector .gender-option').forEach(function(el) {
        el.classList.toggle('selected', el.getAttribute('data-gender') === mask.gender);
      });
    }
  } else {
    document.getElementById('maskEditTitle').textContent = '新建面具';
    document.getElementById('maskEditName').value = '';
    document.getElementById('maskEditNickname').value = '';
    document.getElementById('maskEditPersona').value = '';
    document.getElementById('maskEditAvatarPreview').innerHTML = '<span class="placeholder-icon"><svg width="28" height="28" viewBox="0 0 32 32" fill="none"><path d="M16 8v16M8 16h16" stroke="#bbb" stroke-width="2.5" stroke-linecap="round"/></svg></span>';
    document.querySelectorAll('#maskEditGenderSelector .gender-option').forEach(function(el) {
      el.classList.remove('selected');
    });
  }
  
  document.getElementById('maskEditModal').classList.add('active');
}

// 关闭面具编辑弹窗
document.getElementById('btnCloseMaskEdit').addEventListener('click', function() {
  document.getElementById('maskEditModal').classList.remove('active');
});
document.getElementById('maskEditModal').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('active');
});

// 面具头像上传
document.getElementById('maskEditAvatarPreview').addEventListener('click', function() {
  document.getElementById('maskEditAvatarInput').click();
});
document.getElementById('maskEditAvatarInput').addEventListener('change', function(e) {
  var f = e.target.files[0];
  if (!f) return;
  var r = new FileReader();
  r.onload = function(ev) {
    maskEditAvatarData = ev.target.result;
    document.getElementById('maskEditAvatarPreview').innerHTML = '<img src="' + maskEditAvatarData + '">';
  };
  r.readAsDataURL(f);
  e.target.value = '';
});

// 面具性别选择
document.getElementById('maskEditGenderSelector').addEventListener('click', function(e) {
  var o = e.target.closest('.gender-option');
  if (!o) return;
  document.querySelectorAll('#maskEditGenderSelector .gender-option').forEach(function(el) {
    el.classList.remove('selected');
  });
  o.classList.add('selected');
  maskEditGender = o.getAttribute('data-gender');
});

// 保存面具
document.getElementById('btnSaveMask').addEventListener('click', function() {
  var name = document.getElementById('maskEditName').value.trim();
  var nickname = document.getElementById('maskEditNickname').value.trim();
  var persona = document.getElementById('maskEditPersona').value.trim();
  
  if (!name) {
    alert('请输入面具名称');
    return;
  }
  
  if (editingMaskId) {
    // 编辑现有面具
    var idx = masks.findIndex(function(m) { return m.id === editingMaskId; });
    if (idx !== -1) {
      masks[idx].name = name;
      masks[idx].nickname = nickname;
      masks[idx].gender = maskEditGender;
      masks[idx].persona = persona;
      if (maskEditAvatarData !== null) masks[idx].avatar = maskEditAvatarData;
    }
  } else {
    // 新建面具
    masks.push({
      id: gid(),
      name: name,
      nickname: nickname,
      gender: maskEditGender,
      persona: persona,
      avatar: maskEditAvatarData,
      createdAt: Date.now()
    });
  }
  
  saveMasks();
  document.getElementById('maskEditModal').classList.remove('active');
  renderMaskList();
  renderMePage();
});
// ========== 面具绑定选择器 ==========
function renderMaskBindingSelector(contact) {
  var selector = document.getElementById('maskBindingSelector');
  var currentBinding = contact.maskId || 'default';
  
  // 默认选项（跟随当前面具）
  var html = '<div class="mask-bind-option" data-mask-id="default" style="' +
    'display:flex;align-items:center;gap:10px;padding:10px 12px;border:1.5px solid ' + (currentBinding === 'default' ? 'var(--accent)' : 'var(--border)') + ';' +
    'border-radius:var(--radius-sm);background:' + (currentBinding === 'default' ? 'var(--accent-light)' : 'var(--bg)') + ';cursor:pointer;">' +
    '<div style="width:18px;height:18px;border-radius:50%;border:2px solid ' + (currentBinding === 'default' ? 'var(--accent)' : 'var(--text-hint)') + ';display:flex;align-items:center;justify-content:center;">' +
    (currentBinding === 'default' ? '<div style="width:10px;height:10px;border-radius:50%;background:var(--accent);"></div>' : '') +
    '</div>' +
    '<div style="flex:1;">' +
    '<div style="font-size:13px;font-weight:600;color:var(--text);">跟随当前面具</div>' +
    '<div style="font-size:11px;color:var(--text-sub);">使用"我的"页面选中的面具</div>' +
    '</div></div>';
  
  // 默认身份选项
  var isDefaultProfile = currentBinding === 'profile';
  html += '<div class="mask-bind-option" data-mask-id="profile" style="' +
    'display:flex;align-items:center;gap:10px;padding:10px 12px;border:1.5px solid ' + (isDefaultProfile ? 'var(--accent)' : 'var(--border)') + ';' +
    'border-radius:var(--radius-sm);background:' + (isDefaultProfile ? 'var(--accent-light)' : 'var(--bg)') + ';cursor:pointer;">' +
    '<div style="width:18px;height:18px;border-radius:50%;border:2px solid ' + (isDefaultProfile ? 'var(--accent)' : 'var(--text-hint)') + ';display:flex;align-items:center;justify-content:center;">' +
    (isDefaultProfile ? '<div style="width:10px;height:10px;border-radius:50%;background:var(--accent);"></div>' : '') +
    '</div>' +
    '<div style="width:32px;height:32px;border-radius:10px;background:var(--card);display:flex;align-items:center;justify-content:center;overflow:hidden;font-size:12px;font-weight:600;color:var(--text-hint);">' +
    (myProfile.avatar ? '<img src="' + myProfile.avatar + '" style="width:100%;height:100%;object-fit:cover;">' : esc(myProfile.name ? myProfile.name.charAt(0) : '默')) +
    '</div>' +
    '<div style="flex:1;">' +
    '<div style="font-size:13px;font-weight:600;color:var(--text);">默认身份</div>' +
    '<div style="font-size:11px;color:var(--text-sub);">' + esc(myProfile.name || '未设置') + '</div>' +
    '</div></div>';
  
  // 其他面具选项
  masks.forEach(function(mask) {
    var isSelected = currentBinding === mask.id;
    var av = mask.avatar ? '<img src="' + mask.avatar + '" style="width:100%;height:100%;object-fit:cover;">' : esc(mask.nickname ? mask.nickname.charAt(0) : mask.name.charAt(0));
    html += '<div class="mask-bind-option" data-mask-id="' + mask.id + '" style="' +
      'display:flex;align-items:center;gap:10px;padding:10px 12px;border:1.5px solid ' + (isSelected ? 'var(--accent)' : 'var(--border)') + ';' +
      'border-radius:var(--radius-sm);background:' + (isSelected ? 'var(--accent-light)' : 'var(--bg)') + ';cursor:pointer;">' +
      '<div style="width:18px;height:18px;border-radius:50%;border:2px solid ' + (isSelected ? 'var(--accent)' : 'var(--text-hint)') + ';display:flex;align-items:center;justify-content:center;">' +
      (isSelected ? '<div style="width:10px;height:10px;border-radius:50%;background:var(--accent);"></div>' : '') +
      '</div>' +
      '<div style="width:32px;height:32px;border-radius:10px;background:var(--card);display:flex;align-items:center;justify-content:center;overflow:hidden;font-size:12px;font-weight:600;color:var(--text-hint);">' + av + '</div>' +
      '<div style="flex:1;">' +
      '<div style="font-size:13px;font-weight:600;color:var(--text);">' + esc(mask.name) + '</div>' +
      '<div style="font-size:11px;color:var(--text-sub);">' + esc(mask.nickname || '未设置昵称') + '</div>' +
      '</div></div>';
  });
  
  selector.innerHTML = html;
  
  // 绑定点击事件
  selector.querySelectorAll('.mask-bind-option').forEach(function(opt) {
    opt.addEventListener('click', function() {
      var maskId = opt.getAttribute('data-mask-id');
      var c = getContact(currentChatId);
      if (!c) return;
      
      if (maskId === 'default') {
        c.maskId = null; // 跟随当前面具
      } else if (maskId === 'profile') {
        c.maskId = 'profile'; // 固定使用默认身份
      } else {
        c.maskId = maskId; // 绑定特定面具
      }
      saveContacts();
      renderMaskBindingSelector(c);
    });
  });
}

// ========== 添加联系人弹窗 ==========
var addModal = document.getElementById('addContactModal');
document.getElementById('btnAddContact').addEventListener('click', function() { resetContactForm(); addModal.classList.add('active'); });
document.getElementById('btnCloseModal').addEventListener('click', function() { addModal.classList.remove('active'); });
addModal.addEventListener('click', function(e) { if (e.target === addModal) addModal.classList.remove('active'); });

function resetContactForm() {
  document.getElementById('inputName').value = '';
  document.getElementById('inputPersona').value = '';
  currentAvatarData = null; selectedGender = null; selectedApiId = null;
  document.getElementById('avatarPreview').innerHTML = '<span class="placeholder-icon"><svg width="28" height="28" viewBox="0 0 32 32" fill="none"><path d="M16 8v16M8 16h16" stroke="#bbb" stroke-width="2.5" stroke-linecap="round"/></svg></span>';
  document.querySelectorAll('#genderSelector .gender-option').forEach(function(el) { el.classList.remove('selected'); });
  document.getElementById('selectedApiLabel').textContent = '未配置';
}

document.getElementById('avatarPreview').addEventListener('click', function() { document.getElementById('avatarInput').click(); });
document.getElementById('avatarInput').addEventListener('change', function(e) {
  var f = e.target.files[0]; if (!f) return;
  var r = new FileReader();
  r.onload = function(ev) { currentAvatarData = ev.target.result; document.getElementById('avatarPreview').innerHTML = '<img src="' + currentAvatarData + '">'; };
  r.readAsDataURL(f); e.target.value = '';
});

document.getElementById('genderSelector').addEventListener('click', function(e) {
  var o = e.target.closest('.gender-option'); if (!o) return;
  document.querySelectorAll('#genderSelector .gender-option').forEach(function(el) { el.classList.remove('selected'); });
  o.classList.add('selected'); selectedGender = o.getAttribute('data-gender');
});

document.getElementById('btnSaveContact').addEventListener('click', function() {
  var name = document.getElementById('inputName').value.trim();
  var persona = document.getElementById('inputPersona').value.trim();
  if (!name) { alert('请输入昵称'); return; }
  contacts.push({ id: gid(), name: name, gender: selectedGender, persona: persona, avatar: currentAvatarData, apiId: selectedApiId, messages: [], banner: '', createdAt: Date.now() });
  saveContacts(); renderContactList(); addModal.classList.remove('active');
});

// ========== API 页面 ==========
document.getElementById('btnOpenApiPage').addEventListener('click', function() { renderApiList(); document.getElementById('apiPage').classList.add('active'); });
document.getElementById('btnBackFromApi').addEventListener('click', function() { document.getElementById('apiPage').classList.remove('active'); });

function renderApiList() {
  var list = document.getElementById('apiSavedList');
  if (apiConfigs.length === 0) { list.innerHTML = ''; return; }
  list.innerHTML = apiConfigs.map(function(cfg) {
    var sel = cfg.id === selectedApiId;
    return '<div class="api-saved-item' + (sel ? ' selected' : '') + '" data-id="' + cfg.id + '">' +
      '<div class="api-item-radio"></div><div class="api-item-info"><div class="api-item-name">' + esc(cfg.name) + '</div>' +
      '<div class="api-item-detail">' + esc(cfg.format.toUpperCase() + ' · ' + cfg.model) + '</div></div>' +
      '<div class="api-item-actions">' +
      '<button class="btn-api-action edit" data-id="' + cfg.id + '"><svg width="12" height="12" viewBox="0 0 14 14" fill="none"><path d="M8.5 2.5l3 3M1 10l7-7 3 3-7 7H1v-3z" stroke="#999" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg></button>' +
      '<button class="btn-api-action delete" data-id="' + cfg.id + '"><svg width="12" height="12" viewBox="0 0 14 14" fill="none"><path d="M2 4h10M5 4V3a1 1 0 011-1h2a1 1 0 011 1v1M11 4v7a2 2 0 01-2 2H5a2 2 0 01-2-2V4" stroke="#e06060" stroke-width="1.3" stroke-linecap="round"/></svg></button></div></div>';
  }).join('');

  list.querySelectorAll('.api-saved-item').forEach(function(item) {
    item.addEventListener('click', function(e) {
      if (e.target.closest('.btn-api-action')) return;
      selectedApiId = item.getAttribute('data-id');
      var cfg = apiConfigs.find(function(c) { return c.id === selectedApiId; });
      document.getElementById('selectedApiLabel').textContent = cfg ? cfg.name : '未配置';
      renderApiList();
    });
  });list.querySelectorAll('.btn-api-action.edit').forEach(function(b) { b.addEventListener('click', function() { openApiEditor(b.getAttribute('data-id')); }); });
  list.querySelectorAll('.btn-api-action.delete').forEach(function(b) {
    b.addEventListener('click', function() {
      var id = b.getAttribute('data-id');
      if (confirm('确定删除？')) { apiConfigs = apiConfigs.filter(function(c) { return c.id !== id; }); saveApiConfigs(); if (selectedApiId === id) { selectedApiId = null; document.getElementById('selectedApiLabel').textContent = '未配置'; } renderApiList(); }
    });
  });
}

var currentFormat = 'openai';
document.getElementById('btnNewApi').addEventListener('click', function() { openApiEditor(null); });
document.getElementById('btnBackFromApiEdit').addEventListener('click', function() { document.getElementById('apiEditPage').classList.remove('active'); });

function openApiEditor(id) {
  editingApiId = id;
  if (id) {
    var cfg = apiConfigs.find(function(c) { return c.id === id; });
    document.getElementById('apiEditTitle').textContent = '编辑配置';
    document.getElementById('inputApiName').value = cfg.name;
    document.getElementById('inputApiBase').value = cfg.base;
    document.getElementById('inputApiKey').value = cfg.key;
    document.getElementById('inputModelName').value = cfg.model;
    setFmt(cfg.format);
  } else {
    document.getElementById('apiEditTitle').textContent = '新建配置';
    document.getElementById('inputApiName').value = '';
    document.getElementById('inputApiBase').value = '';
    document.getElementById('inputApiKey').value = '';
    document.getElementById('inputModelName').value = '';
    setFmt('openai');
  }
  resetTestBtn(); document.getElementById('apiEditPage').classList.add('active');
}

document.getElementById('formatSelector').addEventListener('click', function(e) {
  var o = e.target.closest('.format-option'); if (!o) return; setFmt(o.getAttribute('data-format'));
});
function setFmt(f) { currentFormat = f; document.querySelectorAll('#formatSelector .format-option').forEach(function(el) { el.classList.toggle('selected', el.getAttribute('data-format') === f); }); }

document.getElementById('btnSaveApi').addEventListener('click', function() {
  var n = document.getElementById('inputApiName').value.trim();
  var b = document.getElementById('inputApiBase').value.trim();
  var k = document.getElementById('inputApiKey').value.trim();
  var m = document.getElementById('inputModelName').value.trim();
  if (!n||!b||!k||!m) { alert('请填写完整'); return; }
  if (editingApiId) {
    var idx = apiConfigs.findIndex(function(c) { return c.id === editingApiId; });
    if (idx !== -1) apiConfigs[idx] = { id: editingApiId, name: n, format: currentFormat, base: b, key: k, model: m };} else {
    apiConfigs.push({ id: gid(), name: n, format: currentFormat, base: b, key: k, model: m });
  }
  saveApiConfigs(); document.getElementById('apiEditPage').classList.remove('active'); renderApiList();
});

document.getElementById('btnTestApi').addEventListener('click', function() {
  var b = document.getElementById('inputApiBase').value.trim();
  var k = document.getElementById('inputApiKey').value.trim();
  var m = document.getElementById('inputModelName').value.trim();
  var btn = document.getElementById('btnTestApi');
  if (!b||!k||!m) { alert('请先填写完整'); return; }
  btn.className = 'btn-test testing'; btn.innerHTML = '<div class="spinner"></div> 测试中...';
  if (currentFormat === 'openai') testOAI(b, k, m, btn); else testGem(b, k, m, btn);
});

function testOAI(base, key, model, btn) {
  var url = base.replace(/\/+$/, '');
  url = url.endsWith('/v1') ? url + '/chat/completions' : url + '/v1/chat/completions';
  fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key }, body: JSON.stringify({ model: model, messages: [{ role: 'user', content: 'Hi' }], max_tokens: 5 }) })
  .then(function(r) { if (r.ok) { btn.className = 'btn-test success'; btn.innerHTML = '✓ 连接成功'; } else throw new Error(); })
  .catch(function() { btn.className = 'btn-test fail'; btn.innerHTML = '✗ 连接失败'; });
}

function testGem(base, key, model, btn) {
  var url = base.replace(/\/+$/, '') + '/v1beta/models/' + model + ':generateContent?key=' + key;
  fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: 'Hi' }] }], generationConfig: { maxOutputTokens: 5 } }) })
  .then(function(r) { if (r.ok) { btn.className = 'btn-test success'; btn.innerHTML = '✓ 连接成功'; } else throw new Error(); })
  .catch(function() { btn.className = 'btn-test fail'; btn.innerHTML = '✗ 连接失败'; });
}

function resetTestBtn() { var b = document.getElementById('btnTestApi'); b.className = 'btn-test'; b.innerHTML = '测试连接'; }

// ========== 聊天室 ==========
function getContact(id) { return contacts.find(function(c) { return c.id === id; }); }

function openChat(id) {
  currentChatId = id;
  var c = getContact(id);
  if (!c) return;

  var avEl = document.getElementById('chatHeaderAvatar');
  avEl.innerHTML = c.avatar ? '<img src="' + c.avatar + '">' : esc(c.name.charAt(0));
  document.getElementById('chatHeaderName').textContent = c.remark || c.name;
  document.getElementById('chatHeaderStatus').textContent = '在线';
  document.getElementById('chatBanner').value = c.banner || '';

  applyChatBg(c);
  applyChatSize(c);
  applyBubbleColors(c);

  renderMessages(c);
  // 先隐藏重新回复按钮，等消息渲染后再判断
document.getElementById('regenerateBtn').classList.remove('show');
document.getElementById('receiveMsgBtn').classList.remove('show');
  document.getElementById('pageChat').classList.add('active');
  setTimeout(scrollToBottom, 100);
}

document.getElementById('btnChatBack').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (c) { c.banner = document.getElementById('chatBanner').value; saveContacts(); }
  document.getElementById('pageChat').classList.remove('active');currentChatId = null;
  renderContactList();
});

// ========== 聊天设置页面 ==========
document.getElementById('btnChatSettings').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;

  // 初始化默认值
  if (c.memoryRounds === undefined) c.memoryRounds = 20;
  if (c.timeAware === undefined) c.timeAware = false;
  if (c.remark === undefined) c.remark = '';

  // 填充角色信息
  var avEl = document.getElementById('settingsAvatar');
  avEl.innerHTML = c.avatar ? '<img src="' + c.avatar + '" style="width:100%;height:100%;object-fit:cover;">' : esc(c.name.charAt(0));
  document.getElementById('settingsName').textContent = c.name;
  var gMap = { male: '男生', female: '女生', other: '其他' };
  document.getElementById('settingsGender').textContent = gMap[c.gender] || '未设置性别';

  // 记忆轮数
  document.getElementById('memoryVal').textContent = c.memoryRounds === 0 ? '全部' : c.memoryRounds;

  // 时间感知
  var toggle = document.getElementById('toggleTimeAware');
  toggle.classList.toggle('on', c.timeAware);
  // 朋友圈记忆
  if (c.momentsMemory === undefined) c.momentsMemory = false;
  var toggleMM = document.getElementById('toggleMomentsMemory');
  toggleMM.classList.toggle('on', c.momentsMemory);

  // 备注
  document.getElementById('remarkInput').value = c.remark || '';
  
    document.getElementById('remarkDisplay').textContent = c.remark ? '备注名：' + c.remark : '暂无备注（显示原昵称）';

  updateBgPreview(c);
    // 气泡颜色
  document.getElementById('myBubbleColor').value = c.bubbleMe || '#7eb8b4';
  document.getElementById('myBubbleDot').style.background = c.bubbleMe || '#7eb8b4';
  document.getElementById('otherBubbleColor').value = c.bubbleOther || '#ffffff';
  document.getElementById('otherBubbleDot').style.background = c.bubbleOther || '#ffffff';

  // 布局大小
  var currentSize = c.chatSize || 'default';
  document.querySelectorAll('#sizeSelector .size-option').forEach(function(el) {
    el.classList.toggle('selected', el.getAttribute('data-size') === currentSize);
  });
// 渲染面具绑定选择器
renderMaskBindingSelector(c);

  document.getElementById('chatSettingsPage').classList.add('active');
});

document.getElementById('btnBackFromSettings').addEventListener('click', function() {
  document.getElementById('chatSettingsPage').classList.remove('active');
});

// 编辑角色按钮（从设置页进入）
document.getElementById('btnEditCharacter').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;

  chatEditAvatarData = c.avatar;
  chatEditGender = c.gender;
  document.getElementById('chatEditName').value = c.name || '';
  document.getElementById('chatEditPersona').value = c.persona || '';

  var prev = document.getElementById('chatEditAvatarPreview');
  if (c.avatar) {
    prev.innerHTML = '<img src="' + c.avatar + '">';
  } else {
    prev.innerHTML = '<span class="placeholder-icon"><svg width="28" height="28" viewBox="0 0 32 32" fill="none"><path d="M16 8v16M8 16h16" stroke="#bbb" stroke-width="2.5" stroke-linecap="round"/></svg></span>';
  }

  document.querySelectorAll('#chatEditGenderSelector .gender-option').forEach(function(el) {
    el.classList.toggle('selected', el.getAttribute('data-gender') === c.gender);
  });

  document.getElementById('chatEditOverlay').classList.add('active');
});

// 记忆轮数
document.getElementById('btnMemMinus').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  if (c.memoryRounds === undefined) c.memoryRounds = 20;
  c.memoryRounds = Math.max(0, c.memoryRounds - 5);
  document.getElementById('memoryVal').textContent = c.memoryRounds === 0 ? '全部' : c.memoryRounds;saveContacts();
});

document.getElementById('btnMemPlus').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  if (c.memoryRounds === undefined) c.memoryRounds = 20;
  c.memoryRounds = Math.min(200, c.memoryRounds + 5);
  document.getElementById('memoryVal').textContent = c.memoryRounds;
  saveContacts();
});

// 时间感知开关
document.getElementById('toggleTimeAware').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  c.timeAware = !c.timeAware;
  this.classList.toggle('on', c.timeAware);
  saveContacts();
});
// 朋友圈记忆开关
document.getElementById('toggleMomentsMemory').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  c.momentsMemory = !c.momentsMemory;
  this.classList.toggle('on', c.momentsMemory);
  saveContacts();
});

// 备注保存
document.getElementById('btnSaveRemark').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  c.remark = document.getElementById('remarkInput').value.trim();
  saveContacts();
  document.getElementById('remarkDisplay').textContent = c.remark ? '备注名：' + c.remark : '暂无备注（显示原昵称）';

  // 更新聊天室头部显示名
  document.getElementById('chatHeaderName').textContent = c.remark || c.name;

  // 更新设置页显示名
  document.getElementById('settingsName').textContent = c.remark || c.name;

  alert('备注已保存');
});

// ========== 搜索聊天记录 ==========
document.getElementById('btnOpenSearch').addEventListener('click', function() {
  document.getElementById('searchInput').value = '';
  document.getElementById('searchResults').innerHTML = '<div class="search-empty">输入关键词搜索</div>';
  document.getElementById('searchPage').classList.add('active');
  setTimeout(function() { document.getElementById('searchInput').focus(); }, 300);
});

document.getElementById('btnBackFromSearch').addEventListener('click', function() {
  document.getElementById('searchPage').classList.remove('active');
});

document.getElementById('btnSearchCancel').addEventListener('click', function() {
  document.getElementById('searchPage').classList.remove('active');
});

document.getElementById('searchInput').addEventListener('input', function() {
  var keyword = this.value.trim().toLowerCase();
  var c = getContact(currentChatId);
  var results = document.getElementById('searchResults');

  if (!keyword || !c || !c.messages.length) {
    results.innerHTML = '<div class="search-empty">' + (!keyword ? '输入关键词搜索' : '没有找到相关消息') + '</div>';
    return;
  }

  var matches = [];
  c.messages.forEach(function(msg) {
    if (msg.text.toLowerCase().indexOf(keyword) !== -1) {
      matches.push(msg);
    }
  });

  if (matches.length === 0) {
    results.innerHTML = '<div class="search-empty">没有找到相关消息</div>';
    return;
  }

  results.innerHTML = matches.map(function(msg) {
    var isMe = msg.role === 'user';
    var highlighted = esc(msg.text).replace(new RegExp('(' + escRegex(esc(keyword)) + ')', 'gi'), '<mark>$1</mark>');
    return '<div class="search-result-item">' +
      '<div class="search-result-role">' + (isMe ? (myProfile.name || '我') : c.name) + '</div>' +
      '<div class="search-result-text">' + highlighted + '</div>' +
      '<div class="search-result-time">' + fmtDate(msg.ts) + ' ' + fmtTime(msg.ts) + '</div></div>';
  }).join('');
});

function escRegex(s) {
  return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// ========== 批量删除消息 ==========
var batchSelectedIds = new Set();

document.getElementById('btnOpenBatchDelete').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c || !c.messages.length) { alert('没有消息可以删除'); return; }

  batchSelectedIds = new Set();
  renderBatchList(c);
  document.getElementById('batchDeletePage').classList.add('active');
});

document.getElementById('btnBackFromBatch').addEventListener('click', function() {
  document.getElementById('batchDeletePage').classList.remove('active');
});

function renderBatchList(c) {
  var body = document.getElementById('batchDeleteBody');
  document.getElementById('batchCountLabel').textContent = '共 ' + c.messages.length + ' 条消息';
  updateDeleteBtn();

  body.innerHTML = c.messages.map(function(msg, idx) {
    var isMe = msg.role === 'user';
    var selected = batchSelectedIds.has(idx);
    var textPreview = msg.text.length > 80 ? msg.text.substring(0, 80) + '...' : msg.text;
    return '<div class="batch-msg-item' + (selected ? ' selected' : '') + '" data-idx="' + idx + '">' +
      '<div class="batch-checkbox">' + (selected ? '<svg width="12" height="12" viewBox="0 0 16 16" fill="none"><path d="M3 8l3.5 3.5L13 5" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : '') + '</div>' +
      '<div class="batch-msg-body">' +
      '<div class="batch-msg-role">' + (isMe ? (myProfile.name || '我') : c.name) + '</div>' +
      '<div class="batch-msg-text">' + esc(textPreview) + '</div>' +
      '<div class="batch-msg-time">' + fmtTime(msg.ts) + '</div>' +
      '</div></div>';
  }).join('');

  body.querySelectorAll('.batch-msg-item').forEach(function(el) {
    el.addEventListener('click', function() {
      var idx = parseInt(el.getAttribute('data-idx'));
      if (batchSelectedIds.has(idx)) {
        batchSelectedIds.delete(idx);
      } else {
        batchSelectedIds.add(idx);
      }
      renderBatchList(c);
    });
  });
}

function updateDeleteBtn() {
  var btn = document.getElementById('btnConfirmDelete');
  var count = batchSelectedIds.size;
  btn.textContent = '删除 (' + count + ')';
  btn.disabled = count === 0;
}

// 全选
document.getElementById('btnSelectAll').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;

  if (batchSelectedIds.size === c.messages.length) {
    // 已全选，取消全选
    batchSelectedIds = new Set();
  } else {
    batchSelectedIds = new Set();
    c.messages.forEach(function(_, idx) { batchSelectedIds.add(idx); });
  }
  renderBatchList(c);
});

// 确认删除
document.getElementById('btnConfirmDelete').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c || batchSelectedIds.size === 0) return;

  if (!confirm('确定删除选中的 ' + batchSelectedIds.size + ' 条消息吗？')) return;

  // 从后往前删，避免索引错乱
  var indices = Array.from(batchSelectedIds).sort(function(a, b) { return b - a; });
  indices.forEach(function(idx) {
    c.messages.splice(idx, 1);
  });

  saveContacts();
  batchSelectedIds = new Set();
  renderBatchList(c);

  if (c.messages.length === 0) {
    document.getElementById('batchDeletePage').classList.remove('active');
  }

  // 更新聊天室消息
  renderMessages(c);
  scrollToBottom();
});
// ========== 导出全部数据 ==========
document.getElementById('btnExportData').addEventListener('click', function() {
  // 收集所有数据
  var exportObj = {
  version: 1,
  exportTime: Date.now(),
  contacts: contacts,
  apiConfigs: apiConfigs,
  myProfile: myProfile,
  moments: moments,
  masks: masks,
  currentMaskId: currentMaskId,
  forums: forums
};


  var jsonStr = JSON.stringify(exportObj, null, 2);
  var blob = new Blob([jsonStr], { type: 'application/json' });

  // 生成文件名
  var now = new Date();
  var timeStr = now.getFullYear() +
    ('0' + (now.getMonth() + 1)).slice(-2) +
    ('0' + now.getDate()).slice(-2) + '_' +
    ('0' + now.getHours()).slice(-2) +
    ('0' + now.getMinutes()).slice(-2) +
    ('0' + now.getSeconds()).slice(-2);
  var fileName = '11聊天器存档（' + timeStr + '）.json';

  // 下载
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);URL.revokeObjectURL(a.href);

  alert('导出成功！');
});
// ========== 消息弹窗通知功能 ==========

var notificationQueue = [];
var isShowingNotification = false;

// 显示通知
function showNotification(options) {
  /*
    options: {
      type: 'message' | 'moments' | 'forum',
      avatar: '头像URL或null',
      avatarText: '头像文字（无图片时显示）',
      title: '标题（发送者名字）',
      text: '内容预览',
      appName: '应用名称',
      onClick: 点击回调函数,
      duration: 显示时长（毫秒，默认4000）
    }
  */
  
  notificationQueue.push(options);
  processNotificationQueue();
}

function processNotificationQueue() {
  if (isShowingNotification || notificationQueue.length === 0) return;
  
  isShowingNotification = true;
  var options = notificationQueue.shift();
  
  var container = document.getElementById('notificationContainer');
  
  // 创建通知元素
  var toast = document.createElement('div');
  toast.className = 'notification-toast type-' + (options.type || 'message');
  
  // 头像
  var avatarContent = options.avatar 
    ? '<img src="' + options.avatar + '">' 
    : esc(options.avatarText || '?');
  
  // 图标
  var iconClass = options.type === 'moments' ? 'moments' : (options.type === 'forum' ? 'forum' : '');
  var iconEmoji = options.type === 'moments' ? '📷' : (options.type === 'forum' ? '📋' : '💬');
  
  // 应用名称
  var appName = options.appName || (options.type === 'moments' ? '朋友圈' : (options.type === 'forum' ? '论坛' : '消息'));
  
  toast.innerHTML = 
    '<div class="notification-avatar">' + avatarContent + 
    '<div class="notif-icon ' + iconClass + '">' + iconEmoji + '</div></div>' +
    '<div class="notification-body">' +
    '<div class="notification-header">' +
    '<span class="notification-app">' + esc(appName) + '</span>' +
    '<span class="notification-time">现在</span>' +
    '</div>' +
    '<div class="notification-title">' + esc(options.title || '新消息') + '</div>' +
    '<div class="notification-text">' + esc(options.text || '') + '</div>' +
    '</div>' +
    '<button class="notification-close">' +
    '<svg width="10" height="10" viewBox="0 0 14 14" fill="none">' +
    '<path d="M1 1l12 12M13 1L1 13" stroke="#999" stroke-width="2" stroke-linecap="round"/>' +
    '</svg></button>' +
    '<div class="notification-progress"></div>';
  
  container.appendChild(toast);
  
  // 触发显示动画
  requestAnimationFrame(function() {
    requestAnimationFrame(function() {
      toast.classList.add('show');
      
      // 播放声音（可选，需要用户交互后才能播放）
      // playNotificationSound();
      
      // 振动（如果支持）
      if (navigator.vibrate) {
        navigator.vibrate([50, 30, 50]);
      }
    });
  });
  
  var duration = options.duration || 4000;
  var hideTimeout;
  
  // 点击通知
  toast.addEventListener('click', function(e) {
    if (e.target.closest('.notification-close')) {
      // 点击关闭按钮
      hideNotification();
    } else {
      // 点击通知主体
      hideNotification();
      if (options.onClick) {
        setTimeout(options.onClick, 300);
      }
    }
  });
  
  // 自动隐藏
  hideTimeout = setTimeout(hideNotification, duration);
  
  function hideNotification() {
    clearTimeout(hideTimeout);
    toast.classList.remove('show');
    toast.classList.add('hiding');
    
    setTimeout(function() {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
      isShowingNotification = false;
      processNotificationQueue();
    }, 300);
  }
}

// 消息通知（角色发消息）
function notifyNewMessage(contact, messageText) {
  // 如果当前正在和这个角色聊天，不显示通知
  if (currentChatId === contact.id && document.getElementById('pageChat').classList.contains('active')) {
    return;
  }
  
  showNotification({
    type: 'message',
    avatar: contact.avatar,
    avatarText: (contact.remark || contact.name).charAt(0),
    title: contact.remark || contact.name,
    text: messageText.length > 50 ? messageText.substring(0, 50) + '...' : messageText,
    onClick: function() {
      // 点击打开聊天
      openChat(contact.id);
    }
  });
}

// 朋友圈通知
function notifyMoments(contact, action, content) {
  // action: 'post' | 'like' | 'comment'
  var text = '';
  var title = contact.remark || contact.name;
  
  if (action === 'post') {
    text = '发布了新动态：' + (content.length > 30 ? content.substring(0, 30) + '...' : content);
  } else if (action === 'like') {
    text = '赞了你的朋友圈';
  } else if (action === 'comment') {
    text = '评论了：' + (content.length > 30 ? content.substring(0, 30) + '...' : content);
  }
  
  showNotification({
    type: 'moments',
    avatar: contact.avatar,
    avatarText: title.charAt(0),
    title: title,
    text: text,
    onClick: function() {
      // 点击跳转到朋友圈
      document.querySelectorAll('.tab-item').forEach(function(el) { el.classList.remove('active'); });
      document.querySelector('[data-tab="moments"]').classList.add('active');
      document.getElementById('chatListArea').style.display = 'none';
      document.getElementById('pageDiscover').style.display = 'none';
      document.getElementById('pageMe').style.display = 'none';
      document.getElementById('pageMoments').style.display = 'flex';
      document.getElementById('pageMoments').classList.add('active');
      document.querySelector('.nav-bar .nav-title').textContent = '朋友圈';
      document.getElementById('btnAddContact').style.display = 'none';
      document.getElementById('momentFab').classList.add('show');
      renderMomentsHeader();
      renderMoments();
    }
  });
}

// 论坛通知
function notifyForum(forumName, authorName, content) {
  showNotification({
    type: 'forum',
    avatar: null,
    avatarText: forumName.charAt(0),
    appName: forumName,
    title: authorName + ' 发布了新帖子',
    text: content.length > 40 ? content.substring(0, 40) + '...' : content,
    onClick: function() {
      // 点击跳转到发现页
      document.querySelectorAll('.tab-item').forEach(function(el) { el.classList.remove('active'); });
      document.querySelector('[data-tab="discover"]').classList.add('active');
      document.getElementById('chatListArea').style.display = 'none';
      document.getElementById('pageMoments').style.display = 'none';
      document.getElementById('pageMe').style.display = 'none';
      document.getElementById('pageDiscover').style.display = 'flex';
      document.getElementById('pageDiscover').classList.add('active');
      document.querySelector('.nav-bar .nav-title').textContent = '发现';
      document.getElementById('btnAddContact').style.display = 'none';
      document.getElementById('momentFab').classList.remove('show');
    }
  });
}

// ========== 论坛功能 ==========

// 进入论坛列表页
document.getElementById('btnEnterForum').addEventListener('click', function() {
  renderForumList();
  document.getElementById('forumPage').classList.add('active');
});

// 返回发现页
document.getElementById('btnBackFromForum').addEventListener('click', function() {
  document.getElementById('forumPage').classList.remove('active');
});

// 渲染论坛列表
function renderForumList() {
  var list = document.getElementById('forumList');
  var empty = document.getElementById('forumEmpty');
  
  if (forums.length === 0) {
    empty.style.display = 'flex';
    list.innerHTML = '';
    return;
  }
  
  empty.style.display = 'none';
  list.innerHTML = forums.map(function(f) {
    var memberAvatars = '';
    var memberCount = f.members ? f.members.length : 0;
    if (f.members) {
      f.members.slice(0, 4).forEach(function(mid) {
        var c = getContact(mid);
        if (c) {
          var av = c.avatar ? '<img src="' + c.avatar + '">' : esc(c.name.charAt(0));
          memberAvatars += '<div class="member-avatar">' + av + '</div>';
        }
      });
    }
    var moreText = memberCount > 4 ? '<span class="member-more">+' + (memberCount - 4) + '</span>' : '';
    var postCount = f.posts ? f.posts.length : 0;
    
    return '<div class="forum-card" data-fid="' + f.id + '">' +
      '<div class="forum-card-banner"></div>' +
      '<div class="forum-card-content">' +
      '<div class="forum-card-title"><span class="forum-icon">' + (f.icon || '📋') + '</span>' + esc(f.name) + '</div>' +
      '<div class="forum-card-desc">' + esc(f.worldview || '暂无世界观设定') + '</div>' +
      '<div class="forum-card-meta">' +
      '<span>📝 ' + postCount + ' 帖子</span>' +
      '<span>👥 ' + memberCount + ' 成员</span>' +
      '</div>' +
      '<div class="forum-card-members">' + memberAvatars + moreText + '</div>' +
      '</div></div>';
  }).join('');
  
  // 绑定点击事件
  list.querySelectorAll('.forum-card').forEach(function(card) {
    card.addEventListener('click', function() {
      var fid = card.getAttribute('data-fid');
      openForumDetail(fid);
    });
  });
}

// 创建论坛
document.getElementById('btnCreateForum').addEventListener('click', function() {
  openForumEditor(null);
});

// 打开论坛编辑器
function openForumEditor(id) {
  editingForumId = id;
  forumSelectedMembers = new Set();
  forumSelectedApiId = null;
  
  if (id) {
    var f = forums.find(function(x) { return x.id === id; });
    if (f) {
      document.getElementById('forumEditTitle').textContent = '编辑论坛';
      document.getElementById('forumEditName').value = f.name || '';
      document.getElementById('forumEditIcon').value = f.icon || '';
      document.getElementById('forumEditWorldview').value = f.worldview || '';
      forumSelectedApiId = f.apiId;
      if (f.members) {
        f.members.forEach(function(mid) { forumSelectedMembers.add(mid); });
      }
      document.getElementById('btnDeleteForum').style.display = 'flex';
    }
  } else {
    document.getElementById('forumEditTitle').textContent = '创建论坛';
    document.getElementById('forumEditName').value = '';
    document.getElementById('forumEditIcon').value = '';
    document.getElementById('forumEditWorldview').value = '';
    document.getElementById('btnDeleteForum').style.display = 'none';
  }
  
  // 更新API显示
  var apiCfg = forumSelectedApiId ? apiConfigs.find(function(a) { return a.id === forumSelectedApiId; }) : null;
  document.getElementById('forumSelectedApiLabel').textContent = apiCfg ? apiCfg.name : '未配置';
  
  renderForumMemberSelector();
  document.getElementById('forumEditPage').classList.add('active');
}

// 渲染成员选择器
function renderForumMemberSelector() {
  var list = document.getElementById('forumMemberList');
  
  if (contacts.length === 0) {
    list.innerHTML = '<div style="font-size:12px;color:var(--text-hint);padding:10px;">还没有联系人，请先添加角色</div>';
    return;
  }
  
  list.innerHTML = contacts.map(function(c) {
    var selected = forumSelectedMembers.has(c.id);
    var av = c.avatar ? '<img src="' + c.avatar + '">' : esc(c.name.charAt(0));
    return '<div class="member-chip' + (selected ? ' selected' : '') + '" data-mid="' + c.id + '">' +
      '<div class="member-chip-avatar">' + av + '</div>' +
      '<span class="member-chip-name">' + esc(c.remark || c.name) + '</span>' +
      '</div>';
  }).join('');
  
  list.querySelectorAll('.member-chip').forEach(function(chip) {
    chip.addEventListener('click', function() {
      var mid = chip.getAttribute('data-mid');
      if (forumSelectedMembers.has(mid)) {
        forumSelectedMembers.delete(mid);
        chip.classList.remove('selected');
      } else {
        forumSelectedMembers.add(mid);
        chip.classList.add('selected');
      }
    });
  });
}

// 返回论坛列表
document.getElementById('btnBackFromForumEdit').addEventListener('click', function() {
  document.getElementById('forumEditPage').classList.remove('active');
});

// 论坛API选择
document.getElementById('btnForumApiSelect').addEventListener('click', function() {
  renderForumApiList();
  document.getElementById('forumApiPage').classList.add('active');
});

document.getElementById('btnBackFromForumApi').addEventListener('click', function() {
  document.getElementById('forumApiPage').classList.remove('active');
});

function renderForumApiList() {
  var list = document.getElementById('forumApiList');
  
  if (apiConfigs.length === 0) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-hint);font-size:13px;">还没有 API 配置</div>';
    return;
  }
  
  list.innerHTML = apiConfigs.map(function(cfg) {
    var sel = cfg.id === forumSelectedApiId;
    return '<div class="api-saved-item' + (sel ? ' selected' : '') + '" data-id="' + cfg.id + '">' +
      '<div class="api-item-radio"></div>' +
      '<div class="api-item-info">' +
      '<div class="api-item-name">' + esc(cfg.name) + '</div>' +
      '<div class="api-item-detail">' + esc(cfg.format.toUpperCase() + ' · ' + cfg.model) + '</div>' +
      '</div></div>';
  }).join('');
  
  list.querySelectorAll('.api-saved-item').forEach(function(item) {
    item.addEventListener('click', function() {
      forumSelectedApiId = item.getAttribute('data-id');
      var cfg = apiConfigs.find(function(c) { return c.id === forumSelectedApiId; });
      document.getElementById('forumSelectedApiLabel').textContent = cfg ? cfg.name : '未配置';
      document.getElementById('forumApiPage').classList.remove('active');
    });
  });
}

// 保存论坛
document.getElementById('btnSaveForum').addEventListener('click', function() {
  var name = document.getElementById('forumEditName').value.trim();
  var icon = document.getElementById('forumEditIcon').value.trim();
  var worldview = document.getElementById('forumEditWorldview').value.trim();
  
  if (!name) {
    alert('请输入论坛名称');
    return;
  }
  
  if (forumSelectedMembers.size === 0) {
    alert('请至少选择一个成员');
    return;
  }
  
  if (!forumSelectedApiId) {
    alert('请选择 API 配置');
    return;
  }
  
  if (editingForumId) {
    // 编辑现有论坛
    var idx = forums.findIndex(function(f) { return f.id === editingForumId; });
    if (idx !== -1) {
      forums[idx].name = name;
      forums[idx].icon = icon || '📋';
      forums[idx].worldview = worldview;
      forums[idx].members = Array.from(forumSelectedMembers);
      forums[idx].apiId = forumSelectedApiId;
    }
  } else {
    // 创建新论坛
    forums.push({
      id: gid(),
      name: name,
      icon: icon || '📋',
      worldview: worldview,
      members: Array.from(forumSelectedMembers),
      apiId: forumSelectedApiId,
      posts: [],
      createdAt: Date.now()
    });
  }
  
  saveForums();
  document.getElementById('forumEditPage').classList.remove('active');
  renderForumList();
});

// 删除论坛
document.getElementById('btnDeleteForum').addEventListener('click', function() {
  if (!editingForumId) return;
  if (!confirm('确定要删除这个论坛吗？所有帖子都会被删除。')) return;
  
  forums = forums.filter(function(f) { return f.id !== editingForumId; });
  saveForums();
  document.getElementById('forumEditPage').classList.remove('active');
  renderForumList();
});

// ========== 论坛详情页 ==========

function openForumDetail(fid) {
  currentForumId = fid;
  var f = forums.find(function(x) { return x.id === fid; });
  if (!f) return;
  
  document.getElementById('forumDetailTitle').textContent = (f.icon || '📋') + ' ' + f.name;
  document.getElementById('forumDetailWorldview').textContent = f.worldview || '暂无世界观设定';
  
  renderForumPosts(f);
  document.getElementById('forumDetailPage').classList.add('active');
}

document.getElementById('btnBackFromForumDetail').addEventListener('click', function() {
  document.getElementById('forumDetailPage').classList.remove('active');
  currentForumId = null;
});

// 编辑当前论坛
document.getElementById('btnEditCurrentForum').addEventListener('click', function() {
  if (currentForumId) {
    openForumEditor(currentForumId);
  }
});

// 渲染帖子列表
function renderForumPosts(forum) {
  var list = document.getElementById('forumPostList');
  
  if (!forum.posts || forum.posts.length === 0) {
    list.innerHTML = '<div class="forum-empty" style="padding:40px 20px;">' +
      '<svg width="48" height="48" viewBox="0 0 48 48" fill="none"><rect x="8" y="10" width="32" height="28" rx="4" stroke="#ccc" stroke-width="1.5"/><path d="M14 20h20M14 28h12" stroke="#ccc" stroke-width="1.5" stroke-linecap="round"/></svg>' +
      '<p>还没有帖子<br>点击上方刷新按钮生成帖子</p></div>';
    return;
  }
  
  // 获取用户面具信息
  var userMask = getCurrentMask() || {
    nickname: myProfile.name,
    avatar: myProfile.avatar
  };
  var userName = userMask.nickname || myProfile.name || '我';
  var userAvatar = userMask.avatar || myProfile.avatar;
  
  list.innerHTML = forum.posts.map(function(post) {
    var authorName, authorAvatar, authorTag, isContact = false;
    
    if (post.authorType === 'contact') {
      var c = getContact(post.authorId);
      authorName = c ? (c.remark || c.name) : '未知';
      authorAvatar = c && c.avatar ? '<img src="' + c.avatar + '">' : esc(authorName.charAt(0));
      authorTag = '<span class="author-tag">成员</span>';
      isContact = true;
    } else if (post.authorType === 'me') {
      authorName = userName;
      authorAvatar = userAvatar ? '<img src="' + userAvatar + '">' : esc(userName.charAt(0));
      authorTag = '<span class="author-tag">我</span>';
    } else {
      // 网友
      authorName = post.authorName || '匿名网友';
      authorAvatar = esc(authorName.charAt(0));
      authorTag = '<span class="author-tag netizen">网友</span>';
    }
    
    // 点赞状态
    var iLiked = post.likes && post.likes.indexOf('me') !== -1;
    var likeCount = post.likes ? post.likes.length : 0;
    var commentCount = post.comments ? post.comments.length : 0;
    
    // 帖子内容
    var contentHtml = '';
    if (post.title) {
      contentHtml += '<div class="post-title">' + esc(post.title) + '</div>';
    }
    contentHtml += esc(post.content);
    
    // 评论
    var commentsHtml = '';
    if (post.comments && post.comments.length > 0) {
      commentsHtml = '<div class="post-comments">';
      post.comments.forEach(function(cm) {
        var cmName, cmAvatar;
        if (cm.authorType === 'me') {
          cmName = userName;
          cmAvatar = userAvatar ? '<img src="' + userAvatar + '">' : esc(userName.charAt(0));
        } else if (cm.authorType === 'contact') {
          var cc = getContact(cm.authorId);
          cmName = cc ? (cc.remark || cc.name) : '未知';
          cmAvatar = cc && cc.avatar ? '<img src="' + cc.avatar + '">' : esc(cmName.charAt(0));
        } else {
          cmName = cm.authorName || '网友';
          cmAvatar = esc(cmName.charAt(0));
        }
        
        var replyStr = '';
        if (cm.replyTo) {
          replyStr = '<span class="reply-to"> 回复 ' + esc(cm.replyToName || '某人') + '</span>';
        }
        
        commentsHtml += '<div class="post-comment">' +
          '<div class="post-comment-avatar">' + cmAvatar + '</div>' +
          '<div class="post-comment-body">' +
          '<div class="post-comment-author">' + esc(cmName) + replyStr + '</div>' +
          '<div class="post-comment-text">' + esc(cm.text) + '</div>' +
          '<div class="post-comment-time">' + getTimeAgo(cm.ts) + '</div>' +
          '</div></div>';
      });
      commentsHtml += '</div>';
    }
    
    return '<div class="post-card" data-pid="' + post.id + '">' +
      '<div class="post-header">' +
      '<div class="post-avatar">' + authorAvatar + '</div>' +
      '<div class="post-author-info">' +
      '<div class="post-author-name">' + esc(authorName) + ' ' + authorTag + '</div>' +
      '<div class="post-time">' + getTimeAgo(post.ts) + '</div>' +
      '</div></div>' +
      '<div class="post-content">' + contentHtml + '</div>' +
      '<div class="post-actions">' +
      '<div class="post-action-btn ' + (iLiked ? 'liked' : '') + '" data-action="like" data-pid="' + post.id + '">' + (iLiked ? '❤️' : '🤍') + ' ' + (likeCount || '赞') + '</div>' +
      '<div class="post-action-btn" data-action="comment" data-pid="' + post.id + '">💬 ' + (commentCount || '评论') + '</div>' +
      '</div>' +
      commentsHtml +
      '<div class="post-comment-input" id="commentInput_' + post.id + '">' +
      '<input type="text" placeholder="写评论..." maxlength="200" id="commentText_' + post.id + '">' +
      '<button data-pid="' + post.id + '" class="btn-submit-post-comment">发送</button>' +
      '</div></div>';
  }).join('');
  
  // 绑定点赞事件
  list.querySelectorAll('[data-action="like"]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var pid = btn.getAttribute('data-pid');
      var post = forum.posts.find(function(p) { return p.id === pid; });
      if (!post) return;
      
      if (!post.likes) post.likes = [];
      var idx = post.likes.indexOf('me');
      if (idx !== -1) {
        post.likes.splice(idx, 1);
      } else {
        post.likes.push('me');
      }
      saveForums();
      renderForumPosts(forum);
    });
  });
  
  // 绑定评论按钮
  list.querySelectorAll('[data-action="comment"]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var pid = btn.getAttribute('data-pid');
      var inputWrap = document.getElementById('commentInput_' + pid);
      inputWrap.classList.toggle('show');
      if (inputWrap.classList.contains('show')) {
        document.getElementById('commentText_' + pid).focus();
      }
    });
  });
  
  // 绑定发送评论
  list.querySelectorAll('.btn-submit-post-comment').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var pid = btn.getAttribute('data-pid');
      var input = document.getElementById('commentText_' + pid);
      var text = input.value.trim();
      if (!text) return;
      
      var post = forum.posts.find(function(p) { return p.id === pid; });
      if (!post) return;
      
      if (!post.comments) post.comments = [];
      post.comments.push({
        id: gid(),
        authorType: 'me',
        text: text,
        ts: Date.now()
      });
      
      saveForums();
      input.value = '';
      renderForumPosts(forum);
      
      // 触发AI回复
      triggerForumCommentReply(forum, post, text);
    });
  });
}

// ========== 刷新/生成帖子 ==========

document.getElementById('btnRefreshForum').addEventListener('click', function() {
  var f = forums.find(function(x) { return x.id === currentForumId; });
  if (!f) return;
  
  var btn = document.getElementById('btnRefreshForum');
  if (btn.classList.contains('loading')) return;
  
  btn.classList.add('loading');
  btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px;"></div> 生成中...';
  
  generateForumPosts(f, function() {
    btn.classList.remove('loading');
    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 20 20" fill="none"><path d="M4 10a6 6 0 0110.5-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M16 10a6 6 0 01-10.5 4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M14 3v3h3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 17v-3H3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg> 刷新帖子';
    renderForumPosts(f);
  });
});

// 生成论坛帖子
function generateForumPosts(forum, callback) {
  var apiCfg = apiConfigs.find(function(a) { return a.id === forum.apiId; });
  if (!apiCfg) {
    alert('论坛未配置 API');
    if (callback) callback();
    return;
  }
  
  // 获取用户信息
  var userMask = getCurrentMask() || {
    nickname: myProfile.name,
    gender: myProfile.gender,
    persona: myProfile.persona
  };
  var userName = userMask.nickname || myProfile.name || '用户';
  
  // 构建成员信息
  var membersInfo = '';
  forum.members.forEach(function(mid) {
    var c = getContact(mid);
    if (c) {
      membersInfo += '\n- ' + c.name;
      if (c.gender) {
        var gm = { male: '(男)', female: '(女)', other: '' };
        membersInfo += gm[c.gender] || '';
      }
      if (c.persona) {
        membersInfo += '：' + c.persona.substring(0, 100);
      }
    }
  });
  
  // 构建提示词
  var prompt = '你是一个论坛内容生成器。请根据以下设定生成真实、有沉浸感的论坛帖子。\n\n';
  
  prompt += '【论坛名称】\n' + forum.name + '\n\n';
  
  prompt += '【世界观设定】\n' + (forum.worldview || '现实世界') + '\n\n';
  
  prompt += '【论坛成员（可能会发帖的角色）】' + membersInfo + '\n\n';
  
  prompt += '【用户信息（论坛的浏览者）】\n';
  prompt += '名字：' + userName + '\n';
  if (userMask.gender) {
    var gm2 = { male: '男', female: '女', other: '其他' };
    prompt += '性别：' + (gm2[userMask.gender] || '') + '\n';
  }
  if (userMask.persona) {
    prompt += '简介：' + userMask.persona.substring(0, 100) + '\n';
  }
  prompt += '\n';
  
  // 当前时间
  var now = new Date();
  var weekDays = ['日', '一', '二', '三', '四', '五', '六'];
  prompt += '【当前时间】\n';
  prompt += now.getFullYear() + '年' + (now.getMonth() + 1) + '月' + now.getDate() + '日 ';
  prompt += '星期' + weekDays[now.getDay()] + ' ' + now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0') + '\n\n';
  
  prompt += '【生成要求】\n';
  prompt += '1. 生成5-8条论坛帖子，用JSON数组格式返回\n';
  prompt += '2. 帖子类型要多样：日常分享、提问、讨论、吐槽、新闻、攻略等\n';
  prompt += '3. 部分帖子由论坛成员发布（authorType: "contact", authorId: "成员ID"）\n';
  prompt += '4. 部分帖子由随机网友发布（authorType: "netizen", authorName: "网友昵称"）\n';
  prompt += '5. 成员发帖必须符合其人设，比如明星不会随便发普通帖子\n';
  prompt += '6. 网友昵称要有趣、符合网络风格，如"今天也要加油鸭"、"深夜食堂老板"\n';
  prompt += '7. 帖子内容要符合世界观设定，有沉浸感\n';
  prompt += '8. 可以有1-3条评论，评论者可以是成员或网友\n';
  prompt += '9. 内容要像真实论坛，有网络用语、表情、口语化表达\n\n';
  
  prompt += '【返回格式】\n';
  prompt += '严格返回JSON数组，不要有其他内容：\n';
  prompt += '[\n';
  prompt += '  {\n';
  prompt += '    "authorType": "contact" 或 "netizen",\n';
  prompt += '    "authorId": "成员ID（仅contact类型需要）",\n';
  prompt += '    "authorName": "网友昵称（仅netizen类型需要）",\n';
  prompt += '    "title": "帖子标题（可选）",\n';
  prompt += '    "content": "帖子内容",\n';
  prompt += '    "comments": [\n';
  prompt += '      {\n';
  prompt += '        "authorType": "contact" 或 "netizen",\n';
  prompt += '        "authorId": "成员ID（可选）",\n';
  prompt += '        "authorName": "评论者昵称",\n';
  prompt += '        "text": "评论内容"\n';
  prompt += '      }\n';
  prompt += '    ]\n';
  prompt += '  }\n';
  prompt += ']\n\n';
  
  prompt += '【论坛成员ID对照】\n';
  forum.members.forEach(function(mid) {
    var c = getContact(mid);
    if (c) {
      prompt += c.name + ' 的ID是: ' + mid + '\n';
    }
  });
  
  if (apiCfg.format === 'openai') {
    var url = apiCfg.base.replace(/\/+$/, '');
    url = url.endsWith('/v1') ? url + '/chat/completions' : url + '/v1/chat/completions';
    
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiCfg.key },
      body: JSON.stringify({
        model: apiCfg.model,
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 2500
      })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var text = '';
      if (data.choices && data.choices[0]) {
        text = data.choices[0].message.content;
      }
      parseAndAddPosts(forum, text);
      if (callback) callback();
    })
    .catch(function(err) {
      console.error('生成帖子失败:', err);
      alert('生成失败，请重试');
      if (callback) callback();
    });
  } else {
    var url2 = apiCfg.base.replace(/\/+$/, '') + '/v1beta/models/' + apiCfg.model + ':generateContent?key=' + apiCfg.key;
    
    fetch(url2, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { maxOutputTokens:2500 }
      })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var text = '';
      if (data.candidates && data.candidates[0] && data.candidates[0].content) {
        text = data.candidates[0].content.parts.map(function(p) { return p.text; }).join('');
      }
      parseAndAddPosts(forum, text);
      if (callback) callback();
    })
    .catch(function(err) {
      console.error('生成帖子失败:', err);
      alert('生成失败，请重试');
      if (callback) callback();
    });
  }
}

// 解析并添加帖子
function parseAndAddPosts(forum, text) {
  try {
    // 尝试提取JSON
    var jsonMatch = text.match(/\[[\s\S]*\]/);
    if (!jsonMatch) {
      console.error('未找到JSON数组');
      return;
    }
    
    var posts = JSON.parse(jsonMatch[0]);
    if (!Array.isArray(posts)) return;
    
    var now = Date.now();
    posts.forEach(function(post, index) {
      // 为每个帖子生成唯一ID和时间戳（模拟不同时间发布）
      var newPost = {
        id: gid(),
        authorType: post.authorType || 'netizen',
        authorId: post.authorId || null,
        authorName: post.authorName || '匿名网友',
        title: post.title || '',
        content: post.content || '',
        ts: now - (posts.length - index) * 60000 * Math.floor(Math.random() * 30 + 5), // 随机时间间隔
        likes: [],
        comments: []
      };
      
      // 处理评论
      if (post.comments && Array.isArray(post.comments)) {
        post.comments.forEach(function(cm) {
          newPost.comments.push({
            id: gid(),
            authorType: cm.authorType || 'netizen',
            authorId: cm.authorId || null,
            authorName: cm.authorName || '网友',
            text: cm.text || '',
            ts: newPost.ts + Math.floor(Math.random() * 600000) // 评论时间在帖子之后
          });
        });
      }
      
      forum.posts.unshift(newPost); // 新帖子放在前面
    });
    
    // 限制帖子数量，保留最新的50条
    if (forum.posts.length > 50) {
      forum.posts = forum.posts.slice(0, 50);
    }
    
    saveForums();
  } catch (e) {
    console.error('解析帖子失败:', e);
  }
}

// ========== 论坛评论AI回复 ==========

function triggerForumCommentReply(forum, post, myText) {
  // 决定谁来回复
  var responders = [];
  
  // 如果帖子作者是成员，有较高概率回复
  if (post.authorType === 'contact' && post.authorId) {
    var author = getContact(post.authorId);
    if (author) {
      // 根据人设判断是否会回复
      var willReply = shouldCharacterReply(author, myText);
      if (willReply) {
        responders.push({ type: 'contact', contact: author, isAuthor: true });
      }
    }
  }
  
  // 随机决定是否有网友回复（30%概率）
  if (Math.random() < 0.3) {
    responders.push({ type: 'netizen' });
  }
  
  // 随机决定是否有其他成员回复（20%概率）
  if (Math.random() < 0.2 && forum.members.length > 1) {
    var otherMembers = forum.members.filter(function(mid) {
      return mid !== post.authorId;
    });
    if (otherMembers.length > 0) {
      var randomMid = otherMembers[Math.floor(Math.random() * otherMembers.length)];
      var randomMember = getContact(randomMid);
      if (randomMember && shouldCharacterReply(randomMember, myText)) {
        responders.push({ type: 'contact', contact: randomMember, isAuthor: false });
      }
    }
  }
  
  // 依次触发回复
  responders.forEach(function(responder, index) {
    setTimeout(function() {
      if (responder.type === 'contact') {
        generateForumCharacterReply(forum, post, responder.contact, myText, responder.isAuthor);
      } else {
        generateForumNetizenReply(forum, post, myText);
      }
    }, (index + 1) * (2000 + Math.random() * 3000));
  });
}

// 判断角色是否会回复（根据人设）
function shouldCharacterReply(contact, commentText) {
  if (!contact.persona) return true;
  
  var persona = contact.persona.toLowerCase();
  
  // 明星、名人等通常不会随便回复
  if (persona.includes('明星') || persona.includes('偶像') || persona.includes('艺人') || 
      persona.includes('名人') || persona.includes('公众人物')) {
    // 只有10%概率回复
    return Math.random() < 0.1;
  }
  
  // 高冷、冷漠等性格回复概率较低
  if (persona.includes('高冷') || persona.includes('冷漠') || persona.includes('话少')) {
    return Math.random() < 0.4;
  }
  
  // 热情、话多等性格回复概率较高
  if (persona.includes('热情') || persona.includes('话多') || persona.includes('活泼') || persona.includes('开朗')) {
    return Math.random() < 0.9;
  }
  
  // 默认70%概率回复
  return Math.random() < 0.7;
}

// 生成角色回复
function generateForumCharacterReply(forum, post, contact, myText, isAuthor) {
  var apiCfg = apiConfigs.find(function(a) { return a.id === forum.apiId; });
  if (!apiCfg) return;
  
  // 获取用户信息
  var userMask = getMaskForContact(contact);
  var userName = userMask.nickname || myProfile.name || '用户';
  
  var prompt = '你正在扮演"' + contact.name + '"在论坛回复评论。\n\n';
  
  prompt += '【你的人设】\n';
  if (contact.persona) prompt += contact.persona + '\n';
  if (contact.gender) {
    var gm = { male: '男性', female: '女性', other: '其他' };
    prompt += '性别：' + (gm[contact.gender] || '') + '\n';
  }
  prompt += '\n';
  
  prompt += '【论坛世界观】\n' + (forum.worldview || '现实世界') + '\n\n';
  
  prompt += '【评论者信息】\n';
  prompt += '名字：' + userName + '\n';
  if (userMask.persona) prompt += '简介：' + userMask.persona.substring(0, 80) + '\n';
  prompt += '\n';
  
  // 聊天记录参考
  if (contact.messages && contact.messages.length > 0) {
    var recentMsgs = contact.messages.slice(-8);
    prompt += '【你和' + userName + '的私聊记录（了解你们的关系）】\n';
    recentMsgs.forEach(function(msg) {
      var sender = msg.role === 'user' ? userName : '你';
      prompt += sender + '：' + msg.text.substring(0, 40) + '\n';
    });
    prompt += '\n';
  }
  
  prompt += '【帖子内容】\n';
  if (post.title) prompt += '标题：' + post.title + '\n';
  prompt += '内容：' + post.content.substring(0, 200) + '\n';
  prompt += '发帖人：' + (isAuthor ? '你自己' : '其他人') + '\n\n';
  
  // 已有评论
  if (post.comments && post.comments.length > 0) {
    prompt += '【已有评论】\n';
    post.comments.slice(-5).forEach(function(cm) {
      var cmName = cm.authorType === 'me' ? userName : (cm.authorName || '网友');
      prompt += cmName + '：' + cm.text + '\n';
    });
    prompt += '\n';
  }
  
  prompt += '【' + userName + '刚刚评论说】\n"' + myText + '"\n\n';
  
  prompt += '【回复要求】\n';
  prompt += '- 只写你的回复内容，不要加任何前缀\n';
  prompt += '- 符合你的人设和性格\n';
  prompt += '- 像真人在论坛回复一样，简短自然\n';
  prompt += '- 可以用网络用语和表情\n';
  if (isAuthor) {
    prompt += '- 这是你自己的帖子，以帖主身份回复\n';
  }
  
  callForumApi(apiCfg, prompt, function(reply) {
    if (reply) {
      post.comments.push({
        id: gid(),
        authorType: 'contact',
        authorId: contact.id,
        text: reply,
        replyTo: 'me',
        replyToName: userName,
        ts: Date.now()
      });
      saveForums();
      var f = forums.find(function(x) { return x.id === currentForumId; });
      if (f) renderForumPosts(f);
    }
  });
}

// 生成网友回复
function generateForumNetizenReply(forum, post, myText) {
  var apiCfg = apiConfigs.find(function(a) { return a.id === forum.apiId; });
  if (!apiCfg) return;
  
  var userMask = getCurrentMask() || { nickname: myProfile.name };
  var userName = userMask.nickname || myProfile.name || '用户';
  
  var prompt = '你是一个论坛的普通网友，请回复一条评论。\n\n';
  
  prompt += '【论坛世界观】\n' + (forum.worldview || '现实世界') + '\n\n';
  
  prompt += '【帖子内容】\n';
  if (post.title) prompt += '标题：' + post.title + '\n';
  prompt += '内容：' + post.content.substring(0, 150) + '\n\n';
  
  prompt += '【' + userName + '刚刚评论说】\n"' + myText + '"\n\n';
  
  prompt += '【回复要求】\n';
  prompt += '1. 先给自己起一个有趣的网名（如"今天也要加油"、"吃瓜群众"、"路过的咸鱼"等）\n';
  prompt += '2. 然后写回复内容\n';
  prompt += '3. 像真实网友一样，可以附和、调侃、补充、提问等\n';
  prompt += '4. 用网络用语，口语化，可以用表情\n\n';
  
  prompt += '【返回格式】\n';
  prompt += '网名：xxx\n';
  prompt += '回复：xxx';
  
  callForumApi(apiCfg, prompt, function(reply) {
    if (reply) {
      // 解析网名和回复
      var nameMatch = reply.match(/网名[：:]\s*(.+)/);
      var textMatch = reply.match(/回复[：:]\s*([\s\S]+)/);
      
      var netizenName = nameMatch ? nameMatch[1].trim() : '热心网友';
      var replyText = textMatch ? textMatch[1].trim() : reply;
      
      // 清理可能的多余内容
      netizenName = netizenName.replace(/\n[\s\S]*/, '').substring(0, 15);
      
      post.comments.push({
        id: gid(),
        authorType: 'netizen',
        authorName: netizenName,
        text: replyText,
        replyTo: 'me',
        replyToName: userName,
        ts: Date.now()
      });
      saveForums();
      var f = forums.find(function(x) { return x.id === currentForumId; });
      if (f) renderForumPosts(f);
    }
  });
}

// 通用论坛API调用
function callForumApi(apiCfg, prompt, callback) {
  if (apiCfg.format === 'openai') {
    var url = apiCfg.base.replace(/\/+$/, '');
    url = url.endsWith('/v1') ? url + '/chat/completions' : url + '/v1/chat/completions';
    
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiCfg.key },
      body: JSON.stringify({
        model: apiCfg.model,
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 200
      })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var reply = '';
      if (data.choices && data.choices[0]) {
        reply = data.choices[0].message.content.trim();
      }
      callback(reply);
    })
    .catch(function() { callback(''); });
  } else {
    var url2 = apiCfg.base.replace(/\/+$/, '') + '/v1beta/models/' + apiCfg.model + ':generateContent?key=' + apiCfg.key;
    
    fetch(url2, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { maxOutputTokens: 200 }
      })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var reply = '';
      if (data.candidates && data.candidates[0] && data.candidates[0].content) {
        reply = data.candidates[0].content.parts.map(function(p) { return p.text; }).join('').trim();
      }
      callback(reply);
    })
    .catch(function() { callback(''); });
  }
}

// ========== 论坛记忆挂载到私聊 ==========

function getForumMemory(contactId) {
  var memories = [];
  
  forums.forEach(function(forum) {
    // 只处理包含该角色的论坛
    if (!forum.members || forum.members.indexOf(contactId) === -1) return;
    if (!forum.posts) return;
    
    // 找到与用户相关的互动
    forum.posts.forEach(function(post) {
      // 用户评论了该角色的帖子
      if (post.authorType === 'contact' && post.authorId === contactId) {
        var myComments = post.comments ? post.comments.filter(function(cm) {
          return cm.authorType === 'me';
        }) : [];
        
        if (myComments.length > 0) {
          var lastComment = myComments[myComments.length - 1];
          memories.push({
            type: 'user_comment_on_post',
            forumName: forum.name,
            postContent: post.content.substring(0, 50),
            userComment: lastComment.text.substring(0, 50),
            ts: lastComment.ts
          });
        }
      }
      
      // 该角色回复了用户的评论
      if (post.comments) {
        post.comments.forEach(function(cm) {
          if (cm.authorType === 'contact' && cm.authorId === contactId && cm.replyTo === 'me') {
            memories.push({
              type: 'contact_reply_to_user',
              forumName: forum.name,
              replyText: cm.text.substring(0, 50),
              ts: cm.ts
            });
          }
        });
      }
    });
  });
  
  // 按时间排序，取最近5条
  memories.sort(function(a, b) { return b.ts - a.ts; });
  memories = memories.slice(0, 5);
  
  if (memories.length === 0) return '';
  
  var lines = ['【论坛互动记录】'];
  memories.forEach(function(m) {
    if (m.type === 'user_comment_on_post') {
      lines.push('- 在"' + m.forumName + '"论坛，对方评论了你的帖子："' + m.userComment + '"');
    } else if (m.type === 'contact_reply_to_user') {
      lines.push('- 在"' + m.forumName + '"论坛，你回复了对方："' + m.replyText + '"');
    }
  });
  
  return lines.join('\n');
}

// ========== 全屏模式功能 ==========
var fullscreenToggle = document.getElementById('toggleFullscreen');

// 初始化全屏开关状态
function updateFullscreenToggle() {
  var isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
  fullscreenToggle.classList.toggle('on', !!isFullscreen);
}

// 监听全屏状态变化
document.addEventListener('fullscreenchange', updateFullscreenToggle);
document.addEventListener('webkitfullscreenchange', updateFullscreenToggle);
document.addEventListener('mozfullscreenchange', updateFullscreenToggle);
document.addEventListener('MSFullscreenChange', updateFullscreenToggle);

// 点击开关切换全屏
fullscreenToggle.addEventListener('click', function() {
  var isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
  
  if (isFullscreen) {
    // 退出全屏
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
  } else {
    // 进入全屏
    var elem = document.documentElement;
    if (elem.requestFullscreen) {
      elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) {
      elem.webkitRequestFullscreen();
    } else if (elem.mozRequestFullScreen) {
      elem.mozRequestFullScreen();
    } else if (elem.msRequestFullscreen) {
      elem.msRequestFullscreen();
    }
  }
});

// 悬浮全屏按钮
var floatingBtn = document.getElementById('floatingFullscreenBtn');

floatingBtn.addEventListener('click', function() {
  var isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
  
  if (isFullscreen) {
    // 退出全屏
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
  } else {
    // 进入全屏
    var elem = document.documentElement;
    if (elem.requestFullscreen) {
      elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) {
      elem.webkitRequestFullscreen();
    } else if (elem.mozRequestFullScreen) {
      elem.mozRequestFullScreen();
    } else if (elem.msRequestFullscreen) {
      elem.msRequestFullscreen();
    }
  }
});

// 全屏后隐藏悬浮按钮，退出全屏后显示
function updateFloatingBtn() {
  var isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
  floatingBtn.style.display = isFullscreen ? 'none' : 'flex';
}

document.addEventListener('fullscreenchange', updateFloatingBtn);
document.addEventListener('webkitfullscreenchange', updateFloatingBtn);
document.addEventListener('mozfullscreenchange', updateFloatingBtn);
document.addEventListener('MSFullscreenChange', updateFloatingBtn);

// ========== 导入全部数据 ==========
document.getElementById('btnImportData').addEventListener('click', function() {
  if (!confirm('导入数据会覆盖当前所有数据，确定继续吗？')) return;
  document.getElementById('importFileInput').click();
});

document.getElementById('importFileInput').addEventListener('change', function(e) {
  var f = e.target.files[0];
  if (!f) return;

  var reader = new FileReader();
  reader.onload = function(ev) {
    try {
      var data = JSON.parse(ev.target.result);

      // 验证数据格式
      if (!data.contacts && !data.apiConfigs && !data.myProfile) {
        alert('无效的存档文件');
        return;
      }

      // 导入数据
      if (data.contacts) {
        contacts = data.contacts;
        saveContacts();
      }
      if (data.apiConfigs) {
        apiConfigs = data.apiConfigs;
        saveApiConfigs();
      }
      if (data.myProfile) {
        myProfile = data.myProfile;
        saveMyProfile();
      }
      if (data.moments) {
        moments = data.moments;
        saveMoments();
      }
if (data.masks) {
  masks = data.masks;
  saveMasks();
}
if (data.currentMaskId !== undefined) {
  currentMaskId = data.currentMaskId;
  saveCurrentMaskId();
}
if (data.forums) {
  forums = data.forums;
  saveForums();
}

      // 刷新界面
      renderContactList();
      renderMePage();

      alert('导入成功！');
    } catch (err) {
      alert('导入失败：文件格式错误\n' + err.message);
    }
  };
  reader.readAsText(f);e.target.value = '';
});

// ========== 朋友圈数据 ==========
var moments = [];

function saveMoments(cb) { dbSet('moments', moments, cb); }


function renderMomentsHeader() {
  document.getElementById('momentsMyName').textContent = myProfile.name || '我';
  var av = document.getElementById('momentsMyAvatar');
  av.innerHTML = myProfile.avatar ? '<img src="' + myProfile.avatar + '">' : esc(myProfile.name ? myProfile.name.charAt(0) : '我');

  var banner = document.getElementById('momentsBanner');
  if (myProfile.momentsBg) {
    var existImg = banner.querySelector(':scope > img');
if (!existImg) {
      var img = document.createElement('img');
      img.src = myProfile.momentsBg;
      banner.insertBefore(img, banner.firstChild);
    } else {
      existImg.src = myProfile.momentsBg;
    }
  } else {
    var existImg2 = banner.querySelector(':scope > img');
if (existImg2) existImg2.remove();
  }
}

document.getElementById('btnChangeMomentsBg').addEventListener('click', function() {
  document.getElementById('momentsBgInput').click();
});

document.getElementById('momentsBgInput').addEventListener('change', function(e) {
  var f = e.target.files[0];
  if (!f) return;
  var r = new FileReader();
  r.onload = function(ev) {
    myProfile.momentsBg = ev.target.result;
    saveMyProfile();
    renderMomentsHeader();
  };
  r.readAsDataURL(f);e.target.value = '';
});


// ========== 发朋友圈 ==========
document.getElementById('momentFab').addEventListener('click', function() {
  document.getElementById('momentTextarea').value = '';
  renderVisibleList();
  document.getElementById('postMomentOverlay').classList.add('active');
});

document.getElementById('btnClosePostMoment').addEventListener('click', function() {
  document.getElementById('postMomentOverlay').classList.remove('active');
});

document.getElementById('postMomentOverlay').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('active');
});

var selectedVisible = new Set();

function renderVisibleList() {
  selectedVisible = new Set();
  var list = document.getElementById('visibleList');
  if (contacts.length === 0) {
    list.innerHTML = '<div style="font-size:12px;color:var(--text-hint);">还没有联系人</div>';
    return;
  }
  list.innerHTML = contacts.map(function(c) {
    var av = c.avatar ? '<img src="' + c.avatar + '">' : esc(c.name.charAt(0));
    return '<div class="visible-chip" data-id="' + c.id + '">' +
      '<div class="visible-chip-avatar">' + av + '</div>' +
      esc(c.remark || c.name) + '</div>';
  }).join('');

  list.querySelectorAll('.visible-chip').forEach(function(chip) {
    chip.addEventListener('click', function() {
      var id = chip.getAttribute('data-id');
      if (selectedVisible.has(id)) {
        selectedVisible.delete(id);
        chip.classList.remove('selected');
      } else {
        selectedVisible.add(id);
        chip.classList.add('selected');
      }
    });
  });
}

// 发布
document.getElementById('btnPublishMoment').addEventListener('click', function() {
  var text = document.getElementById('momentTextarea').value.trim();
  if (!text) { alert('请输入内容'); return; }
  if (selectedVisible.size === 0) { alert('请至少选择一个可见角色'); return; }

  var moment = {
    id: gid(),
    authorType: 'me',
    authorId: null,
    text: text,
    ts: Date.now(),
    visibleTo: Array.from(selectedVisible),
    likes: [],
    comments: [],
    aiReplied: false
  };

  moments.unshift(moment);
  saveMoments();
  document.getElementById('postMomentOverlay').classList.remove('active');
  renderMoments();

  // 角色自动评论和点赞
  triggerAiReactions(moment);
});

// ========== 渲染朋友圈 ==========
function renderMoments() {
  var list = document.getElementById('momentsList');
  var noM = document.getElementById('noMoments');

  if (moments.length === 0) {
    noM.style.display = 'flex';
    // 只保留 noMoments，清除其他
    var children = list.querySelectorAll('.moment-card, .moment-loading-bar');
    children.forEach(function(el) { el.remove(); });
    return;
  }

  noM.style.display = 'none';
  var html = '';

  moments.forEach(function(m) {
    var isMe = m.authorType === 'me';
    var authorName, authorAvatar;

    if (isMe) {
      authorName = myProfile.name || '我';
      authorAvatar = myProfile.avatar ? '<img src="' + myProfile.avatar + '">' : esc(authorName.charAt(0));
    } else {
      var c = getContact(m.authorId);
      authorName = c ? (c.remark || c.name) : '未知';
      authorAvatar = c && c.avatar ? '<img src="' + c.avatar + '">' : esc(authorName.charAt(0));
    }

    html += '<div class="moment-card" data-mid="' + m.id + '">';
    html += '<div class="moment-header">';
    html += '<div class="moment-avatar">' + authorAvatar + '</div>';
    html += '<div class="moment-author-info">';
    html += '<div class="moment-author-name">' + esc(authorName) + '</div>';
    html += '<div class="moment-time">' + getTimeAgo(m.ts) + '</div>';
    html += '</div></div>';
    html += '<div class="moment-content">' + esc(m.text) + '</div>';

    // 点赞
    if (m.likes && m.likes.length > 0) {
      var likeNames = m.likes.map(function(lid) {
        if (lid === 'me') return myProfile.name || '我';
        var lc = getContact(lid);
        return lc ? (lc.remark || lc.name) : '未知';
      }).join('，');
      html += '<div class="moment-likes"><span class="like-icon">❤️</span><span class="like-names">' + esc(likeNames) + '</span></div>';
    }

    // 评论
    if (m.comments && m.comments.length > 0) {
      html += '<div class="moment-comments">';
      m.comments.forEach(function(cm) {
        var cmName;
        if (cm.authorType === 'me') cmName = myProfile.name || '我';
        else {
          var cc = getContact(cm.authorId);
          cmName = cc ? (cc.remark || cc.name) : '未知';
        }
        var canReply = cm.authorType !== 'me';
        html += '<div class="moment-comment' + (canReply ? ' clickable-comment' : '') + '" data-mid="' + m.id + '" data-cm-author-type="' + cm.authorType + '" data-cm-author-id="' + (cm.authorId || '') + '" data-cm-name="' + esc(cmName) + '">';
        html += '<span class="comment-author">' + esc(cmName) + '</span>';
        if (cm.replyTo) {
          var rtName;
          if (cm.replyTo === 'me') rtName = myProfile.name || '我';
          else { var rc = getContact(cm.replyTo); rtName = rc ? (rc.remark || rc.name) : '未知'; }
          html += '<span class="comment-reply-to"> 回复 </span><span class="comment-author">' + esc(rtName) + '</span>';
        }
        html += '：<span class="comment-text">' + esc(cm.text) + '</span>';
        html += '</div>';
      });
      html += '</div>';
    }

   // 操作栏
var iLiked = m.likes && m.likes.indexOf('me') !== -1;
html += '<div class="moment-actions">';
html += '<div class="moment-action-btn ' + (iLiked ? 'liked' : '') + '" data-action="like" data-mid="' + m.id + '">' + (iLiked ? '❤️' : '🤍') + ' 赞</div>';
html += '<div class="moment-action-btn" data-action="comment" data-mid="' + m.id + '">评论</div>';
html += '<div class="moment-action-btn delete" data-action="delete" data-mid="' + m.id + '">删除</div>';
html += '</div>';


    // 评论输入框
    html += '<div class="moment-comment-input" id="commentInput_' + m.id + '" style="display:none;">';
    html += '<div id="replyHint_' + m.id + '"></div>';
    html += '<div style="display:flex;gap:6px;width:100%;">';
    html += '<input type="text" placeholder="写评论..." maxlength="200" id="commentText_' + m.id + '">';
    html += '<button data-mid="' + m.id + '" class="btn-submit-comment">发送</button>';
    html += '</div></div>';

    html += '</div>';
  });

  // 保留 noMoments 元素
  var noEl = list.querySelector('.no-moments');
  list.innerHTML = html;
  if (noEl) list.appendChild(noEl);
// 绑定删除事件
list.querySelectorAll('[data-action="delete"]').forEach(function(btn) {
  btn.addEventListener('click', function() {
    var mid = btn.getAttribute('data-mid');
    if (!confirm('确定要删除这条动态吗？')) return;
    
    // 从数组中删除
    moments = moments.filter(function(m) { return m.id !== mid; });
    saveMoments();
    renderMoments();
  });
});


  // 绑定事件
  list.querySelectorAll('[data-action="like"]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var mid = btn.getAttribute('data-mid');
      var m = moments.find(function(x) { return x.id === mid; });
      if (!m) return;
      if (!m.likes) m.likes = [];
      var idx = m.likes.indexOf('me');
      if (idx !== -1) m.likes.splice(idx, 1);
      else m.likes.push('me');
      saveMoments();
      renderMoments();
    });
  });

  list.querySelectorAll('[data-action="comment"]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var mid = btn.getAttribute('data-mid');
      var inputWrap = document.getElementById('commentInput_' + mid);
      inputWrap.style.display = inputWrap.style.display === 'none' ? 'flex' : 'none';
      if (inputWrap.style.display === 'flex') {
        document.getElementById('commentText_' + mid).focus();
      }
    });
  });

    list.querySelectorAll('.btn-submit-comment').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var mid = btn.getAttribute('data-mid');
      var input = document.getElementById('commentText_' + mid);
      var text = input.value.trim();
      if (!text) return;

      var m = moments.find(function(x) { return x.id === mid; });
      if (!m) return;

      // 检查是否在回复某人
      var hintEl = document.getElementById('replyHint_' + mid);
      var replyToType = hintEl.getAttribute('data-reply-to-type');
      var replyToId = hintEl.getAttribute('data-reply-to-id');
      var replyTo = null;
      var replyContactId = null;

      if (replyToType === 'contact' && replyToId) {
        replyTo = replyToId;
        replyContactId = replyToId;
      } else if (replyToType) {
        replyTo = replyToType;
      }

      m.comments.push({
        id: gid(),
        authorType: 'me',
        authorId: null,
        replyTo: replyTo,
        text: text,
        ts: Date.now()
      });
      saveMoments();
      input.value = '';
      hintEl.innerHTML = '';
      hintEl.removeAttribute('data-reply-to-type');
      hintEl.removeAttribute('data-reply-to-id');
      renderMoments();

      // 触发AI回复
      if (replyContactId) {
        // 回复特定角色
        triggerAiCommentReply(m, replyContactId, text);
      } else if (m.authorType !== 'me') {
        // 评论角色的朋友圈
        triggerAiCommentReply(m, m.authorId, text);
      } else {
        // 我的朋友圈，让可见角色回复
        m.visibleTo.forEach(function(cid) {
          triggerAiCommentReply(m, cid, text);
        });
      }
    });
  });
  // 点击评论回复
  list.querySelectorAll('.clickable-comment').forEach(function(cm) {
    cm.addEventListener('click', function() {
      var mid = cm.getAttribute('data-mid');
      var cmAuthorType = cm.getAttribute('data-cm-author-type');
      var cmAuthorId = cm.getAttribute('data-cm-author-id');
      var cmName = cm.getAttribute('data-cm-name');

      var inputWrap = document.getElementById('commentInput_' + mid);
      inputWrap.style.display = 'flex';
      inputWrap.style.flexDirection = 'column';
      inputWrap.style.gap = '4px';

      var hintEl = document.getElementById('replyHint_' + mid);
      hintEl.innerHTML = '<div class="reply-hint">回复 ' + cmName + ' <button data-mid="' + mid + '" class="cancel-reply-btn">✕</button></div>';
      hintEl.setAttribute('data-reply-to-type', cmAuthorType);
      hintEl.setAttribute('data-reply-to-id', cmAuthorId);

      var input = document.getElementById('commentText_' + mid);
      input.placeholder = '回复 ' + cmName + '...';
      input.focus();

      hintEl.querySelector('.cancel-reply-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        hintEl.innerHTML = '';
        hintEl.removeAttribute('data-reply-to-type');
        hintEl.removeAttribute('data-reply-to-id');
        input.placeholder = '写评论...';});
    });
  });

}

function getTimeAgo(ts) {
  var diff = Date.now() - ts;
  var min = Math.floor(diff / 60000);
  if (min < 1) return '刚刚';
  if (min < 60) return min + '分钟前';
  var hr = Math.floor(min / 60);
  if (hr < 24) return hr + '小时前';
  var day = Math.floor(hr / 24);
  if (day < 7) return day + '天前';
  return fmtDate(ts);
}

// ========== AI 自动点赞和评论 ==========
function triggerAiReactions(moment) {
  moment.visibleTo.forEach(function(cid, index) {
    var c = getContact(cid);
    if (!c) return;
    var apiCfg = c.apiId ? apiConfigs.find(function(a) { return a.id === c.apiId; }) : null;
    if (!apiCfg) return;

    // 延迟，模拟真人
    setTimeout(function() {
// 先点赞（随机决定是否点赞）
if (Math.random() > 0.3) { // 70%概率点赞
  if (!moment.likes) moment.likes = [];
  if (moment.likes.indexOf(cid) === -1) {
    moment.likes.push(cid);
    saveMoments();
    renderMoments();
    // 触发点赞通知
    notifyMoments(c, 'like', '');
  }
}


      // 再评论（延迟一点）
      setTimeout(function() {
        generateMomentComment(apiCfg, c, moment, null);
      }, 1000 + Math.random() * 2000);
    }, (index + 1) * (2000 + Math.random() * 3000));
  });
}


function generateMomentComment(apiCfg, contact, moment, replyToText) {
  // 获取用户的面具信息
  var userMask = getMaskForContact(contact);
  var userName = userMask.nickname || myProfile.name || '对方';
  var userPersona = userMask.persona || myProfile.persona || '';
  var userGender = userMask.gender || myProfile.gender;
  
  // 构建完整的提示词
  var prompt = '你正在扮演"' + contact.name + '"在朋友圈互动。\n\n';
  
  // 角色人设
  prompt += '【你的人设】\n';
  if (contact.persona) prompt += contact.persona + '\n';
  if (contact.gender) {
    var gm = { male: '男性', female: '女性', other: '其他' };
    prompt += '你的性别：' + (gm[contact.gender] || '') + '\n';
  }
  prompt += '\n';
  
  // 用户信息
  prompt += '【和你互动的人的信息】\n';
  prompt += '名字：' + userName + '\n';
  if (userGender) {
    var gm2 = { male: '男性', female: '女性', other: '其他' };
    prompt += '性别：' + (gm2[userGender] || '') + '\n';
  }
  if (userPersona) prompt += '关于TA：' + userPersona + '\n';
  prompt += '你和TA是朋友关系。\n\n';
  
  // 聊天记录参考（最近10条）
  if (contact.messages && contact.messages.length > 0) {
    var recentMsgs = contact.messages.slice(-10);
    prompt += '【你和' + userName + '最近的聊天记录（供参考，了解你们的关系和互动方式）】\n';
    recentMsgs.forEach(function(msg) {
      var sender = msg.role === 'user' ? userName : contact.name;
      prompt += sender + '：' + msg.text.substring(0, 50) + (msg.text.length > 50 ? '...' : '') + '\n';
    });
    prompt += '\n';
  }
  
  // 朋友圈内容
  var isMyMoment = moment.authorType === 'me';
  var momentAuthor = isMyMoment ? userName : contact.name;
  
  prompt += '【朋友圈动态】\n';
  prompt += momentAuthor + ' 发布了一条朋友圈：\n';
  prompt += '"' + moment.text + '"\n\n';
  
  // 已有的评论楼层
  if (moment.comments && moment.comments.length > 0) {
    prompt += '【已有的评论（按时间顺序）】\n';
    moment.comments.forEach(function(cm) {
      var cmName;
      if (cm.authorType === 'me') cmName = userName;
      else {
        var cc = getContact(cm.authorId);
        cmName = cc ? cc.name : '某人';
      }
      var replyStr = '';
      if (cm.replyTo) {
        var rtName;
        if (cm.replyTo === 'me') rtName = userName;
        else { var rc = getContact(cm.replyTo); rtName = rc ? rc.name : '某人'; }
        replyStr = ' 回复 ' + rtName;
      }
      prompt += '- ' + cmName + replyStr + '：' + cm.text + '\n';
    });
    prompt += '\n';
  }
  
  // 点赞信息
  if (moment.likes && moment.likes.length > 0) {
    var likers = moment.likes.map(function(lid) {
      if (lid === 'me') return userName;
      if (lid === contact.id) return '你';
      var lc = getContact(lid);
      return lc ? lc.name : '某人';
    });
    prompt += '点赞的人：' + likers.join('、') + '\n\n';
  }
  
  // 具体任务
  if (replyToText) {
    prompt += '【你的任务】\n';
    prompt += userName + ' 刚刚在评论区说了："' + replyToText + '"\n';
    prompt += '请你自然地回复TA。\n';
  } else if (isMyMoment) {
    prompt += '【你的任务】\n';
    prompt += '这是' + userName + '发的朋友圈，请你作为朋友评论一下。\n';
  } else {
    prompt += '【你的任务】\n';
    prompt += '这是你自己发的朋友圈，' + userName + '可能会来互动，请你回复评论区的内容。\n';
  }
  
  prompt += '\n【回复要求】\n';
  prompt += '- 只写你要发的评论内容，不要加任何前缀、标签、引号\n';
  prompt += '- 简短自然，像真人在朋友圈评论一样\n';
  prompt += '- 可以用emoji\n';
  prompt += '- 根据你们的关系和聊天风格来回复\n';

  if (apiCfg.format === 'openai') {
    var url = apiCfg.base.replace(/\/+$/, '');
    url = url.endsWith('/v1') ? url + '/chat/completions' : url + '/v1/chat/completions';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiCfg.key },
      body: JSON.stringify({ model: apiCfg.model, messages: [{ role: 'user', content: prompt }], max_tokens: 150 })
    }).then(function(r) { return r.json(); }).then(function(data) {
      var reply = '';
      if (data.choices && data.choices[0]) reply = data.choices[0].message.content.trim();
      if (reply) {
  // 清理可能的前缀
  reply = reply.replace(/^["'"']|["'"']$/g, '').trim();
  moment.comments.push({ id: gid(), authorType: 'contact', authorId: contact.id, replyTo: replyToText ? 'me' : null, text: reply, ts: Date.now() });
  saveMoments(); renderMoments();
  // 触发朋友圈通知
  notifyMoments(contact, 'comment', reply);
}

    }).catch(function() {});
  } else {
    var url2 = apiCfg.base.replace(/\/+$/, '') + '/v1beta/models/' + apiCfg.model + ':generateContent?key=' + apiCfg.key;
    fetch(url2, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    }).then(function(r) { return r.json(); }).then(function(data) {
      var reply = '';
      if (data.candidates && data.candidates[0] && data.candidates[0].content)
        reply = data.candidates[0].content.parts.map(function(p) { return p.text; }).join('').trim();
      if (reply) {
  reply = reply.replace(/^["'"']|["'"']$/g, '').trim();
  moment.comments.push({ id: gid(), authorType: 'contact', authorId: contact.id, replyTo: replyToText ? 'me' : null, text: reply, ts: Date.now() });
  saveMoments(); renderMoments();
  // 触发朋友圈通知
  notifyMoments(contact, 'comment', reply);
}

    }).catch(function() {});
  }
}


function triggerAiCommentReply(moment, contactId, myText) {
  var c = getContact(contactId);
  if (!c) return;
  var apiCfg = c.apiId ? apiConfigs.find(function(a) { return a.id === c.apiId; }) : null;
  if (!apiCfg) return;

  // 延迟回复，更真实
  setTimeout(function() {
    generateMomentComment(apiCfg, c, moment, myText);
  }, 2000 + Math.random() * 3000);
}

// ========== 获取朋友圈记忆 ==========
function getMomentsMemory(contactId) {
  if (!moments || moments.length === 0) return '';

  // 找到和这个角色相关的朋友圈（最近5条）
  var related = moments.filter(function(m) {
    // 我发的且这个角色可见
    if (m.authorType === 'me' && m.visibleTo && m.visibleTo.indexOf(contactId) !== -1) return true;
    // 这个角色发的
    if (m.authorType === 'contact' && m.authorId === contactId) return true;
    return false;
  }).slice(0, 5);

  if (related.length === 0) return '';

  var lines = [];
  related.forEach(function(m) {
    var isMe = m.authorType === 'me';
    var authorName = isMe ? (myProfile.name || '对方') : '你';
    var timeAgo = getTimeAgo(m.ts);

    lines.push('- ' + timeAgo + '，' + authorName + '发了朋友圈："' + m.text.substring(0, 60) + (m.text.length > 60 ? '...' : '') + '"');

    // 点赞
    if (m.likes && m.likes.length > 0) {
      var likers = m.likes.map(function(lid) {
        if (lid === 'me') return myProfile.name || '对方';
        if (lid === contactId) return '你';
        var lc = getContact(lid);
        return lc ? lc.name : '某人';
      });
      lines.push('  点赞：' + likers.join('、'));
    }

    // 评论（最多3条）
    if (m.comments && m.comments.length > 0) {
      m.comments.slice(-3).forEach(function(cm) {
        var cmName;
        if (cm.authorType === 'me') cmName = myProfile.name || '对方';
        else if (cm.authorId === contactId) cmName = '你';
        else { var cc = getContact(cm.authorId); cmName = cc ? cc.name : '某人'; }

        var replyStr = '';
        if (cm.replyTo) {
          var rtName;
          if (cm.replyTo === 'me') rtName = myProfile.name || '对方';
          else if (cm.replyTo === contactId) rtName = '你';
          else { var rc = getContact(cm.replyTo); rtName = rc ? rc.name : '某人'; }
          replyStr = '回复' + rtName + '：';
        }
        lines.push('  评论 - ' + cmName + '：' + replyStr + cm.text.substring(0, 40));
      });
    }
  });

  return lines.join('\n');
}

// ========== 角色主动发朋友圈 ==========
function triggerAiMoment(contact) {
  if (!contact) return;
  var apiCfg = contact.apiId ? apiConfigs.find(function(a) { return a.id === contact.apiId; }) : null;
  if (!apiCfg) return;

  // 获取用户的面具信息
  var userMask = getMaskForContact(contact);
  var userName = userMask.nickname || myProfile.name || '朋友';

  var prompt = '你正在扮演"' + contact.name + '"发朋友圈。\n\n';
  
  // 角色人设
  prompt += '【你的人设】\n';
  if (contact.persona) prompt += contact.persona + '\n';
  if (contact.gender) {
    var gm = { male: '男性', female: '女性', other: '其他' };
    prompt += '你的性别：' + (gm[contact.gender] || '') + '\n';
  }
  prompt += '\n';

  // 时间信息
  var now = new Date();
  var weekDays = ['日', '一', '二', '三', '四', '五', '六'];
  prompt += '【当前时间】\n';
  prompt += now.getFullYear() + '年' + (now.getMonth() + 1) + '月' + now.getDate() + '日 ';
  prompt += '星期' + weekDays[now.getDay()] + ' ';
  prompt += now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0') + '\n\n';

  // 聊天记录参考
  if (contact.messages && contact.messages.length > 0) {
    var recentMsgs = contact.messages.slice(-15);
    prompt += '【你和朋友' + userName + '最近的聊天记录（可以参考，发一些相关的或者日常的动态）】\n';
    recentMsgs.forEach(function(msg) {
      var sender = msg.role === 'user' ? userName : '你';
      prompt += sender + '：' + msg.text.substring(0, 60) + (msg.text.length > 60 ? '...' : '') + '\n';
    });
    prompt += '\n';
  }

  // 最近发过的朋友圈（避免重复）
  var myRecentMoments = moments.filter(function(m) {
    return m.authorType === 'contact' && m.authorId === contact.id && (Date.now() - m.ts) < 86400000;
  }).slice(0, 3);
  
  if (myRecentMoments.length > 0) {
    prompt += '【你今天已经发过的朋友圈（避免重复类似内容）】\n';
    myRecentMoments.forEach(function(m) {
      prompt += '- ' + m.text.substring(0, 40) + '\n';
    });
    prompt += '\n';
  }

  prompt += '【你的任务】\n';
  prompt += '请发一条朋友圈动态。\n';
  prompt += '- 内容要符合你的人设和当前时间\n';
  prompt += '- 可以是日常分享、心情、感想、或者和最近聊天相关的内容\n';
  prompt += '- 只写朋友圈内容，不要加任何前缀、标签\n';
  prompt += '- 简短自然，像真人发朋友圈一样，可以用emoji\n';

  if (apiCfg.format === 'openai') {
    var url = apiCfg.base.replace(/\/+$/, '');
    url = url.endsWith('/v1') ? url + '/chat/completions' : url + '/v1/chat/completions';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiCfg.key },
      body: JSON.stringify({ model: apiCfg.model, messages: [{ role: 'user', content: prompt }], max_tokens: 150 })
    }).then(function(r) { return r.json(); }).then(function(data) {
      var text = '';
      if (data.choices && data.choices[0]) text = data.choices[0].message.content.trim();
      if (text) {
        text = text.replace(/^["'"']|["'"']$/g, '').trim();
        publishAiMoment(contact, text);
      }
    }).catch(function() {});
  } else {
    var url2 = apiCfg.base.replace(/\/+$/, '') + '/v1beta/models/' + apiCfg.model + ':generateContent?key=' + apiCfg.key;
    fetch(url2, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    }).then(function(r) { return r.json(); }).then(function(data) {
      var text = '';
      if (data.candidates && data.candidates[0] && data.candidates[0].content)
        text = data.candidates[0].content.parts.map(function(p) { return p.text; }).join('').trim();
      if (text) {
        text = text.replace(/^["'"']|["'"']$/g, '').trim();
        publishAiMoment(contact, text);
      }
    }).catch(function() {});
  }
}


function publishAiMoment(contact, text) {
  moments.unshift({
    id: gid(),
    authorType: 'contact',
    authorId: contact.id,
    text: text,
    ts: Date.now(),
    visibleTo: [],
    likes: [],
    comments: [],
    aiReplied: false
  });
  saveMoments();
  renderMoments();
  // 触发朋友圈通知
  notifyMoments(contact, 'post', text);
}


// 定时让角色发朋友圈（每15分钟检查一次）
setInterval(function() {
  if (contacts.length === 0) return;
  // 随机选一个角色
  var eligible = contacts.filter(function(c) { return c.apiId; });
  if (eligible.length === 0) return;

  // 30%概率触发
  if (Math.random() > 0.3) return;

  var randomContact = eligible[Math.floor(Math.random() * eligible.length)];

  // 检查这个角色最近是否发过（1小时内不重复）
  var recentAiMoment = moments.find(function(m) {
    return m.authorType === 'contact' && m.authorId === randomContact.id && (Date.now() - m.ts) < 3600000;
  });
  if (recentAiMoment) return;

  triggerAiMoment(randomContact);
}, 900000); // 15分钟

// ========== 聊天功能面板 ==========
document.getElementById('btnChatFunc').addEventListener('click', function() {
  document.getElementById('chatFuncPanel').classList.add('active');
});

document.getElementById('btnCloseFuncPanel').addEventListener('click', function() {
  document.getElementById('chatFuncPanel').classList.remove('active');
});

// ========== 查看状态 ==========
document.getElementById('btnViewStatus').addEventListener('click', function() {
  document.getElementById('chatFuncPanel').classList.remove('active');
  generateStatus();
});

function generateStatus() {
  var c = getContact(currentChatId);
  if (!c) return;

  // 设置卡片头部
  document.getElementById('statusCardAvatar').innerHTML = c.avatar ? '<img src="' + c.avatar + '">' : esc((c.remark || c.name).charAt(0));
  document.getElementById('statusCardName').textContent = c.remark || c.name;
  document.getElementById('statusCardTime').textContent = fmtDate(Date.now()) + ' ' + fmtTime(Date.now());

  // 显示加载
  document.getElementById('statusCardContent').innerHTML = '<div class="status-card-loading"><div class="spinner"></div>正在感知状态...</div>';
  document.getElementById('statusCardFooter').style.display = 'none';
  document.getElementById('statusCardOverlay').classList.add('active');

  // 获取 API
  var apiCfg = null;
  if (c.apiId) apiCfg = apiConfigs.find(function(a) { return a.id === c.apiId; });

  if (!apiCfg) {
    document.getElementById('statusCardContent').innerHTML = '<div class="status-card-loading" style="color:#e06060;">请先配置 API</div>';
    document.getElementById('statusCardFooter').style.display = 'flex';
    return;
  }

  var prompt = '你正在扮演"' + c.name + '"。';
  if (c.persona) prompt += '\n你的人设：' + c.persona;
  if (c.gender) {
    var gm = { male: '男性', female: '女性', other: '其他' };
    prompt += '\n你的性别：' + (gm[c.gender] || '');
  }

  var now = new Date();
  var weekDays = ['日', '一', '二', '三', '四', '五', '六'];
  prompt += '\n当前时间：' + now.getFullYear() + '年' + (now.getMonth() + 1) + '月' + now.getDate() + '日 星期' + weekDays[now.getDay()] + ' ' + now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');

  prompt += '\n\n请根据你的人设和当前时间，生成你现在的状态信息。';
  prompt += '\n严格按照以下格式回复，每行一个，不要加其他内容：';
  prompt += '\n心情：（用一个词或短语描述）';
  prompt += '\n在做：（现在正在做什么）';
  prompt += '\n心声：（内心在想什么，一句话）';
  prompt += '\n想做：（接下来想做什么）';

  if (apiCfg.format === 'openai') {
    fetchStatusOpenAI(apiCfg, prompt, c);
  } else {
    fetchStatusGemini(apiCfg, prompt, c);
  }
}

function fetchStatusOpenAI(cfg, prompt, contact) {
  var url = cfg.base.replace(/\/+$/, '');
  url = url.endsWith('/v1') ? url + '/chat/completions' : url + '/v1/chat/completions';

  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.key },
    body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: prompt }], max_tokens: 200 })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = '';
    if (data.choices && data.choices[0] && data.choices[0].message) text = data.choices[0].message.content;
    else if (data.error) text = '出错了: ' + (data.error.message || '');
    displayStatus(text, contact);
  })
  .catch(function(err) { displayStatus('请求失败: ' + err.message, contact); });
}

function fetchStatusGemini(cfg, prompt, contact) {
  var url = cfg.base.replace(/\/+$/, '') + '/v1beta/models/' + cfg.model + ':generateContent?key=' + cfg.key;

  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = '';
    if (data.candidates && data.candidates[0] && data.candidates[0].content)
      text = data.candidates[0].content.parts.map(function(p) { return p.text; }).join('');
    else if (data.error) text = '出错了: ' + (data.error.message || '');
    displayStatus(text, contact);
  })
  .catch(function(err) { displayStatus('请求失败: ' + err.message, contact); });
}

function displayStatus(text, contact) {
  var parsed = parseStatus(text);

  var icons = {
    mood: { emoji: '😊', bg: '#fff5e6' },
    doing: { emoji: '📱', bg: '#e8f4f2' },
    thought: { emoji: '💭', bg: '#f0f0ff' },
    want: { emoji: '✨', bg: '#fef0f5' }
  };

  var labels = { mood: '心情', doing: '在做', thought: '心声', want: '想做' };

  var html = '<div class="status-card-body">';
  ['mood', 'doing', 'thought', 'want'].forEach(function(key) {
    var val = parsed[key] || '...';
    html += '<div class="status-item">';
    html += '<div class="status-item-icon" style="background:' + icons[key].bg + ';">' + icons[key].emoji + '</div>';
    html += '<div class="status-item-content">';
    html += '<div class="status-item-label">' + labels[key] + '</div>';
    html += '<div class="status-item-text">' + esc(val) + '</div>';
    html += '</div></div>';
  });
  html += '</div>';

  document.getElementById('statusCardContent').innerHTML = html;
  document.getElementById('statusCardFooter').style.display = 'flex';

  // 保存到历史
  if (!contact.statusHistory) contact.statusHistory = [];
  contact.statusHistory.push({
    ts: Date.now(),
    mood: parsed.mood,
    doing: parsed.doing,
    thought: parsed.thought,
    want: parsed.want
  });
  // 最多保存50条
  if (contact.statusHistory.length > 50) contact.statusHistory = contact.statusHistory.slice(-50);
  saveContacts();
}

function parseStatus(text) {
  var result = { mood: '', doing: '', thought: '', want: '' };
  var lines = text.split('\n');
  lines.forEach(function(line) {
    var t = line.trim();
    if (/^心情[：:]/.test(t)) result.mood = t.replace(/^心情[：:]\s*/, '');
    else if (/^在做[：:]/.test(t)) result.doing = t.replace(/^在做[：:]\s*/, '');
    else if (/^心声[：:]/.test(t)) result.thought = t.replace(/^心声[：:]\s*/, '');
    else if (/^想做[：:]/.test(t)) result.want = t.replace(/^想做[：:]\s*/, '');
  });
  return result;
}

// 刷新状态
document.getElementById('btnStatusRefresh').addEventListener('click', function() {
  generateStatus();
});

// 关闭状态卡片
document.getElementById('btnStatusClose').addEventListener('click', function() {
  document.getElementById('statusCardOverlay').classList.remove('active');
});

document.getElementById('statusCardOverlay').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('active');
});

// ========== 状态历史 ==========
document.getElementById('btnStatusHistory').addEventListener('click', function() {
  document.getElementById('chatFuncPanel').classList.remove('active');
  var c = getContact(currentChatId);
  if (!c) return;
  renderStatusHistory(c);
  document.getElementById('statusHistoryPage').classList.add('active');
});

document.getElementById('btnBackFromStatusHistory').addEventListener('click', function() {
  document.getElementById('statusHistoryPage').classList.remove('active');
});

function renderStatusHistory(c) {
  var body = document.getElementById('statusHistoryBody');
  if (!c.statusHistory || c.statusHistory.length === 0) {
    body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:200px;color:var(--text-hint);font-size:13px;">还没有状态记录</div>';
    return;
  }

  // 倒序显示，最新的在上面
  var list = c.statusHistory.slice().reverse();
  body.innerHTML = list.map(function(s) {
    return '<div class="history-status-card">' +
      '<div class="history-status-time">' + fmtDate(s.ts) + ' ' + fmtTime(s.ts) + '</div>' +
      '<div class="history-status-items">' +
      '<div class="history-status-row"><span class="h-icon">😊</span><span class="h-label">心情</span><span class="h-text">' + esc(s.mood || '...') + '</span></div>' +
      '<div class="history-status-row"><span class="h-icon">📱</span><span class="h-label">在做</span><span class="h-text">' + esc(s.doing || '...') + '</span></div>' +
      '<div class="history-status-row"><span class="h-icon">💭</span><span class="h-label">心声</span><span class="h-text">' + esc(s.thought || '...') + '</span></div>' +
      '<div class="history-status-row"><span class="h-icon">✨</span><span class="h-label">想做</span><span class="h-text">' + esc(s.want || '...') + '</span></div>' +
      '</div></div>';
  }).join('');
}

// ========== 气泡颜色 ==========
document.getElementById('myBubbleColor').addEventListener('input', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  c.bubbleMe = this.value;
  document.getElementById('myBubbleDot').style.background = this.value;
  saveContacts();
  applyBubbleColors(c);
});

document.getElementById('otherBubbleColor').addEventListener('input', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  c.bubbleOther = this.value;
  document.getElementById('otherBubbleDot').style.background = this.value;
  saveContacts();
  applyBubbleColors(c);
});

document.getElementById('btnResetMyBubble').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  c.bubbleMe = null;
  saveContacts();
  document.getElementById('myBubbleColor').value = '#7eb8b4';
  document.getElementById('myBubbleDot').style.background = '#7eb8b4';
  applyBubbleColors(c);
});

document.getElementById('btnResetOtherBubble').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  c.bubbleOther = null;
  saveContacts();
  document.getElementById('otherBubbleColor').value = '#ffffff';
  document.getElementById('otherBubbleDot').style.background = '#ffffff';
  applyBubbleColors(c);
});

function applyBubbleColors(c) {
  var msgArea = document.getElementById('chatMessages');
  if (c.bubbleMe) {
    msgArea.style.setProperty('--bubble-me', c.bubbleMe);
    // 自动判断文字颜色
    msgArea.style.setProperty('--bubble-me-text', isLightColor(c.bubbleMe) ? '#2c2c2c' : '#ffffff');} else {
    msgArea.style.removeProperty('--bubble-me');
    msgArea.style.removeProperty('--bubble-me-text');
  }
  if (c.bubbleOther) {
    msgArea.style.setProperty('--bubble-other', c.bubbleOther);
    msgArea.style.setProperty('--bubble-other-text', isLightColor(c.bubbleOther) ? '#2c2c2c' : '#ffffff');
  } else {
    msgArea.style.removeProperty('--bubble-other');
    msgArea.style.removeProperty('--bubble-other-text');
  }renderMessages(c);
  scrollToBottom();
}

function isLightColor(hex) {
  var r = parseInt(hex.substr(1, 2), 16);
  var g = parseInt(hex.substr(3, 2), 16);
  var b = parseInt(hex.substr(5, 2), 16);
  var brightness = (r * 299 + g * 587 + b * 114) / 1000;
  return brightness > 160;
}

// ========== 聊天设置 - 布局大小 ==========
document.getElementById('sizeSelector').addEventListener('click', function(e) {
  var option = e.target.closest('.size-option');
  if (!option) return;

  var c = getContact(currentChatId);
  if (!c) return;

  var size = option.getAttribute('data-size');
  c.chatSize = size;
  saveContacts();

  document.querySelectorAll('#sizeSelector .size-option').forEach(function(el) {
    el.classList.toggle('selected', el.getAttribute('data-size') === size);
  });

  applyChatSize(c);
});

function applyChatSize(c) {
  var msgArea = document.getElementById('chatMessages');
  msgArea.classList.remove('chat-size-small', 'chat-size-medium');
  var size = c.chatSize || 'default';
  if (size === 'small') {
    msgArea.classList.add('chat-size-small');
  } else if (size === 'medium') {
    msgArea.classList.add('chat-size-medium');
  }
}

// ========== 聊天设置 - 聊天背景 ==========
document.getElementById('btnChangeBg').addEventListener('click', function() {
  document.getElementById('bgInput').click();
});

document.getElementById('bgInput').addEventListener('change', function(e) {
  var f = e.target.files[0];
  if (!f) return;
  var c = getContact(currentChatId);
  if (!c) return;

  var r = new FileReader();
  r.onload = function(ev) {
    c.chatBg = ev.target.result;
    saveContacts();
    applyChatBg(c);
    updateBgPreview(c);
  };
  r.readAsDataURL(f);
  e.target.value = '';
});

document.getElementById('btnClearBg').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  c.chatBg = null;
  saveContacts();
  applyChatBg(c);
  updateBgPreview(c);
});

function applyChatBg(c) {
  var msgArea = document.getElementById('chatMessages');
  if (c.chatBg) {
    msgArea.style.backgroundImage = 'url(' + c.chatBg + ')';
    msgArea.style.backgroundSize = 'cover';
    msgArea.style.backgroundPosition = 'center';
    msgArea.style.backgroundRepeat = 'no-repeat';
  } else {
    msgArea.style.backgroundImage = '';
    msgArea.style.backgroundSize = '';
    msgArea.style.backgroundPosition = '';
    msgArea.style.backgroundRepeat = '';
  }
}

function updateBgPreview(c) {
  var preview = document.getElementById('bgPreviewCurrent');
  if (c.chatBg) {
    preview.innerHTML = '<img src="' + c.chatBg + '">';
  } else {
    preview.innerHTML = '<span class="no-bg">默认背景</span>';
  }
}

// ========== 聊天设置 - API 配置 ==========
document.getElementById('btnEditApi').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  renderChatApiList(c);
  document.getElementById('chatApiPage').classList.add('active');
});

document.getElementById('btnBackFromChatApi').addEventListener('click', function() {
  document.getElementById('chatApiPage').classList.remove('active');
});

function renderChatApiList(c) {
  // 显示当前配置
  var currentCfg = c.apiId ? apiConfigs.find(function(a) { return a.id === c.apiId; }) : null;
  document.getElementById('chatApiCurrentName').textContent = currentCfg ? currentCfg.name : '未配置';
  document.getElementById('chatApiCurrentDetail').textContent = currentCfg ? (currentCfg.format.toUpperCase() + ' · ' + currentCfg.model) : '请选择一个 API 配置';

  var list = document.getElementById('chatApiList');
  if (apiConfigs.length === 0) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-hint);font-size:13px;">还没有 API 配置，请先新建一个</div>';
    return;
  }

  list.innerHTML = apiConfigs.map(function(cfg) {
    var sel = cfg.id === c.apiId;
    return '<div class="api-saved-item' + (sel ? ' selected' : '') + '" data-id="' + cfg.id + '">' +
      '<div class="api-item-radio"></div>' +
      '<div class="api-item-info">' +
      '<div class="api-item-name">' + esc(cfg.name) + '</div>' +
      '<div class="api-item-detail">' + esc(cfg.format.toUpperCase() + ' · ' + cfg.model) + '</div>' +
      '</div></div>';
  }).join('');

  list.querySelectorAll('.api-saved-item').forEach(function(item) {
    item.addEventListener('click', function() {
      var id = item.getAttribute('data-id');
      c.apiId = id;
      saveContacts();
      renderChatApiList(c);
    });
  });
}

// 从聊天设置新建 API
document.getElementById('btnNewApiFromChat').addEventListener('click', function() {
  openApiEditor(null);
});

// ========== 聊天设置 - 删除联系人 ==========
document.getElementById('btnDeleteContact').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;

  if (!confirm('确定要删除「' + c.name + '」吗？\n所有聊天记录都会被删除，此操作不可恢复。')) return;

  contacts = contacts.filter(function(ct) { return ct.id !== currentChatId; });
  saveContacts();

  // 关闭所有页面回到主页
  document.getElementById('chatSettingsPage').classList.remove('active');
    document.getElementById('chatMessages').style.backgroundImage = '';
  document.getElementById('chatMessages').classList.remove('chat-size-small', 'chat-size-medium');
  var ma = document.getElementById('chatMessages');
  ma.style.removeProperty('--bubble-me');
  ma.style.removeProperty('--bubble-me-text');
  ma.style.removeProperty('--bubble-other');
  ma.style.removeProperty('--bubble-other-text');
  document.getElementById('chatFuncPanel').classList.remove('active');

  document.getElementById('pageChat').classList.remove('active');
  currentChatId = null;
  renderContactList();
});


// ========== 编辑角色弹窗事件 ==========
document.getElementById('btnCloseChatEdit').addEventListener('click', function() {
  document.getElementById('chatEditOverlay').classList.remove('active');
});
document.getElementById('chatEditOverlay').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('active');
});

document.getElementById('chatEditAvatarPreview').addEventListener('click', function() {
  document.getElementById('chatEditAvatarInput').click();
});
document.getElementById('chatEditAvatarInput').addEventListener('change', function(e) {
  var f = e.target.files[0]; if (!f) return;
  var r = new FileReader();
  r.onload = function(ev) { chatEditAvatarData = ev.target.result; document.getElementById('chatEditAvatarPreview').innerHTML = '<img src="' + chatEditAvatarData + '">'; };
  r.readAsDataURL(f); e.target.value = '';
});

document.getElementById('chatEditGenderSelector').addEventListener('click', function(e) {
  var o = e.target.closest('.gender-option'); if (!o) return;
  document.querySelectorAll('#chatEditGenderSelector .gender-option').forEach(function(el) { el.classList.remove('selected'); });
  o.classList.add('selected');
  chatEditGender = o.getAttribute('data-gender');
});

document.getElementById('btnSaveChatEdit').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  var newName = document.getElementById('chatEditName').value.trim();
  if (!newName) { alert('请输入昵称'); return; }
  c.name = newName;
  c.gender = chatEditGender;
  c.persona = document.getElementById('chatEditPersona').value.trim();
  if (chatEditAvatarData !== undefined) c.avatar = chatEditAvatarData;
  saveContacts();

  var avEl = document.getElementById('chatHeaderAvatar');
  avEl.innerHTML = c.avatar ? '<img src="' + c.avatar + '">' : esc(c.name.charAt(0));
  document.getElementById('chatHeaderName').textContent = c.name;

  // 同步更新设置页
  document.getElementById('settingsAvatar').innerHTML = c.avatar ? '<img src="' + c.avatar + '" style="width:100%;height:100%;object-fit:cover;">' : esc(c.name.charAt(0));
  document.getElementById('settingsName').textContent = c.remark || c.name;
  var gMap = { male: '男生', female: '女生', other: '其他' };
  document.getElementById('settingsGender').textContent = gMap[c.gender] || '未设置性别';

  renderMessages(c);
  document.getElementById('chatEditOverlay').classList.remove('active');
});

// ========== 渲染消息 ==========
var chatDisplayCount = {};

function getDisplayCount(id) {
  return chatDisplayCount[id] || 20;
}

function renderMessages(c) {
  var area = document.getElementById('chatMessages');
  if (!c.messages || c.messages.length === 0) {
    area.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:8px;color:var(--text-hint);"><svg width="40" height="40" viewBox="0 0 40 40" fill="none"><rect x="4" y="8" width="32" height="22" rx="6" stroke="#ddd" stroke-width="1.5"/><path d="M12 18h16M12 24h10" stroke="#ddd" stroke-width="1.5" stroke-linecap="round"/></svg><span style="font-size:12px;">发送第一条消息开始聊天吧</span></div>';
    return;
  }

  var total = c.messages.length;
  var displayCount = getDisplayCount(c.id);
  var startIdx = Math.max(0, total - displayCount);
  var visibleMessages = c.messages.slice(startIdx);
  var hiddenCount = startIdx;

  var html = '';

  // 如果有隐藏的消息，显示"加载更多"按钮
  if (hiddenCount > 0) {
    html += '<div class="load-more-btn"><button id="btnLoadMore">';
    html += '<svg width="14" height="14" viewBox="0 0 20 20" fill="none"><path d="M10 4v12M4 10h12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>';
    html += '查看更早的消息（还有 ' + hiddenCount + ' 条）';
    html += '</button></div>';
  }

  var lastDate = '';
  visibleMessages.forEach(function(msg) {
    var dateStr = fmtDate(msg.ts);
    if (dateStr !== lastDate) {
      html += '<div class="chat-date-divider"><span>' + dateStr + '</span></div>';
      lastDate = dateStr;
    }
    var isMe = msg.role === 'user';
    var userMask = getMaskForContact(c);
var myAv = userMask.avatar ? '<img src="' + userMask.avatar + '">' : esc(userMask.nickname ? userMask.nickname.charAt(0) : '我');
    var otherAv = c.avatar ? '<img src="' + c.avatar + '">' : esc(c.name.charAt(0));

    html += '<div class="msg-row ' + (isMe ? 'me' : 'other') + '">';
    html += '<div class="msg-avatar">' + (isMe ? myAv : otherAv) + '</div>';
    html += '<div class="msg-content">';
    if (!isMe) html += '<div class="msg-sender">' + esc(c.remark || c.name) + '</div>';
    html += '<div class="msg-bubble">' + esc(msg.text) + '</div>';
    html += '<div class="msg-time">' + fmtTime(msg.ts) + '</div>';
    html += '</div></div>';
  });

  area.innerHTML = html;

  // 绑定"加载更多"按钮事件
  var loadBtn = document.getElementById('btnLoadMore');
  if (loadBtn) {
    loadBtn.addEventListener('click', function() {
      var oldScrollHeight = area.scrollHeight;
      chatDisplayCount[c.id] = (chatDisplayCount[c.id] || 20) + 20;
      renderMessages(c);
      // 保持滚动位置，不跳到顶部
      var newScrollHeight = area.scrollHeight;
      area.scrollTop = newScrollHeight - oldScrollHeight;
    });
  }
  
// 更新重新回复按钮状态
updateRegenerateBtn(c);
}


function scrollToBottom() {
  var area = document.getElementById('chatMessages');
  area.scrollTop = area.scrollHeight;
}

function showTyping(c) {
  var area = document.getElementById('chatMessages');
  var avContent = c.avatar ? '<img src="' + c.avatar + '">' : esc(c.name.charAt(0));
  area.insertAdjacentHTML('beforeend',
    '<div class="msg-row other" id="typingRow"><div class="msg-avatar">' + avContent + '</div>' +
    '<div class="msg-content"><div class="msg-sender">' + esc(c.name) + '</div>' +
    '<div class="typing-indicator"><span></span><span></span><span></span></div></div></div>');
  scrollToBottom();
}

function hideTyping() { var el = document.getElementById('typingRow'); if (el) el.remove(); }

// ========== 输入框 ==========
var chatInput = document.getElementById('chatInput');
var sendBtn = document.getElementById('btnSend');

chatInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 100) + 'px';sendBtn.disabled = !this.value.trim();
});

chatInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if (this.value.trim()) sendMessage(); }
});

sendBtn.addEventListener('click', function() { if (chatInput.value.trim()) sendMessage(); });
// ========== 重新回复功能 ==========
document.getElementById('regenerateBtn').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c || !c.messages || c.messages.length === 0) return;
  
  // 找到最后一条AI回复并删除
  var lastIndex = -1;
  for (var i = c.messages.length - 1; i >= 0; i--) {
    if (c.messages[i].role === 'assistant') {
      lastIndex = i;
      break;
    }
  }
  
  if (lastIndex === -1) return;
  
  // 删除最后一条AI回复
  c.messages.splice(lastIndex, 1);
  saveContacts();
  renderMessages(c);
  
  // 找到最后一条用户消息来重新生成回复
  var lastUserMsg = null;
  for (var j = c.messages.length - 1; j >= 0; j--) {
    if (c.messages[j].role === 'user') {
      lastUserMsg = c.messages[j];
      break;
    }
  }
  
  if (!lastUserMsg) return;
  
  // 隐藏重新回复按钮
  document.getElementById('regenerateBtn').classList.remove('show');
  
  // 获取API配置
  var apiCfg = null;
  if (c.apiId) apiCfg = apiConfigs.find(function(a) { return a.id === c.apiId; });
  
  if (!apiCfg) {
    c.messages.push({ role: 'assistant', text: '还没有配置 API，无法重新生成回复。', ts: Date.now() });
    saveContacts();
    renderMessages(c);
    scrollToBottom();
    updateRegenerateBtn(c);
    return;
  }
  
  showTyping(c);
  
  // 构建系统提示（复用sendMessage的逻辑）
  var sysMsg = buildSystemMessage(c);
  
  if (apiCfg.format === 'openai') callOpenAI(apiCfg, c, sysMsg);
  else callGemini(apiCfg, c, sysMsg);
});
// ========== 接收消息功能 ==========

// 更新接收消息按钮显示状态
function updateReceiveMsgBtn(c) {
  var btn = document.getElementById('receiveMsgBtn');
  if (!c || !c.messages || c.messages.length === 0) {
    btn.classList.remove('show');
    return;
  }
  
  // 检查最后一条消息是否是用户发的（需要接收回复）
  var lastMsg = c.messages[c.messages.length - 1];
  if (lastMsg.role === 'user') {
    btn.classList.add('show');
    // 同时隐藏重新回复按钮
    document.getElementById('regenerateBtn').classList.remove('show');
  } else {
    btn.classList.remove('show');
  }
}

// 点击接收消息按钮
document.getElementById('receiveMsgBtn').addEventListener('click', function() {
  var c = getContact(currentChatId);
  if (!c) return;
  
  var btn = document.getElementById('receiveMsgBtn');
  
  // 防止重复点击
  if (btn.classList.contains('loading')) return;
  
  // 获取API配置
  var apiCfg = null;
  if (c.apiId) apiCfg = apiConfigs.find(function(a) { return a.id === c.apiId; });
  
  if (!apiCfg) {
    alert('还没有配置 API，请先在聊天设置中配置 API');
    return;
  }
  
  // 显示加载状态
  btn.classList.add('loading');
  btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px;"></div> 接收中...';
  
  // 隐藏按钮并显示打字指示器
  setTimeout(function() {
    btn.classList.remove('show');
    btn.classList.remove('loading');
    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 20 20" fill="none"><path d="M10 3v10M6 9l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 17h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> 接收消息';
    
    showTyping(c);
    
    // 构建系统提示并请求AI
    var sysMsg = buildSystemMessage(c);
    
    if (apiCfg.format === 'openai') callOpenAI(apiCfg, c, sysMsg);
    else callGemini(apiCfg, c, sysMsg);
  }, 300);
});

// 更新重新回复按钮显示状态
function updateRegenerateBtn(c) {
  var btn = document.getElementById('regenerateBtn');
  var receiveBtn = document.getElementById('receiveMsgBtn');
  
  if (!c || !c.messages || c.messages.length === 0) {
    btn.classList.remove('show');
    receiveBtn.classList.remove('show');
    return;
  }
  
  // 检查最后一条消息
  var lastMsg = c.messages[c.messages.length - 1];
  if (lastMsg.role === 'assistant') {
    // 最后是AI回复，显示重新回复按钮
    btn.classList.add('show');
    receiveBtn.classList.remove('show');
  } else {
    // 最后是用户消息，显示接收消息按钮
    btn.classList.remove('show');
    receiveBtn.classList.add('show');
  }
}


// 提取构建系统消息的函数
function buildSystemMessage(c) {
  var sysMsg = '你正在扮演一个真实的人在聊天软件上和对方聊天。\n';
  sysMsg += '【重要规则 - 必须严格遵守】\n';
  sysMsg += '- 你只能以你自己的身份回复，绝对不能模拟、代替、扮演对方说话，也绝对不要提及要和用户见面，或者等待和用户见面，要见面相关的所有话术绝对不许提，必须分成多条消息发送，不能只有一条消息\n';
  sysMsg += '- 绝对不要生成类似"Human:"、"用户:"、"对方:"这样的内容\n';
  sysMsg += '- 绝对不要替对方写任何回复\n';
  sysMsg += '- 你只能发送纯对话文本，像真人在聊天软件上发消息一样\n';
  sysMsg += '- 绝对不要写旁白、动作描写、括号内容、心理描写、场景描写\n';
  sysMsg += '- 不要用*号或括号描述任何动作或心理活动\n';
  sysMsg += '- 不要写任何角色标签或前缀\n';
sysMsg += '- 你可以一次回复多句话，每句话单独一行，像真人在聊天软件上连续发多条消息一样\n';
sysMsg += '- 每句话都要简短自然，像真人发消息那样\n';
sysMsg += '- 回复多少条完全由你根据当前对话情境自然决定：\n';
sysMsg += '  · 话多、激动、解释事情、分享故事时可以五条甚至更多\n';
sysMsg += '  · 总之怎么真实怎么来，不要刻意限制自己\n';
  sysMsg += '- 可以用emoji表情\n';
  sysMsg += '- 回复只包含你说的话，不要有任何其他格式\n\n';

  if (c.persona) sysMsg += '【你的人设】\n' + c.persona + '\n\n';
  if (c.name) sysMsg += '你的名字是：' + c.name + '\n';
  if (c.gender) {
    var gMap = { male: '男性', female: '女性', other: '其他' };
    sysMsg += '你的性别：' + (gMap[c.gender] || '') + '\n';
  }

  if (c.remark) {
    sysMsg += '\n【对方给你添加的昵称备注信息 - 你必须知道并记住这些】\n';
    sysMsg += c.remark + '\n';
    sysMsg += '你要把这个昵称备注当作你已知的信息，自然地融入对话中。\n';
  }

  if (c.timeAware) {
    var now = new Date();
    var weekDays = ['日', '一', '二', '三', '四', '五', '六'];
    var timeStr = now.getFullYear() + '年' + (now.getMonth() + 1) + '月' + now.getDate() + '日 星期' + weekDays[now.getDay()] + ' ' + now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
    sysMsg += '\n【当前真实时间】\n' + timeStr + '\n';
    sysMsg += '（你可以根据时间自然地回应，比如早上说早安，晚上说晚安等）\n';
  }

  if (c.momentsMemory) {
    var momentsContext = getMomentsMemory(c.id);
    if (momentsContext) {
      sysMsg += '\n【你和对方最近的朋友圈互动记录 - 你知道这些并且可以自然地在对话中提起】\n';
      sysMsg += momentsContext + '\n';
    }
  }
// 论坛记忆
var forumMemory = getForumMemory(c.id);
if (forumMemory) {
  sysMsg += '\n' + forumMemory + '\n';
  sysMsg += '如果对方提到论坛相关的话题，你可以自然地回应。\n';
}

  // 用户信息（使用绑定的面具）
  var userMask = getMaskForContact(c);
  if (userMask.nickname || userMask.persona) {
    sysMsg += '\n【对方（和你聊天的人）的信息】\n';
    if (userMask.nickname) sysMsg += '对方的名字：' + userMask.nickname + '\n';
    if (userMask.gender) {
      var gMap2 = { male: '男性', female: '女性', other: '其他' };
      sysMsg += '对方的性别：' + (gMap2[userMask.gender] || '') + '\n';
    }
    if (userMask.persona) sysMsg += '对方的信息：' + userMask.persona + '\n';
  }
  
  return sysMsg;
}

// ========== 发送消息 ==========
function sendMessage() {
  var text = chatInput.value.trim();
  if (!text || !currentChatId) return;
  var c = getContact(currentChatId);
  if (!c) return;

  c.messages.push({ role: 'user', text: text, ts: Date.now() });
  saveContacts();
  renderMessages(c);
  scrollToBottom();

  chatInput.value = '';
  chatInput.style.height = 'auto';
  sendBtn.disabled = true;

  var apiCfg = null;
  if (c.apiId) apiCfg = apiConfigs.find(function(a) { return a.id === c.apiId; });

if (!apiCfg) {
  // 即使没有API配置，也允许发送消息，点击接收时再提示
  updateReceiveMsgBtn(c);
  scrollToBottom();
  return;
}


  // 不再自动请求AI回复，而是显示"接收消息"按钮
updateReceiveMsgBtn(c);
scrollToBottom();

}


// ========== 模拟逐条回复 ==========
function simulateReply(contact, fullText) {
  hideTyping();

  // 按换行分割
  var lines = fullText.split('\n').filter(function(line) {
    var trimmed = line.trim();
    if (!trimmed) return false;
    // 过滤掉AI模拟用户说话的行
    if (/^(Human|User|用户|对方|我说|human|user)\s*[:：]/i.test(trimmed)) return false;
    // 过滤掉AI给自己加的角色标签前缀（去掉前缀保留内容在下面处理）
    if (/^(Assistant|AI|助手|Bot|bot|机器人)\s*[:：]/i.test(trimmed)) return false;
    // 过滤掉用户名前缀的行
    if (myProfile.name && new RegExp('^' + escRegex(myProfile.name) + '\\s*[:：]').test(trimmed)) return false;
    return true;
  }).map(function(line) {
    var trimmed = line.trim();
    // 如果角色名作为前缀出现，去掉前缀只保留内容
    if (contact.name) {
      var reg = new RegExp('^' + escRegex(contact.name) + '\\s*[:：]\\s*');
      if (reg.test(trimmed)) {
        trimmed = trimmed.replace(reg, '');
      }
    }
    return trimmed;
  }).filter(function(line) { return line.trim(); });

  if (lines.length === 0) lines = [fullText.trim() || '...'];

  // 如果只有一条直接显示
if (lines.length === 1) {
  contact.messages.push({ role: 'assistant', text: lines[0], ts: Date.now() });
  saveContacts(); renderMessages(contact); scrollToBottom();
  updateRegenerateBtn(contact);
  // 触发消息通知
  notifyNewMessage(contact, lines[0]);
  return;
}


  // 多条逐条显示
  var i = 0;
  function sendNext() {
    if (i >= lines.length) return;
    showTyping(contact);
    var delay = 400 + Math.random() * 800 + lines[i].length * 30;
    delay = Math.min(delay, 2500);
    setTimeout(function() {
      hideTyping();
      contact.messages.push({ role: 'assistant', text: lines[i], ts: Date.now() });
      saveContacts(); renderMessages(contact); scrollToBottom();
i++;
if (i < lines.length) {
  sendNext();
} else {
  updateRegenerateBtn(contact);
  // 触发消息通知（只通知最后一条）
  notifyNewMessage(contact, lines[lines.length - 1]);
}


    }, delay);
  }
  sendNext();
}


// ========== 调用 OpenAI ==========
function callOpenAI(cfg, contact, sysMsg) {
  var url = cfg.base.replace(/\/+$/, '');
  url = url.endsWith('/v1') ? url + '/chat/completions' : url + '/v1/chat/completions';

  var msgs = [];
  if (sysMsg) msgs.push({ role: 'system', content: sysMsg });
  var msgList = contact.messages;
  if (contact.memoryRounds && contact.memoryRounds > 0) {
    msgList = msgList.slice(-contact.memoryRounds);
  }
  msgList.forEach(function(m) {
    msgs.push({ role: m.role === 'user' ? 'user' : 'assistant', content: m.text });
  });


  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.key },
    body: JSON.stringify({ model: cfg.model, messages: msgs })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var reply = '...';
    if (data.choices && data.choices[0] && data.choices[0].message) reply = data.choices[0].message.content;
    else if (data.error) reply = '出错了: ' + (data.error.message || JSON.stringify(data.error));
    simulateReply(contact, reply);
  })
  .catch(function(err) {
    hideTyping();
    contact.messages.push({ role: 'assistant', text: '请求失败: ' + err.message, ts: Date.now() });
    saveContacts(); renderMessages(contact); scrollToBottom();
  });
}

// ========== 调用 Gemini ==========
function callGemini(cfg, contact, sysMsg) {
  var url = cfg.base.replace(/\/+$/, '') + '/v1beta/models/' + cfg.model + ':generateContent?key=' + cfg.key;
  var contents = [];
  if (sysMsg) {
    contents.push({ role: 'user', parts: [{ text: '系统设定：' + sysMsg + '\n请按照以上设定来对话。' }] });
    contents.push({ role: 'model', parts: [{ text: '好的，我明白了。' }] });
  }
  var msgList = contact.messages;
  if (contact.memoryRounds && contact.memoryRounds > 0) {
    msgList = msgList.slice(-contact.memoryRounds);
  }
  msgList.forEach(function(m) {
    contents.push({ role: m.role === 'user' ? 'user' : 'model', parts: [{ text: m.text }] });
  });


  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ contents: contents })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var reply = '...';
    if (data.candidates && data.candidates[0] && data.candidates[0].content)
      reply = data.candidates[0].content.parts.map(function(p) { return p.text; }).join('');
    else if (data.error) reply = '出错了: ' + (data.error.message || JSON.stringify(data.error));
    simulateReply(contact, reply);
  })
  .catch(function(err) {
    hideTyping();
    contact.messages.push({ role: 'assistant', text: '请求失败: ' + err.message, ts: Date.now() });
    saveContacts(); renderMessages(contact); scrollToBottom();
  });
}
</script>
</body>
</html>

